<!doctype html>
<html lang="en" class="no-js">
   <head>
      <meta charset="utf-8">
      <!-- begin SEO -->
      <title>Program Design - Syynth Hero</title>
      <meta property="og:locale" content="en-US">
      <meta property="og:site_name" content="Syynth Hero">
      <meta property="og:title" content="Program Design">
      <link rel="canonical" href="https://spd75.github.io/program-design/">
      <meta property="og:url" content="https://spd75.github.io/program-design/">
      <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "Person", "name" : "Sergio Diaz", "url" : "https://spd75.github.io", "sameAs" : null } </script> <!-- end SEO -->
      <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Syynth Hero Feed">
      <!-- http://t.co/dKP3o1e -->
      <meta name="HandheldFriendly" content="True">
      <meta name="MobileOptimized" content="320">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers -->
      <link rel="stylesheet" href="./assets/css/main.css">
      <meta http-equiv="cleartype" content="on">
      <!-- start custom head snippets -->
      <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png?v=M44lzPylqQ">
      <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png?v=M44lzPylqQ">
      <link rel="icon" type="image/png" href="/images/favicon-32x32.png?v=M44lzPylqQ" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/android-chrome-192x192.png?v=M44lzPylqQ" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicon-96x96.png?v=M44lzPylqQ" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicon-16x16.png?v=M44lzPylqQ" sizes="16x16">
      <link rel="manifest" href="/images/manifest.json?v=M44lzPylqQ">
      <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=M44lzPylqQ" color="#000000">
      <link rel="shortcut icon" href="/images/favicon.ico?v=M44lzPylqQ">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/mstile-144x144.png?v=M44lzPylqQ">
      <meta name="msapplication-config" content="/images/browserconfig.xml?v=M44lzPylqQ">
      <meta name="theme-color" content="#ffffff">
      <link rel="stylesheet" href="./assets/css/academicons.css"/>
      <script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [ ['$','$'], ["\\(","\\)"] ], processEscapes: true } }); </script> <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script> <!-- end custom head snippets -->
   </head>
   <body>
      <!--[if lt IE 9]>
      <div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
      <![endif]-->
      <div class="masthead">
         <div class="masthead__inner-wrap">
            <div class="masthead__menu">
               <nav id="site-nav" class="greedy-nav">
                  <button>
                     <div class="navicon"></div>
                  </button>
                  <ul class="visible-links">
                    <li class="masthead__menu-item masthead__menu-item--lg"><a href="./index.html">Syynth Hero</a></li>
                    <li class="masthead__menu-item"><a href="./index.html">Intro</a></li>
                    <li class="masthead__menu-item"><a href="./hldesign.html">High Level Design</a></li>
                    <li class="masthead__menu-item"><a href="./pdesign.html">Program Design</a></li>
                    <li class="masthead__menu-item"><a href="./hdesign.html">Hardware Design</a></li>
                    <li class="masthead__menu-item"><a href="./results.html">Results of Design</a></li>
                    <li class="masthead__menu-item"><a href="./conclusion.html">Conclusion</a></li>
                    <li class="masthead__menu-item"><a href="./appendix.html">Appendix</a></li>
                  </ul>
                  <ul class="hidden-links hidden"></ul>
               </nav>
            </div>
         </div>
      </div>
      <div id="main" role="main">
         <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
            <meta itemprop="headline" content="Program Design">
            <div class="page__inner-wrap">
               <header>
                  <h1 class="page__title" itemprop="headline">Program Design</h1>
               </header>
               <section class="page__content" itemprop="text">
                  <h3 id="the-main-threadsinterrupts">The Main Threads/Interrupts</h3>
                  <p>The program has three main operations that it runs: the main game loop (core 0), the button interrupts (core 0), and the audio synthesis interrupts (core 1). The game loop is a thread and is self-explanatory - we will explain this in more detail in a bit. However, the motivation behind the button interrupts and audio synthesis interrupts may not be as intuitive.</p>
                  <h3 id="the-button-interrupts">The Button Interrupts</h3>
                  <p>We introduced the button interrupts because we experienced a particularly unique problem when working with our arcade-style buttons. The problem was that it usually double counted button clicks no matter how long a button was held down for. This meant we couldn’t just check the GPIO pin for each button because its GPIO output wasn’t indicative of its actual state. So, we created a timer interrupt that runs once every 900 microseconds, maintains some state variables (stored in global arrays) for each button, and polls each of the buttons to determine whether it is on or off.</p>
                  <p>Each button has a “repeats” counter and a “signals” signal. The repeats counter counts for how many interrupts the button is detected to be in the OFF state. If the repeat counter is less than 10, then it isn’t ready to be clicked again. However, if it reaches 10, it can be clicked.</p>
                  <p>Once a button is clicked, its repeat counter will be be set to 0 and its signal will be set to 1. This signal variable is essential because since button clicks are being recorded asynchronously, the rest of the program needs to know when a button has recently been clicked. So, when the signal for a button is set to 1, this means that a button was recently clicked, and once the main thread reads this, it resets the button’s signal to 0.</p>
                  <p><br /></p>
                  <p align="center"> <img src="./images/a_images/program/butinter.png" alt="image" style="width:70%" /></p>
                  <p align="center"> Pseudo-code for what is performed in the button interrupts</p>
                  <p><br /></p>
                  <h3 id="the-audio-synthesis-interrupts">The Audio Synthesis Interrupts</h3>
                  <p>We added the audio synthesis timer interrupt for two reasons. First, we didn’t want it to affect game performance. For this reason, we added it to core 1. Second, we wanted the frequency to sound very smooth and have no interruption.</p>
                  <p>The tricky part in the design was getting the audio to play. Just like in the crickets lab, we used direct digital synthesis. However, we wanted to trigger these sounds to play when a specific action occurred (when a button was pressed) - we didn’t want the sound to play continuously on loop. Because audio synthesis occurs on core 1, this requires communication between core 0 and core 1 through the PT_FIFO_READ and WRITE operations. So, when core 0’s main thread detects a button signal, it writes the frequency corresponding to this button into the FIFO. Core 1’s main thread constantly reads from the FIFO, so it is able to detect that core 0 wants it to play a specific frequency. At this point, the thread adds data to a global array that instructs the audio synthesis interrupt to begin playing a synth sound at the specified frequency. The interrupt loops over this array to check what frequencies it needs to play. If it has any number of frequencies, it will play them all until they have been held for their total duration. If it doesn’t have any frequencies, it will simply remain silent and begin to play once core 0 provides it with some. This is how we were able to synthesize audio (even multiple notes at once) without impacting our performance.</p>
                  <p><br /></p>
                  <p align="center"> <img src="./images/a_images/program/soundinter.png" alt="image" style="width:85%" /></p>
                  <p align="center"> Pseudo-code for what is performed in the sound interrupts</p>
                  <p><br /></p>
                  <h3 id="the-game-loop-thread">The Game Loop Thread</h3>
                  <p>The game loop thread was the most complex part of the project as it handled a lot! The body of it manages the screen state - essentially, what screen is currently displayed. There are 6 main screens it switches between:</p>
                  <ul>
                     <li>Home Screen/Menu Screen</li>
                     <li>Gameplay Screen</li>
                     <li>Paused Screen</li>
                     <li>Game-Over Screen</li>
                     <li>Song Selection Screen</li>
                     <li>Difficulty Selection Screen</li>
                  </ul>
                  <p>So, we track the screen state using 2 global variables called curScreenState and oldScreenState. The reason we use 2 is so that when curScreenState changes and no longer equals oldScreenState, we can indicate a screen state change and reset the screen drawing accordingly. A FSM of the screen state is shown below.</p>
                  <p><br /></p>
                  <p align="center"> <img src="./images/a_images/program/fsm.png" alt="image" style="width:94%" /></p>
                  <p align="center"> FSM for screen state</p>
                  <p><br /></p>
                  <p>Screens such as the Song Selection Screen and the Difficulty Selection Screen weren’t too difficult to implement as they mainly just changed certain global variables (such as the data that controlled the song and difficulty for the next game). The most difficult screen to implement was the Gameplay screen.</p>
                  <h3 id="the-actual-gameplay">The Actual Gameplay</h3>
                  <p>The main element of the gameplay is the NoteBar struct. A NoteBar is the “object” that indicates when a player has to press a button to score points. The implementation of NoteBars in our code is shown below.</p>
                  <p><br /></p>
                  <p align="center"> <img src="./images/a_images/program/notebar.png" alt="image" style="width:94%" /></p>
                  <p align="center"> Code implementation of NoteBar struct</p>
                  <p><br /></p>
                  <p>While many of the variables within the NoteBar are well-explained by the comments, the next and prev pointers may be less clear. We added these to allow NoteBars to act like a linked list so that in each iteration of the game loop, the game loop can loop through all of the NoteBars on the screen, update their position, and redraw them. This also allows the game to remove NoteBars with ease. The reason a linked list works with our implementation is because each NoteBar moves down the screen at a constant speed predetermined by the game’s difficulty, so a NoteBar that is further up the screen should never disappear before a NoteBar below it.</p>
                  <p>As mentioned, the implementation of the NoteBar is essential because it allows us to easily loop through all of the NoteBars and redraw them to produce a functional game. Aside from this, our gameplay contains functions to check if any buttons have been clicked and to send a message to core 1 to play the appropriate sound. It also contains a yield to keep the frame rate constant. If the frame rate wasn’t constant, then rendering less NoteBars would result in much faster game play and more NoteBars would result in much slower gameplay, which would make the song sound super inconsistent.</p>
                  <p>The last essential part to explain how the program for our game works is to explain how we encoded the data for songs.</p>
                  <h3 id="encoding-songs">Encoding Songs</h3>
                  <p>We needed 4 main pieces of data to encode a song:</p>
                  <ol>
                     <li>What column a NoteBar would appear in</li>
                     <li>What time a NoteBar would appear in such column</li>
                     <li>What frequency would be played when a specific button was hit</li>
                     <li>When the appropriate time to play such frequency would be</li>
                  </ol>
                  <p>The reason we needed 3 and 4 was because we were only able to put 5 columns in the game, but most songs include more than 5 notes. So, if we wanted to play more complex songs, we’d need to include more frequencies.</p>
                  <p>To explain how we encode these songs, we will use an example from our code:</p>
                  <p><br /></p>
                  <p align="center"> <img src="./images/a_images/program/encoding.png" alt="image" style="width:94%" /></p>
                  <p align="center"> First part of the encoding for Twinkle Twinkle Little Star</p>
                  <p><br /></p>
                  <p>Song2_NoteColumns - this contains the column from which each NoteBar will spawn. The 0th NoteBar will spawn in the 0th column, the 1st in the 0th column, the 2nd in the 3rd column, the 3rd in the 3rd column, etc. The end of a song is marked by a 9 in the array.</p>
                  <p>Song2_NoteDeltas - this contains the number of beats that elapses between each NoteBar before the next is spawned. The 0th element is always 0, so really the n + 1 element in this array marks the amount of beats that must occur after the n NoteBar is spawned and before the n + 1 NoteBar is spawned. For example, after we spawn the 0th NoteBar in the 0th column, the program will wait for 2 beats before it releases the second NoteBar in the 0th column.</p>
                  <p>Song2_NoteFreqs - this is the only 2D array, and it indicates which frequencies will be played at certain periods in the song. Each sub-array has 5 elements and corresponds to each of the 5 buttons as expected. So, in the 0th period, the 4th button (starting at 0) will play an A, but in the 1st period, the 4th button will play a G.</p>
                  <p>Song2_NoteFreqChanges - this indicates how many notes make up a period. For example, the 0th period will be 7 notes long, the 1st period will be 21 notes long, the 2nd period will be 7 notes long, and the 3rd period will last until the end of the song.</p>
                  <p>With all of these elements put together, we were able to construct a well-functioning, cohesive game that is very entertaining to play!</p>
                  <h3 id="code-originating-from-other-sources">Code Originating from Other Sources</h3>
                  <p>We didn’t take much from other sources except for for direct-digital synthesis and code for displaying to VGA. We used code from lab 1 for direct-digital synthesis. However, we didn’t replicate this code exactly but instead followed a very similar structure and used it to understand implementation. We also used the vga_graphics library from lab 2 to be able to more easily create drawings on the VGA screen.</p>
                  <h3 id="things-we-tried-that-didnt-work">Things We Tried That Didn’t Work</h3>
                  <p>We experienced a lot of trouble with how we structured our code. Throughout many points in the project, we tried using structs. We tried to use them to represent the game state and to represent the synthesis for sound. In both cases, the structs would be arguments passed into functions that would manipulate its variables through its pointer. However, this didn’t work either time and caused the game to crash, so we abandoned this and instead used global variables as the primary way to manage state in the game. We spent almost two weeks on this issue.</p>
                  <p>Another issue we faced was that our original goal was to be able to play drum songs without hardcoding the music. However, after visualizing FFTs of multiple songs, we realized this would be near impossible, so we decided to pivot to Syynth Hero instead.</p>
               </section>
               <footer class="page__meta"></footer>
            </div>
         </article>
      </div>
      <div class="page__footer">
         <footer>
            <!-- start custom footer snippets --> <a href="/sitemap/">Sitemap</a> <!-- end custom footer snippets -->
            <div class="page__footer-follow">
               <ul class="social-icons">
                  <li><strong>Follow:</strong></li>
                  <li><a href="/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
               </ul>
            </div>
            <div class="page__footer-copyright">&copy; 2022 Sergio Diaz. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
         </footer>
      </div>
      <script src="/assets/js/main.min.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script>
   </body>
</html>