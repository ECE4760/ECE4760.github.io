<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Jambot</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="#page-top">Jambot Home</a>
                <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#about">Introduction</a></li>
                        <li class="nav-item"><a class="nav-link" href="#projects">High Level Design</a></li>
                        <li class="nav-item"><a class="nav-link" href="#design">Software and Hardware Design</a></li>
                        <li class="nav-item"><a class="nav-link" href="#results">Results</a></li>
                        <li class="nav-item"><a class="nav-link" href="#conclusion">Conclusion</a></li>
                        <li class="nav-item"><a class="nav-link" href="#demo">Demo!</a></li>
                        <li class="nav-item"><a class="nav-link" href="#appendices">Appendices</a></li>



                        <!-- <li class="nav-item"><a class="nav-link" href="#signup">Contact</a></li> -->
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Masthead-->
        <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-uppercase">Jambot</h1>
                        <h2 class="text-white-50 mx-auto mt-2 mb-5">A Jammer's Best Friend: it can listen to any song and solo over it while the song is playing.</h2>
                        <!-- <a class="btn btn-primary" href="#about">Get Started</a> -->

                        
                    </div>
                </div>
            </div>
        </header>

        <section class="about-section text-center" id="names">
            <!-- <div class="container px-4 px-lg-5"> -->
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h4 class="text-white mb-4">Kaitlyn Beiler (keb282), Wanda Field (cwf54), and Nia Reid-Vicars (nr346) </h4>
                        <h4 class="text-white mb-4">ECE 4760 F22 Final Project </h4>
                    </div>
                </div>
            <!-- </div> -->
        </section>
        <!-- About-->
        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Introduction</h2>

                        <p class="text-white-50">
                            For our final project, we created Jambot. Born out of a love for jamming with friends and improvising over backing tracks, 
                            the Jambot listens to music played by the user to detect the key of the played track and then improvises with the user's song 
                            in that key. The Jambot system relies and runs on a Raspberry Pi Pico, a Software Development Kit for the RP2040 microcontroller. 
                            In addition to this key piece of hardware, other main components are Digital to Analog Converter (DAC) connected to speakers for 
                            sound synthesis, and an Analog to Digital Converter (ADC) connected to a microphone to analyze the user's song. On the software side, 
                            the output song is synthesized using an algorithm called FM synthesis. We were able to find an FM synthesis implementation already
                            created by Bruce Land and utilized it. We played around with the parameters of the algorithm to output a tone similar to a piano, 
                            but more robotic sounding. We built off of this program by adding more notes and keys as well as a few random number generators to 
                            compute the next output note. The input song is analyzed using a Fast Fourier Transform(FFT) program also created by Bruce Land. We altered the program to be 
                            much more precise, which we found necessary for accurate key detection. On top of that, we implemented a key detection algorithm after 
                            frequencies from the input song were identified with the FFT. Ultimately, Jambot works and is a fun system to play around with. It still can 
                            sound a bit robotic or random, and it would be interesting to continue working on the project to see how human-like it could become. 
                        </p>
                    </div>
                </div>
                <img class="img-fluid" src="assets/img/pico1.png" alt="..." /> 
            </div>
        </section>
        <!-- Projects-->
        <section class="projects-section bg-light" id="projects">
            <div class="container px-4 px-lg-5">
                <!-- Featured Project Row-->
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                    <div class="col-xl-8 col-lg-7"><img class="img-fluid mb-3 mb-lg-0" src="assets/img/full_system.PNG" alt="..." /></div>
                        <div class="featured-text text-center text-lg-left">
                            <h4>Rationale</h4>
                            <p class="text-black-50 mb-0">One of us enjoys playing saxophone with her friends. Oftentimes the friends play chords on guitar 
                                and/or keyboard and sing the lyrics of a chosen song, while the saxophone player plays phrases of random notes that are in the
                                 key of the song. Something that she found interesting is that she often had no idea what she was about to play, but as long 
                                 as she knew the key and could feel the general mood and tempo of the song, it usually sounded pretty good. That brought up questions 
                                 about what is necessary for improvising over a song - could a program be just as good as our mediocre saxophone player if it followed 
                                 those same guidelines? This idea is what the Jambot explores. 

                            <h4>User Interface</h4>
                            <p class="text-black-50 mb-0">When the system starts, the user will be asked to input a tempo 
                                (speed of the song in beats per minute), and choose a setting for inputting weights. These weights affect 
                                the probability of which note will be played next. Each note in the scale has an array of 8 weights, each associated 
                                with the probability of the next possible notes. There are three weights settings: equal weights, jazzy weights, and custom weights.
                                When the serial inputs are collected, the Jambot begins detecting the key of the input 
                                song. The user can see the progress along the way such as which frequencies have been detected. When 15 
                                frequencies are detected, the Jambot begins cycling through key signatures. The user can see which keys the Jambot is checking, 
                                and which one it lands on. If after checking through three keys, none of the keys matched,  
                                then it starts the frequency detection process over again. As soon as a key is detected, the Jambot begins outputting a song. 
                                Based on the tempo, we have tried to output lengths of notes to match the mood of the song (i.e. slower songs are more likely 
                                to have whole notes or half notes while faster songs are more likely to have sixteenth notes.) The Jambot will continue 
                                outputting tones until the user resets the system.</p>
                                <img class="img-fluid" src="assets/img/serial_monitor.PNG" alt="..." /> 
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Project One Row
                <div class="row gx-0 mb-5 mb-lg-0 justify-content-center">
                    <div class="col-lg-6"><img class="img-fluid" src="assets/img/serial monitor.PNG" alt="..." /></div> 
                    <div class="col-lg-6">
                        <div class="bg-black text-center h-100 project">
                            <div class="d-flex h-100">
                                <div class="project-text w-100 my-auto text-center text-lg-left">
                                    <h4 class="text-white">User Interface</h4>
                                    <p class="mb-0 text-white-50">When the system starts, the user will be asked to input a tempo 
                                        (speed of the song in beats per minute), and choose a setting for inputting weights. These weights affect 
                                        the probability of which note will be played next. Each note in the scale has an array of 8 weights, each associated 
                                        with the probability of the next possible notice. There are three weights settings: equal weights, jazzy weights, and custom weights.
                                        When the Serial Inputs are collected, the Jambot begins detecting the key of the input 
                                        song. The user can see the progress along the way such as which frequencies have been detected. When enough 
                                        frequencies are detected, the Jambot begins cycling through key signatures. The user can see which keys the Jambot is checking, 
                                        and which one it lands on. If after checking through three keys, none of the keys matched,  
                                        then it starts the frequency detection process over again. As soon as a key is detected, the Jambot begins outputting a song. 
                                        Based on the tempo, we have tried to output lengths of notes to match the mood of the song (i.e. slower songs are more likely 
                                        to have whole notes or half notes while faster songs are more likely to have sixteenth notes.) The Jambot will continue 
                                        outputting tones until the user resets the system.</p>
                                    <hr class="d-none d-lg-block mb-0 ms-0" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                <!-- Project Two Row-->
                <div class="row gx-0 justify-content-center">
                    <div class="col-lg-6"><img class="img-fluid" src="assets/img/overview_statemachine.jpg" alt="..." /></div>
                    <div class="col-lg-6 order-lg-first">
                        <div class="bg-black text-center h-100 project">
                            <div class="d-flex h-100">
                                <div class="project-text w-100 my-auto text-center text-lg-right">
                                    <h4 class="text-white">Logical Structure</h4>
                                    <p class="mb-0 text-white-50">There are four distinct phases of this program. These phases will be discussed in detail in the Software Design Section.</p>
                                    <hr class="d-none d-lg-block mb-0 me-0" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Featured Project Row-->
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                    <!-- <div class="col-xl-8 col-lg-7"><img class="img-fluid mb-3 mb-lg-0" src="assets/img/full system.PNG" alt="..." /></div> -->
                        <div class="featured-text text-center text-lg-left">
                            <h4>Hardware/Software Tradeoff</h4>
                            <p class="text-black-50 mb-0">In terms of tradeoffs between hardware and software, we could improve upon the microphone part of the circuit. 
                                We use a fairly simple and cheap microphone from Adafruit. We noticed that in an empty room, the key detection worked with a much higher 
                                accuracy than it did in a room with other people who were talking or making other sounds. To account for the sometimes noisy conditions,
                                we implemented a slow and accurate FFT function to detect frequencies and (hopefully) discard noise. If we had a more sophisticated and 
                                noise-canceling microphone system, we could have written a faster FFT function. Beyond this notable tradeoff, we cannot think of an
                                any possible improvements or sacrifices made to the system.
                            <h4>Similar ideas</h4>
                            <p class="text-black-50 mb-0">We did not base this idea off of anything that is already on the market, and after coming up with the idea,
                                we could not find any device that does exactly what Jambot does. That being said, there is definitely an AI music software out there such as 
                                <a href="https://soundraw.io/">SoundRaw</a>, which allows you to design your own song based on input  mood, genre, and the length of the song; and 
                                <a href="https://www.aiva.ai/">AIVA</a>, which allows you to create theme music to match the background of whatever you are implementing.
                                To the best of our knowledge, we are not intentionally breaking any patent laws.
                                
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                    <!-- <div class="col-xl-8 col-lg-7"><img class="img-fluid mb-3 mb-lg-0" src="assets/img/full system.PNG" alt="..." /></div> -->
                        <div class="featured-text text-center text-lg-left">
                            <h4>Background Math/Agorithms</h4>
                        <!-- </div> -->

                            <h5>FM Synthesis</h5>
                            <p class="text-black-50 mb-0">As mentioned, Bruce Land's FM synthesis code was referenced in order to generate our system's instrumental 
                                like sounds. In general, FM synthesis can be utilized to produce many instrumental sounds like strings or drums; 
                                Land uses the following equation: 
                            </p>
                            <img class="img-fluid" src="assets/img/FMS_eqn1.jpg" alt="..." />  
                            <p class="text-black-50 mb-0">	with exponential functions within each of the envelopes.<sup>1</sup>
                            </p>
                            <img class="img-fluid" src="assets/img/FMS_eqn2.jpg" alt="..." /> 
                            <p class="text-black-50 mb-0">	Land then utilizes the first order differential equation Euler approximation, 
                                where at each time step the exponential functions are calculated. Some rearranging and simplifying, as K*dt < 1, 
                                results in the following: 
                            </p>
                            <img class="img-fluid" src="assets/img/FMS_eqn3.jpg" alt="..." /> 
                            <p class="text-black-50 mb-10">Bruce Land also uses the following variables in his program: F_main, F_fm, attack_main, attack_fm, DK_main, 
                                DK_fm, depth_fm, sustain time. Modifying combinations of these variables can impact the resulting sound.<sup>1</sup>
                            </p>
                            <h5>Fast Fourier Transform(FFT)</h5>
                            <p class="text-black-50 mb-0">The purpose of a fast fourier transform is to transfer a signal from one domain to some 
                                representation in the frequency domain. Bruce Land's FFT program was used. First, the FFT is initialized by creating 
                                a 2048 sized sinwave and window table. Then by using imaginary and real inputs, takes a forward fast fourier transform to 
                                decompose the input data and get the frequency bin amplitudes. A log2 approximation is then taken. Below is the basic
                                Forward Fast Fourier Transform Equation.<sup>2</sup>

                            </p>
                            <img class="img-fluid" src="assets/img/FFT_eqn.jpg" alt="..." /> 
                            <h5>Random Number Generator(RNG)</h5>
                            <p class="text-black-50 mb-0">To have a true random generator we used Deemo Chen's random generator implementation. 
                                According to Chen, a ring oscillator - an odd series of NOT gates that creates an unstable system - results in unpredictability 
                                that matches a true random generator; additionally, since the RP2040 has a register where this output can be accessed, Chen's generator 
                                can input a number, n, and output a number between 0 and 2<sup>n</sup>.<sup>3</sup> Below is his RNG implementation.
                            </p>
                            <img class="img-fluid" src="assets/img/RNG_snip.jpg" alt="..." /> 
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Design-->
        <section class="about-section text-center" id="design">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Software and Hardware Designs</h2>
                        <h4 class="text-white mb-4">Software Design</h4>
                        <p class="text-white-50 mb-2">
                            We approached the project in two parts: first generate sounds that sound musical, then implement key detection. 
                        </p>
                        <p class="text-white-50 mb-2">
                            To generate sound, we used an FM synthesis program created by Professor Land.<sup>(1)</sup> FM synthesis is similar to Direct 
                            Digital Synthesis which we used in the Cricket Chirp Synthesis lab, but it produces more musical tones. Professor Land's 
                            program output and cycled through the seven notes in a C scale. 
                        </p>
                        <p class="text-white-50 mb-2">
                            We built upon this program to fit our needs by adding two random number generators: one to select which frequency to 
                            play next (note_SM()) and another to select the time-length of that note (rand_note_length()). As stated in the background math/algorithms section, we used a 
                            random number generator created by Deemo Chen who is also in this class.<sup>3</sup>
                            Here is a code snippet from the FM Synthesis thread showing how the outputs from these RNGS decide the next note that will be played:
                        </p>
                        <img class="img-fluid" src="assets/img/note_SM_called.jpg" alt="..." /> 
                        <p class="text-white-50 mb-2">
                            To play around with different keys, tempos, and weights, we added a serial input interface for 
                            these values. Professor Land's original code outputs the C scale at a tempo of about 80 beats per minute (BPM), and we were
                            able to multiply the lengths of the FM Synthesis time parameters by a factor of the inputted tempo. There are 12 different 
                            major keys, and the only way to be able to "pick" between them is with a long if-else statement. Based on the input key signature, 
                            the if statement associated with that key would assign each of the elements in the frequency array with the appropriate frequencies 
                            in that key. Here is a snippet of two of those 12 cases. 
                        </p>
                        <img class="img-fluid" src="assets/img/set_key_ifstatement.jpg" alt="..." /> 
                        <p class="text-white-50 mb-2">
                            At this point, the Jambot was outputting random songs with specified tempos, keys, and weights. We were ready to move on to key detection.
                        </p>
                        <p class="text-white-50 mb-2">
                            We thought about the Cricket Chirp Synthesis Lab, and how FFT was used to detect other cricket chirps at specific frequencies. 
                            We tried to use the working FFT code from the first lab and add it to our now working Jambot code, but it proved to be challenging. 
                            Professor Land's FM synthesis program already had FFT capabilities, but it calculated the FFT of the output frequency 
                            instead of any signals from a microphone. Professor Land's code did not use a microphone at all. Furthermore, the FFT 
                            algorithm already in the FM synthesis program used fix12 and fix14 data types, while we had been using fix15 all semester. 
                            We would run into dozens of data type and variable name errors several times and end up scrapping our progress and returning 
                            to where we had started before trying to combine code. 
                        </p>
                        <p class="text-white-50 mb-2">
                            We spent about a week trying to figure out how to combine the code or alter the FFT functions that were already 
                            in the FM synthesis program, without much luck. Finally, we realized that Professor Land had another program 
                            which did use a microphone and computed FFT on the microphone data to detect frequencies, using the same data 
                            types that we had in our FM synthesis program.<sup>1</sup> It even came with a VGA display that displayed the current heard 
                            frequency and its spectrum diagram. At this point, we had a lot of practice with trying to combine new FFT functions 
                            to replace the original ones in our FM synthesis program, so we were able to successfully integrate the programs almost immediately. 
                        </p>
                        <p class="text-white-50 mb-2">
                            Now frequency detection worked, and we needed to come up with a way to use that data to determine a pattern, 
                            or a key signature. To approach this task, we thought about how people with perfect pitch might determine 
                            keys of songs. 
                        </p>
                        <p class="text-white-50 mb-2">
                            We understand limited music theory, but we know that there is a pattern that in simpler songs, root notes, or 
                            the "name" of the key, are frequently played throughout the song. In Cornell's Alma Mater, the root note is the start note 
                            of 3 of the 4 phrases, and the last note of 2 of the 4 phrases.<sup>4</sup> Other common notes in simple songs are thirds, fifths, and 
                            sevenths. We used this "common note" observation to implement our key detection function. 
                        </p>
                        <p class="text-white-50 mb-2">
                            In the FFT function, we detect the highest peak bin. When the maximum magnitude frequency is the same 
                            frequency two times in a row, we add that frequency to an array. We wait for duplicate detections to limit 
                            noise being detected. When 15 elements have been stored in this array, we move to the Key Detection Function. 
                            This function will compare the collected frequencies to the frequencies in several guessed key signatures. First, 
                            each of the frequencies in the detected array are normalized to within a range of a specific octave for comparison purposes. 
                            We utilized the fact that all octave jumps are related by a factor of two i.e. C4 is twice the amount of Hertz as C3. Also, 
                            any frequencies lower than 60 Hz or higher than 4200 Hz are discarded. For reference, middle C is about 261 Hz. 
                        </p>
                        <p class="text-white-50 mb-2">
                            With this normalized array, we find the mode. Then, we guess that the mode is the root note of the 
                            key and compare all of the elements in the array to that key. If it is not a match, we move onto the fifth. 
                            If that is not a match, then we try the seventh. For example, if C is the mode then we first try the key of C, 
                            then the key of F, then the key of Db. When a match is detected, the program immediately enters the song output that 
                            we implemented before. If a match is not detected from any of these three tries, then the program goes back to the FFT 
                            function and starts the detected notes array filling process over again.
                        </p>
                        <p class="text-white-50 mb-2">
                            While testing this comparison method, we realized that frequencies from the FFT function to be as 
                            accurate as possible. Initially, the code used 512 bins, and there were a few frequencies which were in 
                            between two different notes. To make the frequency divisions more precise, we increased the number of bins to 2048. 
                            This slowed down the process quite a bit, which was visually observed by how much the VGA display was suddenly lagging. 
                            However, to the user, the process does not take very long so this justified the longer computation time. 
                        </p>
                        <img class="img-fluid" src="assets/img/key_detection_SM.jpg" alt="..." /> 

                        <h4 class="text-white mb-4">Hardware Design</h4>
                        <p class="text-white-50 mb-2">
                            Since the physical needs of this project were identical to those of the Cricket Chirp Synthesis lab 
                            (Lab 1), we used the same circuit design.<sup>5</sup> It is a simple circuit and could easily and cheaply be rebuilt.                        
                        </p>
                        <img class="img-fluid" src="assets/img/full_circuit_diagram.jpg" alt="..." /> 

                    </div>
                </div>
            </div>
        </section>

        <!--Results-->
        <section class="projects-section bg-light" id="results">
            <div class="container px-4 px-lg-5">
                <!-- Featured Project Row-->
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                        <div class="featured-text text-center text-lg-left">
                            <h4>Results</h4>
                            <p class="text-black-50 mb-10">Over the course of four weeks, with discussion with staff, 
                                we were able to adjust and achieve our goals. Our conceptual system was composed of many components that
                                we had to implement. With the FM synthesis and FFT programs already implemented, we created a method for key detection. 
                                We also implemented random generators for which note of the heard key would be played and for what duration. To create 
                                different rhythms and create better matching ones, probability weights for note and duration were created and allowed to be 
                                inputted by the user. In addition, this latter feature would take into account the beats per measure. Additionally, an input 
                                for tempo was created, and was used as an indicator for whether longer or shorter notes would be favored at faster or higher 
                                tempoed songs, respectively. 
                            </p>
                            <p class="text-black-50 mb-10">With each implementation, the system was tested through a variety of ways.  For example, since 
                                we wanted our Jambot to sound like a musical instrument, parameters of the FM synthesis program were modified and tested 
                                through audio output. A problem that surfaced was that the notes sounded choppy and did not seem to be "played" the entire 
                                duration, with pauses between notes. Removing a yield function within the protothread_fm fixed this problem, as there was a 
                                noticeable auditory difference. When initially working with Bruce Land's code and troubleshooting, we heavily relied on the 
                                serial interface as well as the VGA frequency spectrum display. Features such as the probability inputs, random generator 
                                output, and additional notes played for a certain duration to a list were tested with print statements and the serial interface 
                                as well. Each note held for a certain duration (that also was added to a list) were printed to the serial interface. The detected 
                                key or failure of key detection were added as messages to the serial interface as well.
                            </p>
                            <p class="text-black-50 mb-10">While there was testing for features of the program as it was built, there was also separate testing 
                                for the completed system as a whole. To test the system, we played a variety of songs of known key, tempo (beats per measure), 
                                and genre. When first testing the system we noticed two things: one, our system didn't always rhythmically match the song, 
                                and two, our system took a much longer time to detect the key of faster tempo songs. We were able to notice this by listening 
                                to audio output, as well as watching what frequencies were held for a certain time and added to the list. Initially, for a note 
                                to be considered held for a duration of time, three beats of the same frequency had to be detected; this was changed to two beats 
                                to reduce the time needed for a key to be detected for faster songs. Even though we were able to achieve all of the aforementioned 
                                features, we wanted the JamBot to sound rhythmic or harmonious as it played along with a chosen song. To do this, we designed a few 
                                versions of the probability weights. By "version," each key had weights that were changed to sound differently. For example, by 
                                referencing sheet music, jazz-like weights were created. The other versions were an "equal" weights implementation, where 
                                probabilities were the same across all keys, and a version that could be inputted by the user. To correct for faster tempo songs, 
                                a correlation program between tempo and note duration was created. 
                            </p>
                            <p class="text-black-50 mb-10">
                                With these modifications, there was a noticeable effect on the system. For example, although there was still a slight pause 
                                between FM synthesis notes, it was not very noticeable and the JamBot output sounded like an actual instrument. The change from 
                                detecting three beats of the same frequency to two beats also sped up the time it took for a key 
                                to be detected. We found that most songs took from 10 seconds to 1 minute for the key to be detected; longer durations were noticed 
                                for songs with more accidentals or notes that are half steps above or below a note of the key. Detection of the frequencies held for
                                 a number of beats were detected and printed to the serial interface immediately. Once the list reached the required minimum number 
                                 of detected notes, the system took about less than a second to start playing notes of a certain key or, in case of key detection 
                                 failure, relistening for more notes. Accuracy of notes detected was ensured by using the VGA frequency display from Bruce Land's 
                                 code, and for notes played, frequencies were hardcoded from online sources. The tempo, note duration, and correlation between 
                                 these features was tested by using a metronome and manually adjusting the calculated tempo variable in the code.
                            </p>
                            <p class="text-black-50 mb-10">
                                The JamBot system relies mostly on software implementations. Any hardware additions were insulated or properly physically 
                                isolated from one another on the circuit. The circuit itself relied on voltage from lab computers to the Raspberry Pi pico. 
                                Filtering also occurred through software functions. Therefore, the system is safe to use by most users. For ease of use, the 
                                serial interface was a key component. One key feature was a menu of default probability weights that a user could choose from- 
                                "jazzy weights," "equal weights," or "create new weights." Other messages were prompted to the user to input values such as for 
                                tempo. By having a series of messages and values that could be entered with the lab computer keyboard, adjustable parameters could 
                                easily be changed. For a song to be detected, the user would only need to choose a song on their phone and have the phone positioned 
                                near the microphone of the circuit. To reset the system and play a new song, the buttons of the USB extension of the lab computer 
                                would need to be powered off and back on. As such, the system does not have many components that the user has to change, and if 
                                the components did change, the user could easily adjust them.
                            </p>
                        </div>
                </div>
            </div>
        </section>

         <!-- Conclusion-->
         <section class="about-section text-center" id="conclusion">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Conclusion</h2>
                        <p class="text-white-50 mb-3">
                            When we first envisioned and suggested our project, our idea was to have the pico reproduce a jazz solo. 
                            Given a key and tempo through serial communication, using a microphone and FFT, the Pico would be able to 
                            determine which pitches are being played and which key those pitches have in common. We also planned to start 
                            the solo production with two random number generators: one that assigns the next note to play and another to 
                            determine how long to play that note. To make the solos sound less random, we could write a Machine Learning 
                            program (Markov model) with classic jazz solos on another computer. The Pico could then learn which "steps" 
                            (relationships between successive notes) sound better.
                        </p>
                        <p class="text-white-50 mb-3">
                            Though our final system wasn't necessarily the exact same as what we initially thought, we were still able to 
                            produce a successful system that met and exceeded our expectations. In the end, we created a system that took 
                            in a musical input, then using FFT, the system was able to detect the key the input was in and output a succession 
                            of random notes that had the same tempo as our input song. There were ideas from our original design that remained 
                            in our final design, we still input our tempo, we still had our Pico determine the key based on the pitches that
                            were heard, and we still had notes be randomly played in succession. There were also ideas that were changed and 
                            removed that either elevated or simplified our design. For example, instead of the notes in succession played being
                            fully random, each pitch within the key was given weights, where each weight determined the likelihood of the note
                            playing. Thus we were able to manipulate the weights ourselves to hear what sounded best with a song. This feature 
                            also replaced the need for the machine learning algorithm we initially proposed. Additionally, instead of the length 
                            of each note being at random, the note length was dependent on the song. Our system would replicate the note length 
                            of the song. If the song were playing a half note, the system would play a half note and that was consistent for all notes. 
                        </p>
                        <p class="text-white-50 mb-3">
                            In order to implement our system, the basis of our code was developed using code from Bruce Land's ECE4760 website. 
                            We drew our inspiration from Bruce's use of FM sound synthesis in order to reproduce the piano sound, as well as his 
                            building of the FFT in order to obtain data acquired by the Pico. Other than Bruce's code which is on a public domain, 
                            the rest was built by us. So it'll likely be able to be patented. 
                        </p>
                        <p class="text-white-50 mb-3">
                            There's a lot we could expand upon with this project. For example, we could try again to make sounds smoother with a 
                            Markov model using machine learning. An issue that we ran into during the lab was that for songs that had accidentals 
                            or a faster tempo, the system took longer to pick up the correct key. Perhaps implementing the machine learning program 
                            would further improve upon those issues in the future. Another place where we could improve is our system works great with instrumentals, 
                            but not the best with songs with lyrics. So we could also change our system by refining it to accommodate songs with lyrics. 
                            Given that the microphone is pretty sensitive, maybe we could change it to one that is less influenced by outside noise. 
                            Lastly, we decided that our system would output piano keys rather than guitar keys since piano was both more jazz-like, 
                            and was already implemented in Bruce's code. To further expand on that, we could have our system detect what instrument 
                            is playing and play back the song with the same instrument. 
                        </p>
                    </div>
                </div>
            </div>
        </section>
        <!-- Demo-->
        <section class="about-section text-center" id="demo">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-lg-8">
                    <h2 class="text-white mb-4">Final Demo</h2>
                    <iframe width="560" height="315" src="https://www.youtube.com/embed/kAoxX1GrPYs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </section>

           <!--Appendices-->
           <section class="projects-section bg-light" id="appendices">
            <div class="container px-4 px-lg-5">
                <!-- Featured Project Row-->
                <div class="row gx-0 mb-4 mb-lg-5 align-items-center">
                        <div class="featured-text text-center text-lg-left">
                            <h4>Appendices</h4>

                            <h5>Appendix A: Permissions</h5>
                            <p class="text-black-50 mb-10"> The group approves this report for inclusion on the course website. 
                            </p>
                            <p class="text-black-50 mb-10"> The group approves the video for inclusion on the course youtube channel. 
                            </p>
                            
                            <h5>Appendix B: References</h5>

                            <p class="text-black-50 mb-10"> 1.  Land, B. (2011, September 11). ECE4760 PIC32 sound. Electrical and Computer Engineering | Electrical and Computer Engineering; ECE 4760 -  Bruce Land. https://people.ece.cornell.edu/land/courses/ece4760/PIC32/index_sound_synth.html 
                            </p>
                            <p class="text-black-50 mb-10"> 2. Fourier Transform - Definition, Formula, Properties, Applications and Examples. (2022, June 22). BYJUS; BYJU'S. https://byjus.com/maths/fourier-transform/ 
                            </p>
                            <p class="text-black-50 mb-10"> 3. Chen, D. (2022, October 2). RP2040 Randomness and Ring Oscillator - DeemOcean. DeemOcean; Deemo Yizhou Chen Observatory. https://deemocean.com/2022/10/02/rp2040-randomness-and-ring-oscillator/ 

                            </p>
                            <p class="text-black-50 mb-10"> 4. Alma Mater - Sidney Cox Library of Music and Dance. (n.d.). Sidney Cox Library of Music and Dance. Retrieved December 13, 2022, from https://music.library.cornell.edu/alma-mater/ 

                            </p>
                            <p class="text-black-50 mb-10"> 5. Adams, H. (n.d.-b). Crickets. Index; ECE 4760 - Van Hunter Adams. Retrieved December 13, 2022, from https://vanhunteradams.com/Pico/Cricket/Crickets.html 

                            </p>

                            <h5>Appendix C: Specific Tasks</h5>
                            <p class="text-black-50 mb-10"> We all put in equal work in terms of debugging and thinking of how to implement the program. Wanda helped with the music theory side of things,
                                Kaitlyn wrote and turned in all of the weekly checkpoints, and Nia tested the hardware and the checkpoints along the way.
                            </p>

                        </div>
                </div>
            </div>
        </section>
        <section class="projects-section bg-light" id="appendices">
            <div class="featured-text text-center text-lg-left">
                <h5>Appendix D: Commented Code</h5>
            </div>
           <!-- HTML generated using hilite.me -->
           <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">   
                1
                2
                3
                4
                5
                6
                7
                8
                9
                10
                11
                12
                13
                14
                15
                16
                17
                18
                19
                20
                21
                22
                23
                24
                25
                26
                27
                28
                29
                30
                31
                32
                33
                34
                35
                36
                37
                38
                39
                40
                41
                42
                43
                44
                45
                46
                47
                48
                49
                50
                51
                52
                53
                54
                55
                56
                57
                58
                59
                60
                61
                62
                63
                64
                65
                66
                67
                68
                69
                70
                71
                72
                73
                74
                75
                76
                77
                78
                79
                80
                81
                82
                83
                84
                85
                86
                87
                88
                89
                90
                91
                92
                93
                94
                95
                96
                97
                98
                99
                100
                101
                102
                103
                104
                105
                106
                107
                108
                109
                110
                111
                112
                113
                114
                115
                116
                117
                118
                119
                120
                121
                122
                123
                124
                125
                126
                127
                128
                129
                130
                131
                132
                133
                134
                135
                136
                137
                138
                139
                140
                141
                142
                143
                144
                145
                146
                147
                148
                149
                150
                151
                152
                153
                154
                155
                156
                157
                158
                159
                160
                161
                162
                163
                164
                165
                166
                167
                168
                169
                170
                171
                172
                173
                174
                175
                176
                177
                178
                179
                180
                181
                182
                183
                184
                185
                186
                187
                188
                189
                190
                191
                192
                193
                194
                195
                196
                197
                198
                199
                200
                201
                202
                203
                204
                205
                206
                207
                208
                209
                210
                211
                212
                213
                214
                215
                216
                217
                218
                219
                220
                221
                222
                223
                224
                225
                226
                227
                228
                229
                230
                231
                232
                233
                234
                235
                236
                237
                238
                239
                240
                241
                242
                243
                244
                245
                246
                247
                248
                249
                250
                251
                252
                253
                254
                255
                256
                257
                258
                259
                260
                261
                262
                263
                264
                265
                266
                267
                268
                269
                270
                271
                272
                273
                274
                275
                276
                277
                278
                279
                280
                281
                282
                283
                284
                285
                286
                287
                288
                289
                290
                291
                292
                293
                294
                295
                296
                297
                298
                299
                300
                301
                302
                303
                304
                305
                306
                307
                308
                309
                310
                311
                312
                313
                314
                315
                316
                317
                318
                319
                320
                321
                322
                323
                324
                325
                326
                327
                328
                329
                330
                331
                332
                333
                334
                335
                336
                337
                338
                339
                340
                341
                342
                343
                344
                345
                346
                347
                348
                349
                350
                351
                352
                353
                354
                355
                356
                357
                358
                359
                360
                361
                362
                363
                364
                365
                366
                367
                368
                369
                370
                371
                372
                373
                374
                375
                376
                377
                378
                379
                380
                381
                382
                383
                384
                385
                386
                387
                388
                389
                390
                391
                392
                393
                394
                395
                396
                397
                398
                399
                400
                401
                402
                403
                404
                405
                406
                407
                408
                409
                410
                411
                412
                413
                414
                415
                416
                417
                418
                419
                420
                421
                422
                423
                424
                425
                426
                427
                428
                429
                430
                431
                432
                433
                434
                435
                436
                437
                438
                439
                440
                441
                442
                443
                444
                445
                446
                447
                448
                449
                450
                451
                452
                453
                454
                455
                456
                457
                458
                459
                460
                461
                462
                463
                464
                465
                466
                467
                468
                469
                470
                471
                472
                473
                474
                475
                476
                477
                478
                479
                480
                481
                482
                483
                484
                485
                486
                487
                488
                489
                490
                491
                492
                493
                494
                495
                496
                497
                498
                499
                500
                501
                502
                503
                504
                505
                506
                507
                508
                509
                510
                511
                512
                513
                514
                515
                516
                517
                518
                519
                520
                521
                522
                523
                524
                525
                526
                527
                528
                529
                530
                531
                532
                533
                534
                535
                536
                537
                538
                539
                540
                541
                542
                543
                544
                545
                546
                547
                548
                549
                550
                551
                552
                553
                554
                555
                556
                557
                558
                559
                560
                561
                562
                563
                564
                565
                566
                567
                568
                569
                570
                571
                572
                573
                574
                575
                576
                577
                578
                579
                580
                581
                582
                583
                584
                585
                586
                587
                588
                589
                590
                591
                592
                593
                594
                595
                596
                597
                598
                599
                600
                601
                602
                603
                604
                605
                606
                607
                608
                609
                610
                611
                612
                613
                614
                615
                616
                617
                618
                619
                620
                621
                622
                623
                624
                625
                626
                627
                628
                629
                630
                631
                632
                633
                634
                635
                636
                637
                638
                639
                640
                641
                642
                643
                644
                645
                646
                647
                648
                649
                650
                651
                652
                653
                654
                655
                656
                657
                658
                659
                660
                661
                662
                663
                664
                665
                666
                667
                668
                669
                670
                671
                672
                673
                674
                675
                676
                677
                678
                679
                680
                681
                682
                683
                684
                685
                686
                687
                688
                689
                690
                691
                692
                693
                694
                695
                696
                697
                698
                699
                700
                701
                702
                703
                704
                705
                706
                707
                708
                709
                710
                711
                712
                713
                714
                715
                716
                717
                718
                719
                720
                721
                722
                723
                724
                725
                726
                727
                728
                729
                730
                731
                732
                733
                734
                735
                736
                737
                738
                739
                740
                741
                742
                743
                744
                745
                746
                747
                748
                749
                750
                751
                752
                753
                754
                755
                756
                757
                758
                759
                760
                761
                762
                763
                764
                765
                766
                767
                768
                769
                770
                771
                772
                773
                774
                775
                776
                777
                778
                779
                780
                781
                782
                783
                784
                785
                786
                787
                788
                789
                790
                791
                792
                793
                794
                795
                796
                797
                798
                799
                800
                801
                802
                803
                804
                805
                806
                807
                808
                809
                810
                811
                812
                813
                814
                815
                816
                817
                818
                819
                820
                821
                822
                823
                824
                825
                826
                827
                828
                829
                830
                831
                832
                833
                834
                835
                836
                837
                838
                839
                840
                841
                842
                843
                844
                845
                846
                847
                848
                849
                850
                851
                852
                853
                854
                855
                856
                857
                858
                859
                860
                861
                862
                863
                864
                865
                866
                867
                868
                869
                870
                871
                872
                873
                874
                875
                876
                877
                878
                879
                880
                881
                882
                883
                884
                885
                886
                887
                888
                889
                890
                891
                892
                893
                894
                895
                896
                897
                898
                899
                900
                901
                902
                903
                904
                905
                906
                907
                908
                909
                910
                911
                912
                913
                914
                915
                916
                917
                918
                919
                920
                921
                922
                923
                924
                925
                926
                927
                928
                929
                930
                931
                932
                933
                934
                935
                936
                937
                938
                939
                940
                941
                942
                943
                944
                945
                946
                947
                948
                949
                950
                951
                952
                953
                954
                955
                956
                957
                958
                959
                960
                961
                962
                963
                964
                965
                966
                967
                968
                969
                970
                971
                972
                973
                974
                975
                976
                977
                978
                979
                980
                981
                982
                983
                984
                985
                986
                987
                988
                989
                990
                991
                992
                993
                994
                995
                996
                997
                998
                999
                1000
                1001
                1002
                1003
                1004
                1005
                1006
                1007
                1008
                1009
                1010
                1011
                1012
                1013
                1014
                1015
                1016
                1017
                1018
                1019
                1020
                1021
                1022
                1023
                1024
                1025
                1026
                1027
                1028
                1029
                1030
                1031
                1032
                1033
                1034
                1035
                1036
                1037
                1038
                1039
                1040
                1041
                1042
                1043
                1044
                1045
                1046
                1047
                1048
                1049
                1050
                1051
                1052
                1053
                1054
                1055
                1056
                1057
                1058
                1059
                1060
                1061
                1062
                1063
                1064
                1065
                1066
                1067
                1068
                1069
                1070
                1071
                1072
                1073
                1074
                1075
                1076
                1077
                1078
                1079
                1080
                1081
                1082
                1083
                1084
                1085
                1086
                1087
                1088
                1089
                1090
                1091
                1092
                1093
                1094
                1095
                1096
                1097
                1098
                1099
                1100
                1101
                1102
                1103
                1104
                1105
                1106
                1107
                1108
                1109
                1110
                1111
                1112
                1113
                1114
                1115
                1116
                1117
                1118
                1119
                1120
                1121
                1122
                1123
                1124
                1125
                1126
                1127
                1128
                1129
                1130
                1131
                1132
                1133
                1134
                1135
                1136
                1137
                1138
                1139
                1140
                1141
                1142
                1143
                1144
                1145
                1146
                1147
                1148
                1149
                1150
                1151
                1152
                1153
                1154
                1155
                1156
                1157
                1158
                1159
                1160
                1161
                1162
                1163
                1164
                1165
                1166
                1167
                1168
                1169
                1170
                1171
                1172
                1173
                1174
                1175
                1176
                1177
                1178
                1179
                1180
                1181
                1182
                1183
                1184
                1185
                1186
                1187
                1188
                1189
                1190
                1191
                1192
                1193
                1194
                1195
                1196
                1197
                1198
                1199
                1200
                1201
                1202
                1203
                1204
                1205
                1206
                1207
                1208
                1209
                1210
                1211
                1212
                1213
                1214
                1215
                1216
                1217
                1218
                1219
                1220
                1221
                1222
                1223
                1224
                1225
                1226
                1227
                1228
                1229
                1230
                1231
                1232
                1233
                1234
                1235
                1236
                1237
                1238
                1239
                1240
                1241
                1242
                1243
                1244
                1245
                1246
                1247
                1248
                1249
                1250
                1251
                1252
                1253
                1254
                1255
                1256
                1257
                1258
                1259
                1260
                1261
                1262
                1263
                1264
                1265
                1266
                1267
                1268
                1269
                1270
                1271
                1272
                1273
                1274
                1275
                1276
                1277
                1278
                1279
                1280
                1281
                1282
                1283
                1284
                1285
                1286
                1287
                1288
                1289
                1290
                1291
                1292
                1293
                1294
                1295
                1296
                1297
                1298
                1299
                1300
                1301
                1302
                1303
                1304
                1305
                1306
                1307
                1308
                1309
                1310
                1311
                1312
                1313
                1314
                1315
                1316
                1317
                1318
                1319
                1320
                1321
                1322
                1323
                1324
                1325
                1326
                1327
                1328
                1329
                1330
                1331
                1332
                1333
                1334
                1335
                1336
                1337
                1338
                1339
                1340
                1341
                1342
                1343
                1344
                1345
                1346
                1347
                1348
                1349
                1350
                1351
                1352
                1353
                1354
                1355
                1356
                1357
                1358
                1359
                1360
                1361
                1362
                1363
                1364
                1365
                1366
                1367
                1368
                1369
                1370
                1371
                1372
                1373
                1374
                1375
                1376
                1377
                1378
                1379
                1380
                1381
                1382
                1383
                1384
                1385
                1386
                1387
                1388
                1389
                1390
                1391
                1392
                1393
                1394
                1395
                1396
                1397
                1398
                1399
                1400
                1401
                1402
                1403
                1404
                1405
                1406
                1407
                1408
                1409
                1410
                1411
                1412
                1413
                1414
                1415
                1416
                1417
                1418
                1419
                1420
                1421
                1422
                1423
                1424
                1425
                1426
                1427
                1428
                1429
                1430
                1431
                1432
                1433
                1434
                1435
                1436
                1437
                1438
                1439
                1440
                1441
                1442
                1443
                1444
                1445
                1446
                1447
                1448
                1449
                1450
                1451
                1452
                1453
                1454
                1455
                1456
                1457
                1458
                1459
                1460
                1461
                1462
                1463
                1464
                1465
                1466
                1467
                1468
                1469
                1470
                1471
                1472
                1473
                1474
                1475
                1476
                1477
                1478
                1479
                1480
                1481
                1482
                1483
                1484
                1485
                1486
                1487
                1488
                1489
                1490
                1491
                1492
                1493
                1494
                1495
                1496
                1497
                1498
                1499
                1500
                1501
                1502
                1503
                1504
                1505
                1506
                1507
                1508
                1509
                1510
                1511
                1512
                1513
                1514
                1515
                1516
                1517
                1518
                1519
                1520
                1521
                1522
                1523
                1524
                1525
                1526
                1527
                1528
                1529
                1530
                1531
                1532
                1533
                1534
                1535
                1536
                1537
                1538
                1539
                1540
                1541
                1542
                1543
                1544
                1545
                1546
                1547
                1548
                1549
                1550
                1551
                1552
                1553
                1554
                1555
                1556
                1557
                1558
                1559
                1560
                1561
                1562
                1563
                1564
                1565
                1566
                1567
                1568
                1569
                1570
                1571
                1572
                1573
                1574
                1575
                1576
                1577
                1578
                1579
                1580
                1581
                1582
                1583
                1584
                1585
                1586
                1587
                1588
                1589
                1590
                1591
                1592
                1593
                1594
                1595
                1596
                1597
                1598
                1599
                1600
                1601
                1602
                1603
                1604
                1605
                1606
                1607
                1608
                1609
                1610
                1611
                1612
                1613
                1614
                1615
                1616
                1617
                1618
                1619
                1620
                1621
                1622
                1623
                1624
                1625
                1626
                1627
                1628
                1629
                1630
                1631
                1632
                1633
                1634
                1635
                1636
                1637
                1638
                1639
                1640
                1641
                1642
                1643
                1644
                1645
                1646
                1647
                1648
                1649
                1650
                1651
                1652
                1653
                1654
                1655
                1656
                1657
                1658
                1659
                1660
                1661
                1662
                1663
                1664
                1665
                1666
                1667
                1668
                1669
                1670
                1671
                1672
                1673
                1674
                1675
                1676
                1677
                1678
                1679
                1680
                1681
                1682
                1683
                1684
                1685
                1686
                1687
                1688
                1689
                1690
                1691
                1692
                1693
                1694
                1695
                1696
                1697
                1698
                1699
                1700
                1701
                1702
                1703
                1704
                1705
                1706
                1707
                1708
                1709
                1710
                1711
                1712
                1713
                1714
                1715
                1716
                1717
                1718
                1719
                1720
                1721
                1722
                1723
                1724
                1725
                1726
                1727
                1728
                1729
                1730
                1731
                1732
                1733
                1734
                1735
                1736
                1737
                1738
                1739
                1740
                1741
                1742
                1743
                1744
                1745
                1746
                1747
                1748
                1749
                1750
                1751
                1752
                1753
                1754
                1755
                1756
                1757
                1758
                1759
                1760
                1761
                1762
                1763
                1764
                1765
                1766
                1767
                1768
                1769
                1770
                1771
                1772
                1773
                1774
                1775
                1776
                1777
                1778
                1779
                1780
                1781
                1782
                1783
                1784
                1785
                1786
                1787
                1788
                1789
                1790
                1791
                1792
                1793
                1794
                1795
                1796
                1797
                1798
                1799
                1800
                1801
                1802
                1803
                1804
                1805
                1806
                1807
                1808
                1809
                1810
                1811
                1812
                1813
                1814
                1815
                1816
                1817
                1818
                1819
                1820
                1821
                1822
                1823
                1824
                1825
                1826
                1827
                1828
                1829
                1830
                1831
                1832
                1833
                1834
                1835
                1836
                1837
                1838
                1839
                1840
                1841
                1842
                1843
                1844
                1845
                1846
                1847
                1848
                1849
                1850
                1851
                1852
                1853
                1854
                1855
                1856
                1857
                1858
                1859
                1860
                1861
                1862
                1863
                1864
                1865
                1866
                1867
                1868
                1869
                1870
                1871
                1872
                1873
                1874
                1875
                1876
                1877
                1878
                1879
                1880
                1881
                1882
                1883
                1884
                1885
                1886
                1887
                1888
                1889
                1890
                1891
                1892
                1893
                1894
                1895
                1896
                1897
                1898
                1899
                1900
                1901
                1902
                1903
                1904
                1905
                1906
                1907
                1908
                1909
                1910
                1911
                1912
                1913
                1914
                1915
                1916
                1917
                1918
                1919
                1920
                1921
                1922
                1923
                1924
                1925
                1926
                1927
                1928
                1929
                1930
                1931
                1932
                1933
                1934
                1935
                1936
                1937
                1938
                1939
                1940
                1941
                1942
                1943
                1944
                1945
                1946
                1947
                1948
                1949
                1950
                1951
                1952
                1953
                1954
                1955
                1956
                1957
                1958
                1959
                1960
                1961
                1962
                1963
                1964
                1965
                1966
                1967
                1968
                1969
                1970
                1971
                1972
                1973
                1974
                1975
                1976
                1977
                1978
                1979
                1980
                1981
                1982
                1983
                1984
                1985
                1986
                1987
                1988
                1989
                1990
                1991
                1992
                1993
                1994
                1995
                1996
                1997
                1998
                1999
                2000
                2001
                2002
                2003
                2004
                2005
                2006
                2007
                2008
                2009
                2010
                2011
                2012
                2013
                2014
                2015
                2016
                2017
                2018
                2019
                2020
                2021
                2022
                2023
                2024
                2025
                2026
                2027
                2028
                2029
                2030
                2031
                2032
                2033
                2034
                2035
                2036
                2037
                2038
                2039
                2040
                2041
                2042
                2043
                2044
                2045
                2046
                2047
                2048
                2049
                2050
                2051
                2052
                2053
                2054
                2055
                2056
                2057
                2058
                2059
                2060
                2061
                2062
                2063
                2064
                2065
                2066
                2067
                2068
                2069
                2070
                2071
                2072
                2073
                2074
                2075
                2076
                2077
                2078
                2079
                2080
                2081
                2082
                2083
                2084
                2085
                2086
                2087
                2088
                2089
                2090
                2091
                2092
                2093
                2094
                2095
                2096
                2097
                2098
                2099
                2100
                2101
                2102
                2103
                2104
                2105
                2106
                2107
                2108
                2109
                2110
                2111
                2112
                2113
                2114
                2115
                2116
                2117
                2118
                2119
                2120
                2121
                2122
                2123
                2124
                2125
                2126
                2127
                2128
                2129
                2130
                2131
                2132
                2133
                2134
                2135
                2136
                2137
                2138
                2139
                2140
                2141
                2142
                2143
                2144
                2145
                2146
                2147
                2148
                2149
                2150
                2151
                2152
                2153
                2154
                2155
                2156
                2157
                2158
                2159
                2160
                2161
                2162
                2163
                2164
                2165
                2166
                2167
                2168
                2169
                2170
                2171
                2172
                2173
                2174
                2175
                2176
                2177
                2178
                2179
                2180
                2181
                2182
                2183
                2184
                2185
                2186
                2187
                2188
                2189
                2190
                2191
                2192
                2193
                2194
                2195
                2196
                2197
                2198
                2199
                2200
                2201
                2202
                2203
                2204
                2205
                2206
                2207
                2208
                2209
                2210
                2211
                2212
                2213
                2214
                2215
                2216
                2217
                2218
                2219
                2220
                2221
                2222
                2223
                2224
            </pre></td><td><pre style="margin: 0; line-height: 125%">
                <span style="color: #008000">/**</span>
                <span style="color: #008000"> * Credit to Hunter Adams (vha3@cornell.edu), Bruce Land (bruce.land@cornell.edu), and Deemo Chen</span>
                <span style="color: #008000"> * (https://deemocean.com/2022/10/02/rp2040-randomness-and-ring-oscillator/)</span>
                <span style="color: #008000"> * </span>
                <span style="color: #008000"> * HARDWARE CONNECTIONS</span>
                <span style="color: #008000"> *  - GPIO 16 ---&gt; VGA Hsync</span>
                <span style="color: #008000"> *  - GPIO 17 ---&gt; VGA Vsync</span>
                <span style="color: #008000"> *  - GPIO 18 ---&gt; 330 ohm resistor ---&gt; VGA Green lo-bit |__ both wired to 150 ohm to ground </span>
                <span style="color: #008000"> *  - GPIO 19 ---&gt; 220 ohm resistor ---&gt; VGA Green hi_bit |   and to VGA Green</span>
                <span style="color: #008000"> *  - GPIO 20 ---&gt; 330 ohm resistor ---&gt; VGA Blue</span>
                <span style="color: #008000"> *  - GPIO 21 ---&gt; 330 ohm resistor ---&gt; VGA Red</span>
                <span style="color: #008000"> *  - RP2040 GND ---&gt; VGA GND</span>
                <span style="color: #008000"> *</span>
                <span style="color: #008000"> * RESOURCES USED</span>
                <span style="color: #008000"> *  - PIO state machines 0, 1, and 2 on PIO instance 0</span>
                <span style="color: #008000"> *  - DMA channels 0, 1, 2, and 3</span>
                <span style="color: #008000"> *  - 153.6 kBytes of RAM (for pixel color data)</span>
                <span style="color: #008000"> *</span>
                <span style="color: #008000"> * Protothreads v1.1.1</span>
                <span style="color: #008000"> * Serial console on GPIO 0 and 1 for debugging</span>
                <span style="color: #008000"> * </span>
                <span style="color: #008000"> * </span>
                <span style="color: #008000"> * DAC :</span>
                <span style="color: #008000"> * GPIO 5 (pin 7) Chip select</span>
                <span style="color: #008000">   GPIO 6 (pin 9) SCK/spi0_sclk</span>
                <span style="color: #008000">   GPIO 7 (pin 10) MOSI/spi0_tx</span>
                <span style="color: #008000">   3.3v (pin 36) -&gt; VCC on DAC </span>
                <span style="color: #008000">   GND (pin 3)  -&gt; GND on DAC</span>
                <span style="color: #008000"> * </span>
                <span style="color: #008000"> */</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === VGA graphics library</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #0000ff">#include &quot;vga16_graphics.h&quot;</span>
                <span style="color: #0000ff">#include &lt;stdio.h&gt;</span>
                <span style="color: #0000ff">#include &lt;stdlib.h&gt;</span>
                <span style="color: #0000ff">#include &lt;math.h&gt;</span>
                <span style="color: #0000ff">#include &lt;string.h&gt;</span>
                <span style="color: #0000ff">#include &quot;pico/stdlib.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/pio.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/dma.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/adc.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/pwm.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/irq.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/spi.h&quot;</span>

                <span style="color: #008000">// // Our assembled programs:</span>
                <span style="color: #008000">// // Each gets the name &lt;pio_filename.pio.h&gt;</span>
                <span style="color: #008000">// #include &quot;hsync.pio.h&quot;</span>
                <span style="color: #008000">// #include &quot;vsync.pio.h&quot;</span>
                <span style="color: #008000">// #include &quot;rgb.pio.h&quot;</span>

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === hardware and protothreads globals</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #0000ff">#include &quot;hardware/sync.h&quot;</span>
                <span style="color: #0000ff">#include &quot;hardware/timer.h&quot;</span>
                <span style="color: #0000ff">#include &quot;pico/multicore.h&quot;</span>
                <span style="color: #0000ff">#include &quot;string.h&quot;</span>
                <span style="color: #0000ff">#include &lt;time.h&gt;</span>
                <span style="color: #008000">// protothreads header</span>
                <span style="color: #0000ff">#include &quot;pt_cornell_rp2040_v1_1_1.h&quot;</span>

                <span style="color: #008000">// globals for the graphincs</span>
                <span style="color: #2b91af">short</span> adc_x, adc_y;
                <span style="color: #2b91af">short</span> draw_x, draw_y, last_draw_x, last_draw_y, last_click_x, last_click_y, x_latch;
                <span style="color: #2b91af">short</span> click, double_click, button, last_button, click_latch;
                <span style="color: #2b91af">short</span> first_click = 1;
                <span style="color: #2b91af">int</span> click_time, last_click_time;
                <span style="color: #2b91af">int</span> clicked_item;
                <span style="color: #2b91af">float</span> serial_value;
                <span style="color: #2b91af">char</span> serial_value_input[32];

                <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">int</span> rando = 0;
                <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">float</span> rand_len = 0;

                <span style="color: #008000">//these aren&#39;t named very well lol</span>
                <span style="color: #2b91af">bool</span> sm_EN  = 0; <span style="color: #008000">//enable mic stuff</span>
                <span style="color: #2b91af">bool</span> kd_EN  = 0; <span style="color: #008000">//key detection done (also necessary for audo state machine)</span>
                <span style="color: #2b91af">bool</span> mic_EN = 1; <span style="color: #008000">//when key detection is done, stop detecting</span>


                <span style="color: #008000">// data semaphore to control fft on core 1</span>
                <span style="color: #0000ff">struct</span> pt_sem run_fft_s, finish_fft_s ;

                <span style="color: #008000">// protection for printing</span>
                <span style="color: #2b91af">spin_lock_t</span> * lock_stdout ;

                <span style="color: #008000">// unprotected global to halt display</span>
                <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> run_stop = 1 ;

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// Some globals for storing timer information</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> time_accum = 0;
                <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> time_accum_old = 0 ;
                <span style="color: #2b91af">char</span> timetext[40];

                <span style="color: #008000">//from Deemo Chen RNG</span>
                <span style="color: #0000ff">#define ROSC_RANDOMBIT_OFFSET _u(0x0000001c)</span>
                <span style="color: #0000ff">#define ROSC_BASE _u(0x40060000)</span>

                <span style="color: #008000">// Timer interrupt</span>
                <span style="color: #2b91af">bool</span> repeating_timer_callback(<span style="color: #0000ff">struct</span> repeating_timer *t) {

                    time_accum += 1 ;
                    <span style="color: #0000ff">return</span> true;
                }

                <span style="color: #008000">// ===========================================</span>
                <span style="color: #008000">// ADC setup + DMA channel for ADC</span>
                <span style="color: #008000">// ===========================================</span>
                <span style="color: #008000">// setup ADC</span>
                <span style="color: #0000ff">#define adc_array_length 2048</span>
                <span style="color: #008000">// raw from ADC</span>
                <span style="color: #2b91af">short</span> adc_data[adc_array_length] ;
                <span style="color: #008000">// formatted for scope trace</span>
                <span style="color: #2b91af">short</span> display_data[adc_array_length] ;
                <span style="color: #2b91af">short</span> fft_display_data[adc_array_length] ;
                <span style="color: #2b91af">short</span> log_display_data[adc_array_length] ;
                <span style="color: #008000">// copy of  data</span>
                <span style="color: #2b91af">short</span> analysis_data[adc_array_length] ;
                <span style="color: #008000">// copy of  data</span>
                <span style="color: #2b91af">short</span> fft_data[adc_array_length] ;

                <span style="color: #2b91af">int</span> ADC_setup(<span style="color: #2b91af">void</span>){
                adc_init();
                adc_gpio_init(26);
                <span style="color: #008000">// p26 is ADC input 0</span>
                adc_select_input(0);
                <span style="color: #008000">//  48 MHz clock / 12.8 KHz sample rate</span>
                <span style="color: #008000">//adc_set_clkdiv (3750);</span>
                <span style="color: #008000">// 16 KHz  32 mSec window</span>
                adc_set_clkdiv (3000);
                <span style="color: #008000">// free run</span>
                adc_run(1);
                <span style="color: #008000">// result is in adc_hw-&gt;result</span>
                <span style="color: #008000">// but we are going to forward that to the FIFO</span>
                <span style="color: #008000">//adc_fifo_setup(bool en, bool dreq_en, uint16_t dreq_thresh, bool err_in_fifo, bool byte_shift)</span>
                <span style="color: #008000">// fifo_enable, dreq_enable, thresh=1, no error, dont shift to 8-bits(for 8-bit PWM)</span>
                adc_fifo_setup(1,1,1,0,0);
                <span style="color: #008000">//</span>
                <span style="color: #008000">// the DMA channel</span>
                <span style="color: #2b91af">int</span> ADC_data_chan = 11 ; <span style="color: #008000">//</span>
                <span style="color: #008000">// Conflict with video gen code:</span>
                <span style="color: #008000">//int ADC_data_chan = dma_claim_unused_channel(true);</span>
                <span style="color: #008000">// The acdtual data channel</span>
                dma_channel_config c2 = dma_channel_get_default_config(ADC_data_chan);
                    channel_config_set_transfer_data_size(&amp;c2, DMA_SIZE_16);
                    channel_config_set_read_increment(&amp;c2, false);
                    channel_config_set_write_increment(&amp;c2, true);
                    channel_config_set_irq_quiet(&amp;c2, true);
                    channel_config_set_enable(&amp;c2, true); 
                    <span style="color: #008000">//channel_config_set_chain_to(&amp;c2, ctrl_chan) ;</span>
                    channel_config_set_dreq(&amp;c2, DREQ_ADC);
                    <span style="color: #008000">//</span>
                    dma_channel_configure(ADC_data_chan, &amp;c2, 
                        adc_data, <span style="color: #008000">// write_addr, to array</span>
                        &amp;adc_hw-&gt;fifo,  <span style="color: #008000">// read_addr, the table</span>
                        adc_array_length, <span style="color: #008000">// one ADC value,</span>
                        1) ; <span style="color: #008000">// trigger</span>
                <span style="color: #0000ff">return</span> ADC_data_chan ;
                }

                <span style="color: #008000">// ===========================================</span>
                <span style="color: #008000">// Cursor</span>
                <span style="color: #008000">// ===========================================</span>
                <span style="color: #2b91af">short</span> cursor_pixel_x[5], cursor_pixel_y[5];

                <span style="color: #008000">// Erase cursor</span>
                <span style="color: #008000">// replace cursor color with saved image colors</span>
                <span style="color: #2b91af">void</span> erase_cursor(<span style="color: #2b91af">short</span> x, <span style="color: #2b91af">short</span> y)
                {
                    <span style="color: #008000">// first the x direction, then y</span>
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; 5; i++)
                    {
                        drawPixel(x - 2 + i, y, cursor_pixel_x[i]);
                        drawPixel(x, y - 2 + i, cursor_pixel_y[i]);
                    }
                }

                <span style="color: #008000">// Draw cursor</span>
                <span style="color: #008000">// replace image with cursor color and save image pixels</span>
                <span style="color: #2b91af">void</span> draw_cursor(<span style="color: #2b91af">short</span> x, <span style="color: #2b91af">short</span> y)
                {
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; 5; i++)
                    {
                        cursor_pixel_x[i] = readPixel(x - 2 + i, y);
                        cursor_pixel_y[i] = readPixel(x, y - 2 + i);
                        drawPixel(x - 2 + i, y, WHITE);
                        drawPixel(x, y - 2 + i, WHITE);
                    }
                }

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === set up a menu scheme for use with VGA</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// There is one list of up to 16 items drawn down the left side of the screen</span>
                <span style="color: #008000">// ALL items store and update using float values</span>
                <span style="color: #008000">// int values are copied from the float</span>
                <span style="color: #0000ff">struct</span> menu_item
                {
                    <span style="color: #008000">// displayed string</span>
                    <span style="color: #2b91af">char</span> item_name[15];
                    <span style="color: #008000">// displayed color</span>
                    <span style="color: #2b91af">int</span> item_color;
                    <span style="color: #008000">//1=float 0=int ;</span>
                    <span style="color: #2b91af">int</span> item_data_type;
                    <span style="color: #008000">// 1=log 0=linear</span>
                    <span style="color: #2b91af">int</span> item_inc_type;
                    <span style="color: #008000">// increment delta if linear, ratio if log</span>
                    <span style="color: #2b91af">float</span> item_increment;
                    <span style="color: #008000">// the current value, min, max</span>
                    <span style="color: #008000">// al updates are performed on float, then copied to int</span>
                    <span style="color: #2b91af">int</span> item_int_value;
                    <span style="color: #2b91af">float</span> item_float_value;
                    <span style="color: #2b91af">float</span> item_float_min;
                    <span style="color: #2b91af">float</span> item_float_max;
                };

                <span style="color: #008000">//variables input by user</span>
                <span style="color: #008000">// probability variables</span>
                <span style="color: #2b91af">float</span> probs0[8], probs1[8], probs2[8], probs3[8], probs4[8], probs5[8], probs6[8], probs7[8];
                <span style="color: #2b91af">int</span> tempo;
                <span style="color: #2b91af">char</span> key[2];


                <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">int</span> curr_index, next_index = 7;

                <span style="color: #008000">// ======</span>
                <span style="color: #008000">// build the menu array of items</span>
                <span style="color: #0000ff">struct</span> menu_item menu[16];
                <span style="color: #008000">// Actually use 11 in this example</span>
                <span style="color: #0000ff">#define menu_length 11</span>
                <span style="color: #008000">//</span>
                <span style="color: #2b91af">void</span> draw_item(<span style="color: #2b91af">short</span> menu_x, <span style="color: #2b91af">short</span> menu_y, <span style="color: #2b91af">int</span> item_index, <span style="color: #2b91af">int</span> menu_num_items)
                {
                    <span style="color: #0000ff">if</span> (item_index &lt; menu_num_items)
                    {
                        <span style="color: #008000">// display the name</span>
                        setTextColor(menu[item_index].item_color);
                        setCursor(menu_x, menu_y + item_index * 25);
                        setTextSize(1);
                        writeString(menu[item_index].item_name);
                        <span style="color: #008000">// display the value</span>
                        setTextColor(WHITE);
                        fillRect(menu_x, menu_y + item_index * 25 + 10, 90, 11, BLACK);
                        setCursor(menu_x, menu_y + item_index * 25 + 11);
                        <span style="color: #2b91af">char</span> value_str[15];
                        <span style="color: #008000">// copy float to int value</span>
                        menu[item_index].item_int_value = (<span style="color: #2b91af">int</span>)menu[item_index].item_float_value;
                        <span style="color: #008000">// get the data type in bit 0</span>
                        <span style="color: #0000ff">if</span> (menu[item_index].item_data_type == 0)
                            sprintf(value_str, <span style="color: #a31515">&quot;%d&quot;</span>, menu[item_index].item_int_value);
                        <span style="color: #0000ff">if</span> (menu[item_index].item_data_type == 1)
                            sprintf(value_str, <span style="color: #a31515">&quot;%8.3f&quot;</span>, menu[item_index].item_float_value);
                        writeString(value_str);
                    }
                }

                <span style="color: #008000">// =====</span>
                <span style="color: #2b91af">void</span> draw_menu(<span style="color: #2b91af">short</span> menu_x, <span style="color: #2b91af">short</span> menu_y, <span style="color: #2b91af">int</span> menu_num_items)
                {
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; menu_num_items; i++)
                    {
                        draw_item(menu_x, menu_y, i, menu_num_items);
                    }
                }

                <span style="color: #008000">// ===== change value with serial</span>
                <span style="color: #008000">// direction is 1 for increase,  -1 for decrease</span>
                <span style="color: #2b91af">void</span> change_value_serial(<span style="color: #2b91af">int</span> index, <span style="color: #2b91af">float</span> value)
                {
                    menu[index].item_float_value = value;
                    <span style="color: #008000">// check min/max</span>
                    <span style="color: #0000ff">if</span> (menu[index].item_float_value &gt; menu[index].item_float_max)
                        menu[index].item_float_value = menu[index].item_float_max;
                    <span style="color: #0000ff">if</span> (menu[index].item_float_value &lt; menu[index].item_float_min)
                        menu[index].item_float_value = menu[index].item_float_min;
                    <span style="color: #008000">// update integer to match</span>
                    menu[index].item_int_value = (<span style="color: #2b91af">int</span>)menu[index].item_float_value;
                }

                <span style="color: #008000">//Deemo Chen RNG</span>
                <span style="color: #008000">// return random number by ROSC between 0-9</span>
                <span style="color: #008000">// N should be in [0,32]</span>
                <span style="color: #2b91af">float</span> rand_note_length(<span style="color: #2b91af">float</span> max_length)
                {
                    <span style="color: #0000ff">static</span> <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">uint32_t</span> *randbit_reg = (<span style="color: #2b91af">uint32_t</span> *)(ROSC_BASE + ROSC_RANDOMBIT_OFFSET);
                    <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> random = 0;
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; 10; i++)
                    {
                        <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> random_bit = 0x1 &amp; (*randbit_reg);
                        random = random &lt;&lt; 1 | random_bit;
                    }
                    <span style="color: #2b91af">int</span> len =  random % 10;

                    <span style="color: #008000">// printf(&quot;len: %d max_length: %f \n&quot;, len, max_length);</span>

                    <span style="color: #008000">//favor longer notes for slow songs</span>
                    <span style="color: #0000ff">if</span>(tempo &lt; 100) {
                        <span style="color: #0000ff">if</span>(len == 2 &amp;&amp; max_length == 4.0) <span style="color: #008000">// whole note</span>
                            <span style="color: #0000ff">return</span> 4.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 4 &amp;&amp; max_length &gt;= 2.0) <span style="color: #008000">//half note</span>
                            <span style="color: #0000ff">return</span> 2.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 6 &amp;&amp; max_length &gt;= 1.0) <span style="color: #008000">//quarter note</span>
                            <span style="color: #0000ff">return</span> 1.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 7 &amp;&amp; max_length &gt;= 0.5) <span style="color: #008000">// eighth note</span>
                            <span style="color: #0000ff">return</span> 0.50;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 8 &amp;&amp; max_length &gt;= 0.25) <span style="color: #008000">// sixteenth note</span>
                            <span style="color: #0000ff">return</span> 0.25;

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">return</span> 0.125; <span style="color: #008000">// really fast notes sound cool!&#39;</span>
                    }

                    <span style="color: #008000">// favor mid length notes for medium paces</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(tempo &lt; 140) {
                        <span style="color: #0000ff">if</span>(len == 1 &amp;&amp; max_length == 4.0) <span style="color: #008000">// whole note</span>
                            <span style="color: #0000ff">return</span> 4.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 4 &amp;&amp; max_length &gt;= 2.0) <span style="color: #008000">//half note</span>
                            <span style="color: #0000ff">return</span> 2.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 6 &amp;&amp; max_length &gt;= 1.0) <span style="color: #008000">//quarter note</span>
                            <span style="color: #0000ff">return</span> 1.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 7 &amp;&amp; max_length &gt;= 0.5) <span style="color: #008000">// eighth note</span>
                            <span style="color: #0000ff">return</span> 0.50;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 8 &amp;&amp; max_length &gt;= 0.25) <span style="color: #008000">// sixteenth note</span>
                            <span style="color: #0000ff">return</span> 0.25;

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">return</span> 0.125; <span style="color: #008000">// really fast notes sound cool!&#39;</span>
                    }

                    <span style="color: #008000">// short note for fast songs</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (tempo &lt; 180) {
                        <span style="color: #0000ff">if</span> (len &lt;= 1 &amp;&amp; max_length &gt;= 2.0) <span style="color: #008000">//half note</span>
                            <span style="color: #0000ff">return</span> 2.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 3 &amp;&amp; max_length &gt;= 1.0) <span style="color: #008000">//quarter note</span>
                            <span style="color: #0000ff">return</span> 1.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 5 &amp;&amp; max_length &gt;= 0.5) <span style="color: #008000">// eighth note</span>
                            <span style="color: #0000ff">return</span> 0.50;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 7 &amp;&amp; max_length &gt;= 0.25) <span style="color: #008000">// sixteenth note</span>
                            <span style="color: #0000ff">return</span> 0.25;

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">return</span> 0.125; <span style="color: #008000">// really fast notes sound cool!&#39;</span>
                    }

                    <span style="color: #0000ff">else</span> {
                        <span style="color: #0000ff">if</span> (len &lt;= 1 &amp;&amp; max_length &gt;= 2.0) <span style="color: #008000">//half note</span>
                            <span style="color: #0000ff">return</span> 2.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 2 &amp;&amp; max_length &gt;= 1.0) <span style="color: #008000">//quarter note</span>
                            <span style="color: #0000ff">return</span> 1.0;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 4 &amp;&amp; max_length &gt;= 0.5) <span style="color: #008000">// eighth note</span>
                            <span style="color: #0000ff">return</span> 0.50;
                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(len &lt;= 7 &amp;&amp; max_length &gt;= 0.25) <span style="color: #008000">// sixteenth note</span>
                            <span style="color: #0000ff">return</span> 0.25;

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">return</span> 0.125; <span style="color: #008000">// really fast notes sound cool!&#39;</span>
                    }


                }

                <span style="color: #008000">//Deemo Chen RNG</span>
                <span style="color: #008000">// return random number by ROSC between 0-9</span>
                <span style="color: #008000">// N should be in [0,32]</span>
                <span style="color: #2b91af">int</span> ROrand(<span style="color: #2b91af">int</span> N)
                {
                <span style="color: #0000ff">static</span> <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">uint32_t</span> *randbit_reg = (<span style="color: #2b91af">uint32_t</span> *)(ROSC_BASE + ROSC_RANDOMBIT_OFFSET);
                <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> random = 0;
                <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; N; i++)
                {
                    <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> random_bit = 0x1 &amp; (*randbit_reg);
                    random = random &lt;&lt; 1 | random_bit;
                }
                <span style="color: #0000ff">return</span> random % 10;
                }

                <span style="color: #2b91af">int</span> note_SM() {
                    <span style="color: #2b91af">int</span> r = ROrand(10);
                    rando = r;
                    <span style="color: #008000">// printf(&quot;rando: %d\n curr_ind: %d\n&quot;, rando, curr_index);</span>

                    <span style="color: #2b91af">int</span> note = 0;

                    <span style="color: #0000ff">switch</span>(curr_index) {
                        <span style="color: #0000ff">case</span> 0:
                            <span style="color: #0000ff">if</span>(r &lt;= probs0[0] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[1] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[2] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[3] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[4] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[5] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs0[6] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> next_index = 7;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 1:
                            <span style="color: #0000ff">if</span>(r &lt;= probs1[0] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[1] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[2] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[3] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[4] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[5] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs1[6] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> next_index = 0;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 2:
                            <span style="color: #0000ff">if</span>(r &lt;= probs2[0] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[1] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[2] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[3] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[4] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[5] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs2[6] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> next_index = 1;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 3: 
                            <span style="color: #0000ff">if</span>(r &lt;= probs3[0] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[1] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[2] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[3] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[4] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[5] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs3[6] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> next_index = 2;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 4: 
                            <span style="color: #0000ff">if</span>(r &lt;= probs4[0] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[1] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[2] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[3] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[4] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[5] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs4[6] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> next_index = 3;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 5: 
                            <span style="color: #0000ff">if</span>(r &lt;= probs5[0] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[1] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[2] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[3] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[4] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[5] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs5[6] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> next_index = 4;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 6: 
                            <span style="color: #0000ff">if</span>(r &lt;= probs6[0] - 1) next_index = 6;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[1] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[2] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[3] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[4] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[5] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs6[6] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> next_index = 5;
                        <span style="color: #0000ff">break</span>;

                        <span style="color: #0000ff">case</span> 7: 
                            <span style="color: #0000ff">if</span>(r &lt;= probs7[0] - 1) next_index = 7;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[1] - 1) next_index = 0;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[2] - 1) next_index = 1;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[3] - 1) next_index = 2;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[4] - 1) next_index = 3;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[5] - 1) next_index = 4;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(r &lt;= probs7[6] - 1) next_index = 5;
                            <span style="color: #0000ff">else</span> next_index = 6;
                        <span style="color: #0000ff">break</span>;

                        default:
                            next_index = 0;
                        <span style="color: #0000ff">break</span>;
                    }

                    curr_index = next_index;
                    note = next_index;
                    <span style="color: #0000ff">return</span> note;

                }

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === fixed point s19x12 for DDS</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// s19x12 fixed point macros == for DDS</span>
                <span style="color: #0000ff">typedef</span> <span style="color: #2b91af">signed</span> <span style="color: #2b91af">int</span> fix;
                <span style="color: #0000ff">#define mul(a, b) ((fix)((((signed long long)(a)) * ((signed long long)(b))) &gt;&gt; 12)) </span><span style="color: #008000">//multiply two fixed 16:16</span>
                <span style="color: #0000ff">#define float_to_fix(a) ((fix)((a)*4096.0))                                          </span><span style="color: #008000">// 2^12</span>
                <span style="color: #0000ff">#define fix_to_float(a) ((float)(a) / 4096.0)</span>
                <span style="color: #0000ff">#define fix_to_int(a) ((int)((a) &gt;&gt; 12))</span>
                <span style="color: #0000ff">#define int_to_fix(a) ((fix)((a) &lt;&lt; 12))</span>
                <span style="color: #0000ff">#define div(a, b) ((fix)((((signed long long)(a) &lt;&lt; 12) / (b))))</span>
                <span style="color: #0000ff">#define absfix(a) abs(a)</span>

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === fixed point s1x14 for FFT</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// s1.14 format -- short format is faster</span>
                <span style="color: #008000">// == resolution 2^-14 = 6.1035e-5</span>
                <span style="color: #008000">// == dynamic range is +1.9999/-2.0</span>
                <span style="color: #0000ff">typedef</span> <span style="color: #2b91af">signed</span> <span style="color: #2b91af">short</span> s1x14;
                <span style="color: #0000ff">#define muls1x14(a, b) ((s1x14)((((int)(a)) * ((int)(b))) &gt;&gt; 14))</span>
                <span style="color: #0000ff">#define float_to_s1x14(a) ((s1x14)((a)*16384.0)) </span><span style="color: #008000">// 2^14</span>
                <span style="color: #0000ff">#define s1x14_to_float(a) ((float)(a) / 16384.0)</span>
                <span style="color: #0000ff">#define abss1x14(a) abs(a)</span>
                <span style="color: #0000ff">#define divs1x14(a, b) ((s1x14)((((signed int)(a) &lt;&lt; 14) / (b))))</span>
                <span style="color: #008000">// shift 12 bits into 14 bits so full scale dds is about 0.25</span>
                <span style="color: #0000ff">#define dds_to_s1x14(a) ((s1x14)((a) &gt;&gt; 14))</span>
                <span style="color: #008000">// shift 12 bits into 13 bits so full scale ADC is about 0.25</span>
                <span style="color: #0000ff">#define adc_to_s1x14(a) ((s1x14)((a)&lt;&lt;1))</span>

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === fixed point s15x16</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// s15x16 fixed point macros ==</span>
                <span style="color: #008000">// == resolution 2^-16 = 1.5e-5</span>
                <span style="color: #008000">// == dynamic range is 32767/-32768</span>
                <span style="color: #0000ff">typedef</span> <span style="color: #2b91af">signed</span> <span style="color: #2b91af">int</span> s15x16;
                <span style="color: #0000ff">#define muls15x16(a,b) ((s15x16)(((( signed long long )(a))*(( signed long long )(b)))&gt;&gt;16)) </span><span style="color: #008000">//multiply two fixed 16:16</span>
                <span style="color: #0000ff">#define float_to_s15x16(a) ((s15x16)((a)*65536.0)) </span><span style="color: #008000">// 2^16</span>
                <span style="color: #0000ff">#define s15x16_to_float(a) ((float)(a)/65536.0)</span>
                <span style="color: #0000ff">#define s15x16_to_int(a)    ((int)((a)&gt;&gt;16))</span>
                <span style="color: #0000ff">#define int_to_s15x16(a)    ((s15x16)((a)&lt;&lt;16))</span>
                <span style="color: #0000ff">#define divs15x16(a,b) ((s15x16)((((signed long long)(a)&lt;&lt;16)/(b)))) </span>
                <span style="color: #0000ff">#define abss15x16(a) abs(a)</span>
                <span style="color: #008000">// the weird shift is to move the sign bits correctly</span>
                <span style="color: #0000ff">#define s1x14_to_s15x16(a) ((s15x16)(a)&lt;&lt;2) ;</span>

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === set up SPI DAC</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// All SPI DAC setup was gotten from HUnter Adams</span>
                <span style="color: #008000">// https://vanhunteradams.com/Pico/TimerIRQ/SPI_DDS.html</span>
                <span style="color: #008000">// DAC parameters</span>
                <span style="color: #008000">// A-channel, 1x, active</span>
                <span style="color: #0000ff">#define DAC_config_chan_A 0b0011000000000000</span>
                <span style="color: #008000">// B-channel, 1x, active</span>
                <span style="color: #0000ff">#define DAC_config_chan_B 0b1011000000000000</span>

                <span style="color: #008000">//SPI configurations</span>
                <span style="color: #0000ff">#define PIN_CS 5</span>
                <span style="color: #0000ff">#define PIN_SCK 6</span>
                <span style="color: #0000ff">#define PIN_MOSI 7</span>
                <span style="color: #0000ff">#define SPI_PORT spi0</span>

                <span style="color: #008000">// data for the spi port</span>
                <span style="color: #2b91af">uint16_t</span> DAC_data;

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === set up DDS and timer ISR</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// 1/Fs in microseconds</span>
                <span style="color: #0000ff">volatile</span> <span style="color: #2b91af">int</span> alarm_period = 25;

                <span style="color: #008000">// DDS variables</span>
                <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> mod_inc[8], main_inc[8];
                <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> current_mod_inc, current_main_inc;
                <span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span> mod_accum, main_accum;

                <span style="color: #008000">// amplitude paramters</span>
                fix max_mod_depth, current_mod_depth;
                <span style="color: #008000">// waveform amplities -- must fit in +/-11 bits for DAC</span>
                fix current_amp, max_amp = float_to_fix(2000.0);

                <span style="color: #008000">// timing in seconds</span>
                fix attack_time, mod_attack_time;
                fix decay_time, mod_decay_time, recip_decay_time;
                fix sustain_time, mod_sustain_time;
                fix onefix = int_to_fix(1);
                <span style="color: #008000">// internal timing in samples</span>
                fix song_time, note_time;
                fix attack_inc, decay_inc, mod_attack_inc, mod_decay_inc, quad_decay_inc;

                <span style="color: #008000">// sine waves</span>
                fix sine_table[256];
                fix mod_wave, main_wave;
                <span style="color: #008000">// inputs</span>
                <span style="color: #2b91af">float</span> Fs, Fout, Fmod;
                                
                <span style="color: #2b91af">float</span> notes[8]; 

                <span style="color: #2b91af">int</span> note_start = true;
                <span style="color: #2b91af">int</span> linear_dk = 0;
                <span style="color: #2b91af">int</span> octave_num;

                <span style="color: #0000ff">#define note_detection_size 15</span>
                <span style="color: #2b91af">float</span> detected_notes[note_detection_size] = {0.0};
                <span style="color: #2b91af">int</span> detected_notes_index = 0;

                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === set up timer ISR  used in this pgm</span>
                <span style="color: #008000">// ==========================================</span>
                <span style="color: #008000">// === timer alarm ========================</span>
                <span style="color: #008000">// !! modifiying alarm zero trashes the cpu</span>
                <span style="color: #008000">//        and causes LED  4 long - 4 short</span>
                <span style="color: #008000">// !! DO NOT USE alarm 0</span>
                <span style="color: #008000">// This low-level setup is ocnsiderably faster to execute</span>
                <span style="color: #008000">// than the hogh-level callback</span>

                <span style="color: #0000ff">#define ALARM_NUM 1</span>
                <span style="color: #0000ff">#define ALARM_IRQ TIMER_IRQ_1</span>
                <span style="color: #008000">// ISR interval will be 10 uSec</span>
                <span style="color: #008000">//</span>
                <span style="color: #008000">// the actual ISR</span>
                <span style="color: #2b91af">void</span> compute_sample(<span style="color: #2b91af">void</span>);
                <span style="color: #008000">//</span>
                <span style="color: #0000ff">static</span> <span style="color: #2b91af">void</span> alarm_irq(<span style="color: #2b91af">void</span>)
                {
                    <span style="color: #008000">// mark ISR entry</span>
                    gpio_put(2, 1);
                    <span style="color: #008000">// Clear the alarm irq</span>
                    hw_clear_bits(&amp;timer_hw-&gt;intr, 1u &lt;&lt; ALARM_NUM);
                    <span style="color: #008000">// arm the next interrupt</span>
                    <span style="color: #008000">// Write the lower 32 bits of the target time to the alarm to arm it</span>
                    timer_hw-&gt;alarm[ALARM_NUM] = timer_hw-&gt;timerawl + alarm_period;
                    
                    compute_sample();

                    <span style="color: #008000">// mark ISR exit</span>
                    gpio_put(2, 0);
                }

                <span style="color: #008000">// set up the timer alarm ISR</span>
                <span style="color: #0000ff">static</span> <span style="color: #2b91af">void</span> alarm_in_us(<span style="color: #2b91af">uint32_t</span> delay_us)
                {
                    <span style="color: #008000">// Enable the interrupt for our alarm (the timer outputs 4 alarm irqs)</span>
                    hw_set_bits(&amp;timer_hw-&gt;inte, 1u &lt;&lt; ALARM_NUM);
                    <span style="color: #008000">// Set irq handler for alarm irq</span>
                    irq_set_exclusive_handler(ALARM_IRQ, alarm_irq);
                    <span style="color: #008000">// Enable the alarm irq</span>
                    irq_set_enabled(ALARM_IRQ, true);
                    <span style="color: #008000">// Enable interrupt in block and at processor</span>
                    <span style="color: #008000">// Alarm is only 32 bits</span>
                    <span style="color: #2b91af">uint64_t</span> target = timer_hw-&gt;timerawl + delay_us;
                    <span style="color: #008000">// Write the lower 32 bits of the target time to the alarm which</span>
                    <span style="color: #008000">// will arm it</span>
                    timer_hw-&gt;alarm[ALARM_NUM] = (<span style="color: #2b91af">uint32_t</span>)target;
                }

                <span style="color: #008000">// ===========================================</span>
                <span style="color: #008000">// dSP definitions</span>
                <span style="color: #008000">// ===========================================</span>
                <span style="color: #008000">//</span>
                <span style="color: #008000">// FFT setup</span>
                <span style="color: #0000ff">#define N_WAVE          adc_array_length    </span><span style="color: #008000">/* size of FFT 512 */</span><span style="color: #0000ff"></span>
                <span style="color: #0000ff">#define LOG2_N_WAVE     11     </span><span style="color: #008000">/* log2(N_WAVE) 0 */</span><span style="color: #0000ff"></span>

                s1x14 Sinewave[N_WAVE];       <span style="color: #008000">// a table of sines for the FFT</span>
                s1x14 window[N_WAVE];         <span style="color: #008000">// a table of window values for the FFT</span>
                s1x14 fr[N_WAVE], fi[N_WAVE]; <span style="color: #008000">// input data</span>
                <span style="color: #008000">// dds output to FFT</span>
                s1x14 dds[N_WAVE]; <span style="color: #008000">// the dds output from ISR</span>
                <span style="color: #008000">// index into dds buffer</span>
                <span style="color: #2b91af">int</span> buffer_index;
                <span style="color: #008000">// displa points for graphiics</span>
                <span style="color: #008000">// short display_data[N_WAVE];</span>
                <span style="color: #008000">// short fft_display_data[N_WAVE];</span>
                <span style="color: #008000">// short log_display_data[N_WAVE];</span>

                <span style="color: #008000">// ==================================</span>
                <span style="color: #008000">// === Init FFT arrays</span>
                <span style="color: #008000">//====================================</span>
                <span style="color: #2b91af">void</span> FFTinit(<span style="color: #2b91af">void</span>)
                {
                    <span style="color: #008000">// one cycle sine table</span>
                    <span style="color: #008000">//  required for FFT</span>
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> ii = 0; ii &lt; N_WAVE; ii++)
                    {
                        <span style="color: #008000">// one cycle per window for FFT -- scall amp for number of bits</span>
                        Sinewave[ii] = float_to_s1x14(0.5 * sin(6.283 * ((<span style="color: #2b91af">float</span>)ii) / N_WAVE));
                        <span style="color: #008000">// Raised cos window</span>
                        window[ii] = float_to_s1x14(1.0 - cos(6.283 * ((<span style="color: #2b91af">float</span>) ii) / (N_WAVE - 1)));
                    }
                }

                <span style="color: #008000">// ==================================</span>
                <span style="color: #008000">// === FFT</span>
                <span style="color: #008000">//====================================</span>
                <span style="color: #2b91af">void</span> FFTfix(s1x14 fr[], s1x14 fi[], <span style="color: #2b91af">int</span> m)
                {
                    <span style="color: #008000">//Adapted from code by:</span>
                    <span style="color: #008000">//Tom Roberts 11/8/89 and Malcolm Slaney 12/15/94 malcolm@interval.com</span>
                    <span style="color: #008000">//fr[n],fi[n] are real,imaginary arrays, INPUT AND RESULT.</span>
                    <span style="color: #008000">//size of data = 2**m</span>
                    <span style="color: #008000">// This routine does foward transform only</span>

                    <span style="color: #2b91af">int</span> mr, nn, i, j, L, k, istep, n;
                    s1x14 qr, qi, tr, ti, wr, wi;

                    mr = 0;
                    n = 1 &lt;&lt; m; <span style="color: #008000">//number of points</span>
                    nn = n - 1;

                    <span style="color: #008000">/* decimation in time - re-order data */</span>
                    <span style="color: #0000ff">for</span> (m = 1; m &lt;= nn; ++m)
                    {
                        L = n;
                        <span style="color: #0000ff">do</span>
                            L &gt;&gt;= 1;
                        <span style="color: #0000ff">while</span> (mr + L &gt; nn);
                        mr = (mr &amp; (L - 1)) + L;
                        <span style="color: #0000ff">if</span> (mr &lt;= m)
                            <span style="color: #0000ff">continue</span>;
                        tr = fr[m];
                        fr[m] = fr[mr];
                        fr[mr] = tr;
                        ti = fi[m];     <span style="color: #008000">//for real inputs, don&#39;t need this</span>
                        fi[m] = fi[mr]; <span style="color: #008000">//for real inputs, don&#39;t need this</span>
                        fi[mr] = ti;    <span style="color: #008000">//for real inputs, don&#39;t need this</span>
                    }

                    L = 1;
                    k = LOG2_N_WAVE - 1;
                    <span style="color: #0000ff">while</span> (L &lt; n)
                    {
                        istep = L &lt;&lt; 1;
                        <span style="color: #0000ff">for</span> (m = 0; m &lt; L; ++m)
                        {
                            j = m &lt;&lt; k;
                            wr = Sinewave[j + N_WAVE / 4];
                            wi = -Sinewave[j];
                            <span style="color: #008000">//wr &gt;&gt;= 1; //do need if scale table</span>
                            <span style="color: #008000">//wi &gt;&gt;= 1;</span>

                            <span style="color: #0000ff">for</span> (i = m; i &lt; n; i += istep)
                            {
                                j = i + L;
                                tr = muls1x14(wr, fr[j]) - muls1x14(wi, fi[j]);
                                ti = muls1x14(wr, fi[j]) + muls1x14(wi, fr[j]);
                                qr = fr[i] &gt;&gt; 1;
                                qi = fi[i] &gt;&gt; 1;
                                fr[j] = qr - tr;
                                fi[j] = qi - ti;
                                fr[i] = qr + tr;
                                fi[i] = qi + ti;
                            }
                        }
                        --k;
                        L = istep;
                    }
                }

                <span style="color: #2b91af">void</span> set_key(<span style="color: #2b91af">float</span> root) {

                    <span style="color: #008000">//key of C</span>
                    <span style="color: #0000ff">if</span>(root == 130.0) {
                        notes[0] = 130.8; <span style="color: #008000">//C3</span>
                        notes[1] = 146.8; <span style="color: #008000">//D3</span>
                        notes[2] = 164.8; <span style="color: #008000">//E3</span>
                        notes[3] = 174.6; <span style="color: #008000">//F3</span>
                        notes[4] = 196.0; <span style="color: #008000">//G3</span>
                        notes[5] = 220.0; <span style="color: #008000">//A3</span>
                        notes[6] = 246.9; <span style="color: #008000">//B3</span>
                        notes[7] = 261.6; <span style="color: #008000">//C4</span>
                    }

                    <span style="color: #008000">// key of Db</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(root == 138.0) {
                        notes[0] = 138.6; <span style="color: #008000">// Db3</span>
                        notes[1] = 155.6; <span style="color: #008000">// Eb3</span>
                        notes[2] = 174.6; <span style="color: #008000">// F3</span>
                        notes[3] = 185.0; <span style="color: #008000">// Gb3</span>
                        notes[4] = 207.7; <span style="color: #008000">// Ab3</span>
                        notes[5] = 233.1; <span style="color: #008000">// Bb3</span>
                        notes[6] = 261.6; <span style="color: #008000">// C4</span>
                        notes[7] = 277.2; <span style="color: #008000">// Db4</span>
                    }

                    <span style="color: #008000">//key of D3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 146.0) {
                        notes[0] = 146.8; <span style="color: #008000">//D3</span>
                        notes[1] = 164.8; <span style="color: #008000">//E3</span>
                        notes[2] = 185.0; <span style="color: #008000">//F#3</span>
                        notes[3] = 196.0; <span style="color: #008000">//G3</span>
                        notes[4] = 220.0; <span style="color: #008000">//A3</span>
                        notes[5] = 246.9; <span style="color: #008000">//B3</span>
                        notes[6] = 277.2; <span style="color: #008000">//C#4</span>
                        notes[7] = 293.7; <span style="color: #008000">//D4</span>
                    }
                
                    <span style="color: #008000">//key of Eb3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 155.0) {
                        notes[0] = 155.6; <span style="color: #008000">//Eb3</span>
                        notes[1] = 174.6; <span style="color: #008000">//F3</span>
                        notes[2] = 196.0; <span style="color: #008000">//G3</span>
                        notes[3] = 207.7; <span style="color: #008000">//Ab3</span>
                        notes[4] = 233.1; <span style="color: #008000">//Bb3</span>
                        notes[5] = 261.6; <span style="color: #008000">//C4</span>
                        notes[6] = 293.7; <span style="color: #008000">//D4</span>
                        notes[7] = 311.1; <span style="color: #008000">//Eb4</span>
                    }
                
                    <span style="color: #008000">//key of E3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 164.0) {
                        notes[0] = 164.8; <span style="color: #008000">//E3</span>
                        notes[1] = 185.0; <span style="color: #008000">//F#3</span>
                        notes[2] = 207.7; <span style="color: #008000">//G#3</span>
                        notes[3] = 220.0; <span style="color: #008000">//A3</span>
                        notes[4] = 233.1; <span style="color: #008000">//Bb3</span>
                        notes[5] = 261.6; <span style="color: #008000">//C4</span>
                        notes[6] = 293.7; <span style="color: #008000">//D4</span>
                        notes[7] = 329.6; <span style="color: #008000">//E4</span>
                    }
                
                    <span style="color: #008000">//key of F3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 174.0) {
                        notes[0] = 174.6; <span style="color: #008000">//F3</span>
                        notes[1] = 196.0; <span style="color: #008000">//G3</span>
                        notes[2] = 220.0; <span style="color: #008000">//A3</span>
                        notes[3] = 233.1; <span style="color: #008000">//Bb3</span>
                        notes[4] = 261.6; <span style="color: #008000">//C4</span>
                        notes[5] = 293.7; <span style="color: #008000">//D4</span>
                        notes[6] = 329.6; <span style="color: #008000">//E4</span>
                        notes[7] = 349.2; <span style="color: #008000">//F4</span>
                    }
                
                    <span style="color: #008000">//key of F#3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 185.0) {
                        notes[0] = 185.0; <span style="color: #008000">//F#3</span>
                        notes[1] = 207.7; <span style="color: #008000">//G#3</span>
                        notes[2] = 233.1; <span style="color: #008000">//A#3</span>
                        notes[3] = 246.9; <span style="color: #008000">//B3</span>
                        notes[4] = 277.2; <span style="color: #008000">//C#4</span>
                        notes[5] = 311.1; <span style="color: #008000">//D#4</span>
                        notes[6] = 349.2; <span style="color: #008000">//E#4</span>
                        notes[7] = 370.0; <span style="color: #008000">//F#4</span>
                    }
                
                    <span style="color: #008000">//key of G3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 196.0) {
                        notes[0] = 196.0; <span style="color: #008000">//G3</span>
                        notes[1] = 220.0; <span style="color: #008000">//A3</span>
                        notes[2] = 246.9; <span style="color: #008000">//B3</span>
                        notes[3] = 261.6; <span style="color: #008000">//C4</span>
                        notes[4] = 293.7; <span style="color: #008000">//D4</span>
                        notes[5] = 329.6; <span style="color: #008000">//E4</span>
                        notes[6] = 370.0; <span style="color: #008000">//F#4</span>
                        notes[7] = 392.0; <span style="color: #008000">//G4</span>
                    }
                
                    <span style="color: #008000">//key of Ab3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 207.0) {
                        notes[0] = 207.7; <span style="color: #008000">//Ab3</span>
                        notes[1] = 233.1; <span style="color: #008000">//Bb3</span>
                        notes[2] = 261.6; <span style="color: #008000">//C4</span>
                        notes[3] = 277.2; <span style="color: #008000">//Db4</span>
                        notes[4] = 311.1; <span style="color: #008000">//Eb4</span>
                        notes[5] = 349.2; <span style="color: #008000">//F4</span>
                        notes[6] = 392.0; <span style="color: #008000">//G4</span>
                        notes[7] = 415.3; <span style="color: #008000">//Ab4</span>
                    }
                
                    <span style="color: #008000">//key of A3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 220.0) {
                        notes[0] = 220.0; <span style="color: #008000">//A3</span>
                        notes[1] = 246.9; <span style="color: #008000">//B3</span>
                        notes[2] = 277.2; <span style="color: #008000">//C#4</span>
                        notes[3] = 293.7; <span style="color: #008000">//D4</span>
                        notes[4] = 329.6; <span style="color: #008000">//E4</span>
                        notes[5] = 370.0; <span style="color: #008000">//F#4</span>
                        notes[6] = 415.3; <span style="color: #008000">//G#4</span>
                        notes[7] = 440.0; <span style="color: #008000">//A4</span>
                    }
                
                    <span style="color: #008000">//key of Bb3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 233.0) {
                        notes[0] = 233.1; <span style="color: #008000">//Bb3</span>
                        notes[1] = 261.6; <span style="color: #008000">//C4</span>
                        notes[2] = 293.7; <span style="color: #008000">//D4</span>
                        notes[3] = 311.1; <span style="color: #008000">//Eb4</span>
                        notes[4] = 349.2; <span style="color: #008000">//F4</span>
                        notes[5] = 392.0; <span style="color: #008000">//G4</span>
                        notes[6] = 440.0; <span style="color: #008000">//A4</span>
                        notes[7] = 466.2; <span style="color: #008000">//Bb4</span>
                    }
                
                    <span style="color: #008000">//key of B3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (root == 246.0) {
                        notes[0] = 246.9; <span style="color: #008000">//B3</span>
                        notes[1] = 277.2; <span style="color: #008000">//C#4</span>
                        notes[2] = 311.1; <span style="color: #008000">//D#4</span>
                        notes[3] = 329.6; <span style="color: #008000">//E4</span>
                        notes[4] = 370.0; <span style="color: #008000">//F#4</span>
                        notes[5] = 415.3; <span style="color: #008000">//G#4</span>
                        notes[6] = 466.2; <span style="color: #008000">//A#4</span>
                        notes[7] = 493.9; <span style="color: #008000">//B4</span>
                    }
                    <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i = 0; i &lt; 8; i++) {
                        notes[i] = 2 * notes[i];
                    }
                }

                <span style="color: #2b91af">int</span> check_other_notes(<span style="color: #2b91af">float</span> valid_notes[], <span style="color: #2b91af">int</span> valid_notes_size, <span style="color: #2b91af">float</span> key_guess) {

                    <span style="color: #2b91af">float</span> key_array[7];

                    <span style="color: #008000">// printf(&quot;key guess: %f\n&quot;, key_guess);</span>

                    <span style="color: #008000">//initialize notes array based on key_guess</span>
                    <span style="color: #008000">//key of C3</span>
                    <span style="color: #0000ff">if</span>(key_guess == 130.0) {
                        <span style="color: #008000">// printf(&quot;in key of c&quot;);</span>

                        key_array[0] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[1] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[2] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[3] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[4] = 196.0; <span style="color: #008000">//G3</span>
                        key_array[5] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[6] = 246.0; <span style="color: #008000">//B3</span>
                        printf(<span style="color: #a31515">&quot;key of C\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of Db3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 138.0) {
                        key_array[0] = 138.0; <span style="color: #008000">//Db3</span>
                        key_array[1] = 155.0; <span style="color: #008000">//Eb3</span>
                        key_array[2] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[3] = 185.0; <span style="color: #008000">//Gb3</span>
                        key_array[4] = 207.0; <span style="color: #008000">//Ab3</span>
                        key_array[5] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[6] = 130.0; <span style="color: #008000">//C3</span>
                        printf(<span style="color: #a31515">&quot;key of Db\n&quot;</span>);

                    }
                
                    <span style="color: #008000">//key of D3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 146.0) {
                        key_array[0] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[1] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[2] = 185.0; <span style="color: #008000">//F#3</span>
                        key_array[3] = 196.0; <span style="color: #008000">//G3</span>
                        key_array[4] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[5] = 246.0; <span style="color: #008000">//B3</span>
                        key_array[6] = 138.0; <span style="color: #008000">//C#3</span>
                        printf(<span style="color: #a31515">&quot;key of D\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of Eb3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 155.0) {
                        key_array[0] = 155.0; <span style="color: #008000">//Eb3</span>
                        key_array[1] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[2] = 196.0; <span style="color: #008000">//G3</span>
                        key_array[3] = 207.0; <span style="color: #008000">//Ab3</span>
                        key_array[4] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[5] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[6] = 146.0; <span style="color: #008000">//D3</span>
                        printf(<span style="color: #a31515">&quot;key of Eb\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of E3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 164.0) {
                        key_array[0] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[1] = 185.0; <span style="color: #008000">//F#3</span>
                        key_array[2] = 207.0; <span style="color: #008000">//G#3</span>
                        key_array[3] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[4] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[5] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[6] = 146.0; <span style="color: #008000">//D3</span>
                        printf(<span style="color: #a31515">&quot;key of E\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of F3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 174.0) {
                        key_array[0] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[1] = 196.0; <span style="color: #008000">//G3</span>
                        key_array[2] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[3] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[4] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[5] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[6] = 164.0; <span style="color: #008000">//E3</span>
                        printf(<span style="color: #a31515">&quot;key of F\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of F#3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 185.0) {
                        key_array[0] = 185.0; <span style="color: #008000">//F#3</span>
                        key_array[1] = 207.0; <span style="color: #008000">//G#3</span>
                        key_array[2] = 233.0; <span style="color: #008000">//A#3</span>
                        key_array[3] = 246.0; <span style="color: #008000">//B3</span>
                        key_array[4] = 138.0; <span style="color: #008000">//C#3</span>
                        key_array[5] = 155.0; <span style="color: #008000">//D#3</span>
                        key_array[6] = 174.0; <span style="color: #008000">//E#3</span>
                        printf(<span style="color: #a31515">&quot;key of F#\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of G3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 196.0) {
                        key_array[0] = 196.0; <span style="color: #008000">//G3</span>
                        key_array[1] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[2] = 246.0; <span style="color: #008000">//B3</span>
                        key_array[3] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[4] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[5] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[6] = 185.0; <span style="color: #008000">//F#3</span>
                        printf(<span style="color: #a31515">&quot;key of G\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of Ab3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 207.7) {
                        key_array[0] = 207.0; <span style="color: #008000">//Ab3</span>
                        key_array[1] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[2] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[3] = 138.0; <span style="color: #008000">//Db3</span>
                        key_array[4] = 155.0; <span style="color: #008000">//Eb3</span>
                        key_array[5] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[6] = 196.0; <span style="color: #008000">//G3</span>
                        printf(<span style="color: #a31515">&quot;key of Ab\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of A3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 220.0) {
                        key_array[0] = 220.0; <span style="color: #008000">//A3</span>
                        key_array[1] = 246.0; <span style="color: #008000">//B3</span>
                        key_array[2] = 138.0; <span style="color: #008000">//C#3</span>
                        key_array[3] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[4] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[5] = 185.0; <span style="color: #008000">//F#3</span>
                        key_array[6] = 207.0; <span style="color: #008000">//G#3</span>
                        printf(<span style="color: #a31515">&quot;key of A\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of Bb3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 233.0) {
                        key_array[0] = 233.0; <span style="color: #008000">//Bb3</span>
                        key_array[1] = 130.0; <span style="color: #008000">//C3</span>
                        key_array[2] = 146.0; <span style="color: #008000">//D3</span>
                        key_array[3] = 155.0; <span style="color: #008000">//Eb3</span>
                        key_array[4] = 174.0; <span style="color: #008000">//F3</span>
                        key_array[5] = 195.0; <span style="color: #008000">//G3</span>
                        key_array[6] = 220.0; <span style="color: #008000">//A3</span>
                        printf(<span style="color: #a31515">&quot;key of Bb\n&quot;</span>);
                    }
                
                    <span style="color: #008000">//key of B3</span>
                    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (key_guess == 246.0) {
                        key_array[0] = 246.0; <span style="color: #008000">//B3</span>
                        key_array[1] = 138.0; <span style="color: #008000">//C#3</span>
                        key_array[2] = 155.0; <span style="color: #008000">//D#3</span>
                        key_array[3] = 164.0; <span style="color: #008000">//E3</span>
                        key_array[4] = 185.0; <span style="color: #008000">//F#3</span>
                        key_array[5] = 207.0; <span style="color: #008000">//G#3</span>
                        key_array[6] = 233.0; <span style="color: #008000">//A#3</span>
                        printf(<span style="color: #a31515">&quot;key of B\n&quot;</span>);
                    }

                    <span style="color: #0000ff">else</span> {
                        key_array[0] = 1.0; <span style="color: #008000">//B3</span>
                        key_array[1] = 1.0; <span style="color: #008000">//C#4</span>
                        key_array[2] = 1.0; <span style="color: #008000">//D#4</span>
                        key_array[3] = 1.0; <span style="color: #008000">//E4</span>
                        key_array[4] = 1.0; <span style="color: #008000">//F#4</span>
                        key_array[5] = 1.0; <span style="color: #008000">//G#4</span>
                        key_array[6] = 1.0; <span style="color: #008000">//A#4</span>
                        key_array[7] = 1.0; <span style="color: #008000">//B4</span>

                    }

                    <span style="color: #008000">// printf(&quot;1st note: %f 5th note: %f \n&quot;, key_array[0], key_array[4]);</span>

                    <span style="color: #2b91af">int</span> match = 0;

                    <span style="color: #008000">//compare all notes in valid notes to notes in guessed key</span>
                    <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i = 0; i &lt; valid_notes_size; i++) {
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> j = 0; j &lt; 7; j++) {
                            <span style="color: #0000ff">if</span>(valid_notes[i] == key_array[j]) {
                                match = 1;
                            }
                        }
                        <span style="color: #0000ff">if</span>(match == 0) <span style="color: #0000ff">return</span> 0; <span style="color: #008000">// wrong key!</span>
                        <span style="color: #0000ff">else</span> match = 0;
                    }

                    <span style="color: #008000">//got through the for loop? </span>
                    <span style="color: #0000ff">return</span> 1;

                }

                <span style="color: #2b91af">void</span> key_detect() {
                    <span style="color: #008000">//remember that each octave is a factor of 2 Hz</span>

                    <span style="color: #2b91af">float</span> valid_notes[note_detection_size];
                    <span style="color: #2b91af">int</span>   valid_notes_index = 0;
                    <span style="color: #008000">// all notes have to be in range 130.8(C3) to 246.0(B3) for easy comparisons</span>
                    <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i = 0; i &lt;= 10; i++) {
                        <span style="color: #008000">// if detected note is less that C3 multiply it by 2</span>
                        <span style="color: #0000ff">if</span>(detected_notes[i] &lt; 127.0) {
                            <span style="color: #008000">// if detected note is less than 70Hz, it&#39;s probably not valid (could be silence)</span>
                            <span style="color: #0000ff">if</span>(detected_notes[i] &gt;= 70.0) {
                                valid_notes[valid_notes_index] = detected_notes[i] * 2.0;

                                <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 134.0) {
                                    valid_notes[valid_notes_index] = 130.00000; <span style="color: #008000">//perfect C3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 142.0) {
                                    valid_notes[valid_notes_index] = 138.00000; <span style="color: #008000">//perfect C#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 150.0) {
                                    valid_notes[valid_notes_index] = 146.00000; <span style="color: #008000">//perfect D3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 160.0) {
                                    valid_notes[valid_notes_index] = 155.00000; <span style="color: #008000">//perfect D#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 169.0) {
                                    valid_notes[valid_notes_index] = 164.00000; <span style="color: #008000">//perfect E3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 178.0) {
                                    valid_notes[valid_notes_index] = 174.00000; <span style="color: #008000">//perfect F3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 189.0) {
                                    valid_notes[valid_notes_index] = 185.000000; <span style="color: #008000">//perfect F#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 200.0) {
                                    valid_notes[valid_notes_index] = 196.000000; <span style="color: #008000">//perfect G3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 211.0) {
                                    valid_notes[valid_notes_index] = 207.00000; <span style="color: #008000">//perfect G#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 224.0) {
                                    valid_notes[valid_notes_index] = 220.000000; <span style="color: #008000">//perfect A3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 237.0) {
                                    valid_notes[valid_notes_index] = 233.00000; <span style="color: #008000">//perfect A#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 250.0) {
                                    valid_notes[valid_notes_index] = 246.00000; <span style="color: #008000">//perfect B3</span>
                                }
                                <span style="color: #008000">// printf(&quot;index: %d valid note 1: %f \n&quot;, i, valid_notes[i]);</span>
                                valid_notes_index++;
                            }
                        }

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(detected_notes[i] &gt; 250.0) {
                            <span style="color: #008000">// highest note on piano is C8 (4186Hz) so anything higher is probably noise</span>
                            <span style="color: #0000ff">if</span>(detected_notes[i] &lt;= 4200.0) {
                                <span style="color: #0000ff">while</span>(detected_notes[i] &gt; 250.0) {
                                    detected_notes[i] = detected_notes[i] / 2.0;
                                }
                                valid_notes[valid_notes_index] = detected_notes[i];

                                <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 134.0) {
                                    valid_notes[valid_notes_index] = 130.00000; <span style="color: #008000">//perfect C3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 142.0) {
                                    valid_notes[valid_notes_index] = 138.00000; <span style="color: #008000">//perfect C#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 150.0) {
                                    valid_notes[valid_notes_index] = 146.00000; <span style="color: #008000">//perfect D3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 160.0) {
                                    valid_notes[valid_notes_index] = 155.00000; <span style="color: #008000">//perfect D#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 169.0) {
                                    valid_notes[valid_notes_index] = 164.00000; <span style="color: #008000">//perfect E3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 178.0) {
                                    valid_notes[valid_notes_index] = 174.00000; <span style="color: #008000">//perfect F3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 189.0) {
                                    valid_notes[valid_notes_index] = 185.000000; <span style="color: #008000">//perfect F#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 200.0) {
                                    valid_notes[valid_notes_index] = 196.000000; <span style="color: #008000">//perfect G3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 211.0) {
                                    valid_notes[valid_notes_index] = 207.00000; <span style="color: #008000">//perfect G#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 224.0) {
                                    valid_notes[valid_notes_index] = 220.000000; <span style="color: #008000">//perfect A3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 237.0) {
                                    valid_notes[valid_notes_index] = 233.00000; <span style="color: #008000">//perfect A#3</span>
                                }
                                <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(valid_notes[valid_notes_index] &lt;= 250.0) {
                                    valid_notes[valid_notes_index] = 246.00000; <span style="color: #008000">//perfect B3</span>
                                }
                                <span style="color: #008000">//  printf(&quot;index: %d valid note 2: %f \n&quot;, i, valid_notes[i]);</span>
                                valid_notes_index++;
                            }
                        }
                    }

                    <span style="color: #008000">//detect mode...cross ur fingers that it is the key</span>
                    <span style="color: #2b91af">float</span> maxfreq = 0.0; 
                    <span style="color: #2b91af">int</span>   maxcount = 0;
                    <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i = 0; i &lt; valid_notes_index; i++) {
                        <span style="color: #2b91af">int</span> count = 0;
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> j = 0; j &lt; valid_notes_index; j++){
                            <span style="color: #0000ff">if</span>(valid_notes[j] == valid_notes[i]) {
                                count++;
                            }
                        }
                        <span style="color: #0000ff">if</span>(count &gt; maxcount) {
                            maxfreq = valid_notes[i];
                            maxcount = count;
                        }
                    }
                    printf(<span style="color: #a31515">&quot;mode: %f \n&quot;</span>, maxfreq);

                                        <span style="color: #008000">//C[0]        C#[1]         D[2]   D#[3]        E[4]        F[5]           F#[6]      G[7]       G#[8]        A[9]       A#[10]     B[11]</span>
                    <span style="color: #2b91af">float</span> all_notes[12] = {130.00000, 138.00000, 146.00000, 155.00000, 164.00000, 174.00000, 185.000000, 196.000000, 207.600000, 220.000000, 233.00000, 246.00000};

                    <span style="color: #008000">//first see if the mode is the root/key</span>
                    <span style="color: #0000ff">if</span>(check_other_notes(valid_notes, valid_notes_index, maxfreq) == 1) {
                        printf(<span style="color: #a31515">&quot;check other notes worked\n&quot;</span>);
                        <span style="color: #008000">//set key and enable</span>

                        set_key(maxfreq);
                        kd_EN = 1;
                        mic_EN = 0;

                    }

                    <span style="color: #008000">//now see if the mode is the fifth</span>
                    <span style="color: #0000ff">else</span> {
                        printf(<span style="color: #a31515">&quot;check other notes did not work\n&quot;</span>);

                        <span style="color: #2b91af">int</span> mode_index = 0;
                        <span style="color: #2b91af">int</span> fifth_index = 0;
                        
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i = 0; i &lt; 12; i++) {
                            <span style="color: #0000ff">if</span>(maxfreq == all_notes[i]) {
                                mode_index = i;
                            }
                        }

                        <span style="color: #0000ff">if</span>(mode_index &lt;= 6) {
                            fifth_index = mode_index + 5;
                        }
                        <span style="color: #0000ff">else</span> {
                            fifth_index = mode_index - 7;
                        }
                        
                        <span style="color: #0000ff">if</span>(check_other_notes(valid_notes, valid_notes_index, all_notes[fifth_index]) == 1) {
                            printf(<span style="color: #a31515">&quot;check other notes (fifth)worked\n&quot;</span>);

                            <span style="color: #008000">//set key and enable</span>
                            set_key(all_notes[fifth_index]);
                            kd_EN = 1;
                            mic_EN = 0;
                        }

                        <span style="color: #008000">//now try the seventh</span>
                        <span style="color: #0000ff">else</span>{
                            printf(<span style="color: #a31515">&quot;check other notes (fifth) did not work\n&quot;</span>);
                            <span style="color: #2b91af">int</span> seventh_index = 0;

                            <span style="color: #0000ff">if</span>(mode_index &lt;= 10) {
                            seventh_index = mode_index + 1;
                            }
                            <span style="color: #008000">//else index is 0</span>

                            <span style="color: #0000ff">if</span>(check_other_notes(valid_notes, valid_notes_index, all_notes[seventh_index]) == 1) {
                                printf(<span style="color: #a31515">&quot;check other notes (seventh)worked\n&quot;</span>);

                                <span style="color: #008000">//set key and enable</span>
                                set_key(all_notes[seventh_index]);
                                kd_EN = 1;
                                mic_EN = 0;

                            }

                            <span style="color: #0000ff">else</span> {
                                printf(<span style="color: #a31515">&quot;check other notes (seventh) did not work\n&quot;</span>);
                            }
                        }
                    }
                }

                <span style="color: #008000">//====================================</span>
                <span style="color: #008000">// === magnitude approx good to about +/-2%</span>
                <span style="color: #008000">// see https://en.wikipedia.org/wiki/Alpha_max_plus_beta_min_algorithm</span>
                <span style="color: #0000ff">#define min(a, b) (((a) &lt; (b)) ? (a) : (b))</span>
                <span style="color: #0000ff">#define max(a, b) (((a) &gt; (b)) ? (a) : (b))</span>
                <span style="color: #008000">//====================================</span>
                <span style="color: #2b91af">void</span> magnitude(s1x14 fr[], s1x14 fi[], <span style="color: #2b91af">int</span> length)
                {
                    s1x14 mmax, mmin;
                    s1x14 c1 = float_to_s1x14(0.89820);
                    s1x14 c2 = float_to_s1x14(0.48597);
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> ii = 0; ii &lt; length; ii++)
                    {
                        mmin = min(abs(fr[ii]), abs(fi[ii])); <span style="color: #008000">//&gt;&gt;9</span>
                        mmax = max(abs(fr[ii]), abs(fi[ii]));
                        <span style="color: #008000">// reuse fr to hold magnitude</span>
                        fr[ii] = max(mmax, (muls1x14(mmax, c1) + muls1x14(mmin, c2)));
                        fi[ii] = 0;
                    }
                }

                <span style="color: #008000">// ==================================</span>
                <span style="color: #008000">// === approx log2 for plotting</span>
                <span style="color: #008000">//====================================</span>
                <span style="color: #008000">// see:</span>
                    <span style="color: #008000">// Generation of Products and Quotients Using Approximate Binary Logarithms </span>
                    <span style="color: #008000">// for Digital Filtering Applications, </span>
                    <span style="color: #008000">// IEEE Transactions on Computers 1970 vol.19 Issue No.02</span>
                <span style="color: #008000">//====================================</span>

                <span style="color: #2b91af">void</span> log2_approx0(s1x14 fr[], <span style="color: #2b91af">int</span> length){
                s15x16 log_input, log_output ;
                <span style="color: #008000">// reduced range variable for interpolation</span>
                s15x16 x;
                <span style="color: #008000">// low cutoff</span>
                s15x16 low_cutoff = float_to_s15x16(0.00006) ;
                s15x16 c1 = float_to_s15x16(0.984) ;
                s15x16 c2 = float_to_s15x16(0.065) ;


                <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> ii = 0; ii &lt; length; ii++) {
                    log_input = s1x14_to_s15x16(fr[ii]) ;    
                    
                    <span style="color: #008000">// check for too small or negative</span>
                    <span style="color: #008000">// and return smallest log2</span>
                    <span style="color: #0000ff">if</span>(log_input &lt;= low_cutoff){
                    fr[ii] = -15 ;
                    <span style="color: #0000ff">continue</span> ;
                    }
                    <span style="color: #008000">// if the input is less than 2 the scale up by</span>
                    <span style="color: #008000">// 2^14 so always working on an integer</span>
                    <span style="color: #008000">// so we can get logs down to input of 0.00003 or so approx -14.85</span>
                    <span style="color: #2b91af">int</span> frac_factor = 0 ;
                    <span style="color: #0000ff">if</span> (log_input &lt; int_to_s15x16(2) ){
                    <span style="color: #008000">// max size of shift to not overflow</span>
                    frac_factor = 14 ;
                    log_input &lt;&lt;= frac_factor ;
                    }

                    <span style="color: #008000">// temp for finding msb</span>
                    s15x16 sx ;  
                    sx = log_input ;

                    <span style="color: #008000">// find the most-significant bit</span>
                    <span style="color: #008000">// equivalent to finding the characteristic of the log</span>
                    s15x16 y=1; <span style="color: #008000">// value of MSB</span>
                    s15x16 ly=0; <span style="color: #008000">// position of MSB</span>
                    <span style="color: #0000ff">while</span>(sx&gt;int_to_s15x16(2)) {
                        y=y&lt;&lt;1 ; ly=ly+int_to_s15x16(1) ; sx=sx&gt;&gt;1;
                    }
                    <span style="color: #008000">// bound the bottom and detect negative input values</span>
                    <span style="color: #008000">// Two-segment approx is good to better than  0.02 log unit</span>
                    <span style="color: #008000">// equiv to finding the mantissa of the log, then adding the charastic</span>
                    <span style="color: #008000">// see:</span>
                    <span style="color: #008000">// Generation of Products and Quotients Using Approximate Binary Logarithms </span>
                    <span style="color: #008000">// for Digital Filtering Applications, </span>
                    <span style="color: #008000">// IEEE Transactions on Computers 1970 vol.19 Issue No.02</span>
                    <span style="color: #008000">// normalize the bits after dleting MSB</span>
                    x = (log_input-y)&gt;&gt;(<span style="color: #2b91af">int</span>)ly ;
                    <span style="color: #008000">// piecewise linear curve fit</span>
                    <span style="color: #008000">//if(x&lt;0.5) log_output = (ly + x*1.163 + 0.0213) - frac_factor ;</span>
                    <span style="color: #008000">//else      log_output = (ly + x*0.828 + 0.1815) - frac_factor ;</span>
                    <span style="color: #008000">// one segment approx goodd to about 0.07 log unit</span>
                    log_output = (ly + x*c1 + c2) - frac_factor ;
                    <span style="color: #008000">// and store it</span>
                    fr[ii] = log_output&gt;&gt;16 ;
                
                }
                }
                <span style="color: #0000ff">#define log_min 0x00</span>
                <span style="color: #008000">// reuse fr to hold log magnitude</span>
                <span style="color: #008000">// shifting finds most significant bit</span>
                <span style="color: #008000">// then make approxlog  = ly + (fr-y)./(y) + 0.043;</span>
                <span style="color: #008000">// BUT for an 8-bit approx (4 bit ly and 4-bit fraction)</span>
                <span style="color: #008000">// ly 1&lt;=ly&lt;=14</span>
                <span style="color: #008000">// omit the 0.043 because it is too small for 4-bit fraction</span>
                <span style="color: #2b91af">void</span> log2_approx(s1x14 fr[], <span style="color: #2b91af">int</span> length)
                {
                    
                    <span style="color: #2b91af">int</span> sx, y, ly, temp;
                    <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; length; i++)
                    {
                        <span style="color: #008000">// interpret bits as integer</span>
                        sx = fr[i];
                        y = 1;
                        ly = 0;
                        <span style="color: #0000ff">while</span> (sx &gt; 1)
                        {
                            y = y * 2;
                            ly = ly + 1;
                            sx = sx &gt;&gt; 1;
                        }
                        <span style="color: #008000">// shift ly into upper 4-bits as integer part of log</span>
                        <span style="color: #008000">// take bits below y and shift into lower 4-bits</span>
                        <span style="color: #008000">// !!NOTE that fr is no longer in s1x14 format!!</span>
                        fr[i] = ((ly) &lt;&lt; 4) + ((fr[i] - y) &gt;&gt; (ly - 4));
                        <span style="color: #008000">// bound the noise at low amp</span>
                        <span style="color: #0000ff">if</span> (fr[i] &lt; log_min)
                            fr[i] = log_min;
                    }
                }
                <span style="color: #008000">// User input thread</span>
                <span style="color: #0000ff">static</span> PT_THREAD (protothread_serial(<span style="color: #0000ff">struct</span> pt *pt))
                {
                    PT_BEGIN(pt) ;
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> test_in ;
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">float</span> test_in_fl ;
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> default_weights;
                    <span style="color: #0000ff">while</span>(1) {        
                        
                        sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input desired tempo [60, 250] \n&quot;</span>);
                        serial_write ;
                        <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                        serial_read ;
                        <span style="color: #008000">//convert input string to number</span>
                        sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%d&quot;</span>, &amp;tempo) ;

                        <span style="color: #008000">//*notes the pico outputs notes twice as high as we set, but that shouldn&#39;t be an issue - still in the same key</span>

                        sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;Press 1: equal weights, 2: jazzy weights, 3: custom\n&quot;</span>);

                        serial_write ;
                        <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                        serial_read ;
                        <span style="color: #008000">//convert input string to number</span>
                        sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%d&quot;</span>, &amp;default_weights) ;

                        <span style="color: #0000ff">if</span>(default_weights == 1) {
                            probs0[0] = 1.25;
                            probs0[1] = 1.25;
                            probs0[2] = 1.25;
                            probs0[3] = 1.25;
                            probs0[4] = 1.25;
                            probs0[5] = 1.25;
                            probs0[6] = 1.25;
                            probs0[7] = 1.25;

                            probs1[0] = 1.25;
                            probs1[1] = 1.25;
                            probs1[2] = 1.25;
                            probs1[3] = 1.25;
                            probs1[4] = 1.25;
                            probs1[5] = 1.25;
                            probs1[6] = 1.25;
                            probs1[7] = 1.25;


                            probs2[0] = 1.25;
                            probs2[1] = 1.25;
                            probs2[2] = 1.25;
                            probs2[3] = 1.25;
                            probs2[4] = 1.25;
                            probs2[5] = 1.25;
                            probs2[6] = 1.25;
                            probs2[7] = 1.25;

                            probs3[0] = 1.25;
                            probs3[1] = 1.25;
                            probs3[2] = 1.25;
                            probs3[3] = 1.25;
                            probs3[4] = 1.25;
                            probs3[5] = 1.25;
                            probs3[6] = 1.25;
                            probs3[7] = 1.25;

                            probs4[0] = 1.25;
                            probs4[1] = 1.25;
                            probs4[2] = 1.25;
                            probs4[3] = 1.25;
                            probs4[4] = 1.25;
                            probs4[5] = 1.25;
                            probs4[6] = 1.25;
                            probs4[7] = 1.25;

                            probs5[0] = 1.25;
                            probs5[1] = 1.25;
                            probs5[2] = 1.25;
                            probs5[3] = 1.25;
                            probs5[4] = 1.25;
                            probs5[5] = 1.25;
                            probs5[6] = 1.25;
                            probs5[7] = 1.25;
                            
                            probs6[0] = 1.25;
                            probs6[1] = 1.25;
                            probs6[2] = 1.25;
                            probs6[3] = 1.25;
                            probs6[4] = 1.25;
                            probs6[5] = 1.25;
                            probs6[6] = 1.25;
                            probs6[7] = 1.25;

                            probs7[0] = 1.25;
                            probs7[1] = 1.25;
                            probs7[2] = 1.25;
                            probs7[3] = 1.25;
                            probs7[4] = 1.25;
                            probs7[5] = 1.25;
                            probs7[6] = 1.25;
                            probs7[7] = 1.25;

                        }

                        <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span>(default_weights == 2) {
                            probs0[0] = 1.0;
                            probs0[1] = 0.0;
                            probs0[2] = 2.0;
                            probs0[3] = 2.0;
                            probs0[4] = 2.0;
                            probs0[5] = 2.0;
                            probs0[6] = 0.5;
                            probs0[7] = 0.5;

                            probs1[0] = 1.0;
                            probs1[1] = 1.0;
                            probs1[2] = 1.0;
                            probs1[3] = 2.5;
                            probs1[4] = 2.5;
                            probs1[5] = 1.0;
                            probs1[6] = 0.0;
                            probs1[7] = 1.0;


                            probs2[0] = 1.0;
                            probs2[1] = 3.0;
                            probs2[2] = 1.0;
                            probs2[3] = 1.0;
                            probs2[4] = 0.0;
                            probs2[5] = 1.0;
                            probs2[6] = 0.0;
                            probs2[7] = 3.0;

                            probs3[0] = 1.0;
                            probs3[1] = 3.0;
                            probs3[2] = 0.5;
                            probs3[3] = 0.5;
                            probs3[4] = 0.5;
                            probs3[5] = 1.0;
                            probs3[6] = 0.5;
                            probs3[7] = 3.0;

                            probs4[0] = 1.0;
                            probs4[1] = 0.5;
                            probs4[2] = 2.0;
                            probs4[3] = 0.5;
                            probs4[4] = 1.0;
                            probs4[5] = 2.0;
                            probs4[6] = 2.0;
                            probs4[7] = 1.0;

                            probs5[0] = 1.0;
                            probs5[1] = 1.0;
                            probs5[2] = 1.0;
                            probs5[3] = 1.0;
                            probs5[4] = 2.0;
                            probs5[5] = 2.0;
                            probs5[6] = 1.0;
                            probs5[7] = 1.0;
                            
                            probs6[0] = 0.5;
                            probs6[1] = 3.5;
                            probs6[2] = 3.5;
                            probs6[3] = 0.5;
                            probs6[4] = 0.5;
                            probs6[5] = 0.5;
                            probs6[6] = 0.5;
                            probs6[7] = 0.5;

                            probs7[0] = 1.0;
                            probs7[1] = 1.0;
                            probs7[2] = 0.5;
                            probs7[3] = 2.0;
                            probs7[4] = 1.5;
                            probs7[5] = 3.0;
                            probs7[6] = 0.5;
                            probs7[7] = 0.5;

                        }

                        <span style="color: #0000ff">else</span> {
                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 1 (C in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs0[0], &amp;probs0[1], &amp;probs0[2], &amp;probs0[3], &amp;probs0[4], &amp;probs0[5], &amp;probs0[6], &amp;probs0[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 2 (D in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs1[0], &amp;probs1[1], &amp;probs1[2], &amp;probs1[3], &amp;probs1[4], &amp;probs1[5], &amp;probs1[6], &amp;probs1[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 3 (E in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs2[0], &amp;probs2[1], &amp;probs2[2], &amp;probs2[3], &amp;probs2[4], &amp;probs2[5], &amp;probs2[6], &amp;probs2[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 4 (F in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs3[0], &amp;probs3[1], &amp;probs3[2], &amp;probs3[3], &amp;probs3[4], &amp;probs3[5], &amp;probs3[6], &amp;probs3[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 5 (G in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs4[0], &amp;probs4[1], &amp;probs4[2], &amp;probs4[3], &amp;probs4[4], &amp;probs4[5], &amp;probs4[6], &amp;probs4[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 6 (A in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs5[0], &amp;probs5[1], &amp;probs5[2], &amp;probs5[3], &amp;probs5[4], &amp;probs5[5], &amp;probs5[6], &amp;probs5[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 7 (B in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs6[0], &amp;probs6[1], &amp;probs6[2], &amp;probs6[3], &amp;probs6[4], &amp;probs6[5], &amp;probs6[6], &amp;probs6[7]) ;

                            sprintf(pt_serial_out_buffer, <span style="color: #a31515">&quot;input probability weights (adding up to 10) for note 8 (next octave C in Key of C)\n&quot;</span>);
                            serial_write ;
                            <span style="color: #008000">//spawn a thread to do the non-blocking serial read</span>
                            serial_read ;
                            <span style="color: #008000">//convert input string to number</span>
                            sscanf(pt_serial_in_buffer,<span style="color: #a31515">&quot;%f %f %f %f %f %f %f %f&quot;</span>, &amp;probs7[0], &amp;probs7[1], &amp;probs7[2], &amp;probs7[3], &amp;probs7[4], &amp;probs7[5], &amp;probs7[6], &amp;probs7[7]) ;
                        }

                        sm_EN = 1;
                    }
                    PT_END(pt) ;
                }

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === graphics demo -- RUNNING on core 0</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #0000ff">static</span> PT_THREAD(protothread_graphics(<span style="color: #0000ff">struct</span> pt *pt))
                {
                    PT_BEGIN(pt);

                    <span style="color: #008000">// DMA channel -- needed to check for DMA done</span>
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> ADC_data_chan ;
                    <span style="color: #008000">// // update count -- for tuning cursor speed</span>
                    <span style="color: #008000">// static int update_count;</span>

                    <span style="color: #008000">// the protothreads interval timer</span>
                    PT_INTERVAL_INIT();

                    <span style="color: #008000">// Draw some filled rectangles</span>
                    fillRect(20, 1, 400, 50, LIGHT_BLUE); <span style="color: #008000">// blue box</span>
                    fillRect(435, 1, 200, 50, ORANGE); <span style="color: #008000">// green box</span>

                    <span style="color: #008000">// Write some text</span>
                    setTextColor(BLACK) ;
                    <span style="color: #2b91af">short</span> text_x = 445 ;
                    setCursor(text_x, 2) ;
                    setTextSize(1) ;
                    writeString(<span style="color: #a31515">&quot;Raspberry Pi Pico&quot;</span>) ;
                    setCursor(text_x, 12) ;
                    writeString(<span style="color: #a31515">&quot;VGA scope demo - ECE 4760&quot;</span>) ;
                    setCursor(text_x, 22) ;
                    writeString(<span style="color: #a31515">&quot;Hunter Adams:vha3@cornell.edu&quot;</span>) ;
                    setCursor(text_x, 32) ;
                    writeString(<span style="color: #a31515">&quot;Protothreads rp2040 v1.1.1&quot;</span>) ;
                    setCursor(text_x, 42) ;
                    writeString(<span style="color: #a31515">&quot;16 color VGA&quot;</span>) ;

                    setCursor(80, 252) ;
                    setTextSize(1) ;
                    setTextColor2(BLACK, YELLOW);
                    writeString(<span style="color: #a31515">&quot; Spectrum 0-8KHz &quot;</span>) ;
                    setCursor(350, 252) ;
                    writeString(<span style="color: #a31515">&quot; Log Spectrum 0-8KHz &quot;</span>) ;

                    <span style="color: #008000">// === congure the ADC =========</span>
                    <span style="color: #008000">// ===  and start a buffer fill</span>
                    ADC_data_chan = ADC_setup() ;
                    <span style="color: #008000">//</span>

                    <span style="color: #008000">// test menu setup</span>
                    <span style="color: #008000">// bulky, but unavoidable</span>
                    menu[0].item_color = WHITE;
                    menu[1].item_color = WHITE;
                    menu[2].item_color = WHITE;
                    menu[3].item_color = WHITE;
                    menu[4].item_color = GREEN;
                    menu[5].item_color = GREEN;
                    menu[6].item_color = GREEN;
                    menu[7].item_color = GREEN;
                    menu[8].item_color = GREEN;
                    menu[9].item_color = LIGHT_BLUE;
                    menu[10].item_color = RED;
                    <span style="color: #008000">//</span>
                    sprintf(menu[0].item_name, <span style="color: #a31515">&quot;Octave # &quot;</span>);
                    sprintf(menu[1].item_name, <span style="color: #a31515">&quot;Attack main &quot;</span>);
                    sprintf(menu[2].item_name, <span style="color: #a31515">&quot;Sustain main &quot;</span>);
                    sprintf(menu[3].item_name, <span style="color: #a31515">&quot;Decay main &quot;</span>);
                    sprintf(menu[4].item_name, <span style="color: #a31515">&quot;Fmod/Fmain &quot;</span>);
                    sprintf(menu[5].item_name, <span style="color: #a31515">&quot;FM depth max &quot;</span>);
                    sprintf(menu[6].item_name, <span style="color: #a31515">&quot;Attack FM &quot;</span>);
                    sprintf(menu[7].item_name, <span style="color: #a31515">&quot;Sustain FM &quot;</span>);
                    sprintf(menu[8].item_name, <span style="color: #a31515">&quot;Decay FM &quot;</span>);
                    sprintf(menu[9].item_name, <span style="color: #a31515">&quot;Lin=1/Quad DK &quot;</span>);
                    sprintf(menu[10].item_name, <span style="color: #a31515">&quot;Run &quot;</span>);
                    <span style="color: #008000">//</span>
                    menu[0].item_data_type = 0;  <span style="color: #008000">// int</span>
                    menu[1].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[2].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[3].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[4].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[5].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[6].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[7].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[8].item_data_type = 1;  <span style="color: #008000">// float</span>
                    menu[9].item_data_type = 0;  <span style="color: #008000">// int</span>
                    menu[10].item_data_type = 0; <span style="color: #008000">// int</span>
                    <span style="color: #008000">//</span>
                    menu[0].item_inc_type = 0;  <span style="color: #008000">// lin update</span>
                    menu[1].item_inc_type = 1;  <span style="color: #008000">// log update</span>
                    menu[2].item_inc_type = 1;  <span style="color: #008000">// log</span>
                    menu[3].item_inc_type = 1;  <span style="color: #008000">// log</span>
                    menu[4].item_inc_type = 0;  <span style="color: #008000">// lin update</span>
                    menu[5].item_inc_type = 1;  <span style="color: #008000">// log update</span>
                    menu[6].item_inc_type = 1;  <span style="color: #008000">// log</span>
                    menu[7].item_inc_type = 1;  <span style="color: #008000">// log</span>
                    menu[8].item_inc_type = 1;  <span style="color: #008000">// log</span>
                    menu[9].item_inc_type = 0;  <span style="color: #008000">//</span>
                    menu[10].item_inc_type = 0; <span style="color: #008000">//</span>
                    <span style="color: #008000">//</span>
                    menu[0].item_increment = 1;
                    menu[1].item_increment = 1.1;
                    menu[2].item_increment = 1.1;
                    menu[3].item_increment = 1.1;
                    menu[4].item_increment = 0.01;
                    menu[5].item_increment = 1.01;
                    menu[6].item_increment = 1.1;
                    menu[7].item_increment = 1.1;
                    menu[8].item_increment = 1.1;
                    menu[9].item_increment = 1;
                    menu[10].item_increment = 1;

                    <span style="color: #008000">//</span>
                    menu[0].item_float_value = 3;   <span style="color: #008000">// </span>
                    menu[1].item_float_value = .01; <span style="color: #008000">//</span>
                    menu[2].item_float_value = .3;  <span style="color: #008000">// </span>
                    menu[3].item_float_value = .3;  <span style="color: #008000">//</span>
                    menu[4].item_float_value = 3;   <span style="color: #008000">// </span>
                    menu[5].item_float_value = .25; <span style="color: #008000">// </span>
                    menu[6].item_float_value = .01; <span style="color: #008000">//</span>
                    menu[7].item_float_value = .1;  <span style="color: #008000">//</span>
                    menu[8].item_float_value = .4;  <span style="color: #008000">//</span>
                    menu[9].item_float_value = 0;   <span style="color: #008000">//</span>
                    menu[10].item_float_value = 1;  <span style="color: #008000">//</span>

                    menu[0].item_float_min = 1;
                    menu[0].item_float_max = 6;
                    menu[1].item_float_min = .001;
                    menu[1].item_float_max = 5;
                    menu[2].item_float_min = .001;
                    menu[2].item_float_max = 5;
                    menu[3].item_float_min = .001;
                    menu[3].item_float_max = 5;
                    menu[4].item_float_min = .001;
                    menu[4].item_float_max = 100;
                    menu[5].item_float_min = .001;
                    menu[5].item_float_max = 100;
                    menu[6].item_float_min = .001;
                    menu[6].item_float_max = 5;
                    menu[7].item_float_min = .001;
                    menu[7].item_float_max = 5;
                    menu[8].item_float_min = .001;
                    menu[8].item_float_max = 5;
                    menu[9].item_float_min = 0;
                    menu[9].item_float_max = 1;
                    menu[10].item_float_min = 0;
                    menu[10].item_float_max = 1;

                    <span style="color: #0000ff">while</span>(true) {

                    <span style="color: #008000">// yield until ADC buffer full</span>
                    PT_YIELD_UNTIL(pt, run_stop);
                    PT_YIELD_UNTIL(pt, !dma_channel_is_busy(ADC_data_chan));

                    <span style="color: #008000">// get ADC buffer and start next buffer fill by reseting DMA source addr</span>
                    memcpy(analysis_data, adc_data, adc_array_length*2) ;
                    memcpy(fft_data, adc_data, adc_array_length*2) ;
                    <span style="color: #008000">// </span>

                    <span style="color: #008000">// restart DMA from ADC</span>
                    dma_channel_set_write_addr (ADC_data_chan, adc_data, true) ;

                    <span style="color: #008000">// tell core 1 to do fft</span>
                    PT_SEM_SAFE_SIGNAL(pt, &amp;run_fft_s);

                    <span style="color: #008000">// plot time series </span>
                    <span style="color: #008000">// void drawLine(short x0, short y0, short x1, short y1, char color) {</span>
                    <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i=0; i&lt;adc_array_length-1; i++){
                        <span style="color: #008000">// erase a point</span>
                        drawPixel(i+40, display_data[i], BLACK) ;
                        <span style="color: #008000">//drawLine(i+40, display_data[i], i+41, display_data[i+1], BLACK);</span>
                        display_data[i] = (analysis_data[i]&gt;&gt;5) + 100 ;
                        drawPixel(i+40, display_data[i], GREEN) ;
                        <span style="color: #008000">//drawLine(i+40, display_data[i], i+41, display_data[i+1], GREEN);</span>
                    }
                }
                PT_END(pt);
                } <span style="color: #008000">// graphics thread</span>

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === toggle25 thread on core 0</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// the on-board LED blinks</span>
                <span style="color: #008000">// just a heartbeat to make sure we did not crash</span>
                <span style="color: #0000ff">static</span> PT_THREAD(protothread_toggle25(<span style="color: #0000ff">struct</span> pt *pt))
                {
                    PT_BEGIN(pt);
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">bool</span> LED_state = false;

                    <span style="color: #008000">// set up LED p25 to blink</span>
                    gpio_init(25);
                    gpio_set_dir(25, GPIO_OUT);
                    gpio_put(25, true);
                    <span style="color: #008000">// data structure for interval timer</span>
                    PT_INTERVAL_INIT();

                    <span style="color: #0000ff">while</span> (1)
                    {
                        <span style="color: #008000">// yield time 0.1 second</span>
                        <span style="color: #008000">//PT_YIELD_usec(100000) ;</span>
                        PT_YIELD_INTERVAL(100000);

                        <span style="color: #008000">// toggle the LED on PICO</span>
                        LED_state = LED_state ? false : true;
                        gpio_put(25, LED_state);
                        
                        <span style="color: #008000">// NEVER exit while</span>
                    } <span style="color: #008000">// END WHILE(1)</span>
                    PT_END(pt);
                } <span style="color: #008000">// blink thread</span>

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === FM parameter setup core1</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">//</span>
                <span style="color: #0000ff">static</span> PT_THREAD(protothread_FM(<span style="color: #0000ff">struct</span> pt *pt))
                {
                    PT_BEGIN(pt);

                    <span style="color: #008000">// convert alarm period in uSEc to rate</span>
                    Fs = 1.0 / ((<span style="color: #2b91af">float</span>)alarm_period * 1e-6);
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">float</span> four_beats = 4.0;

                    <span style="color: #0000ff">if</span>(kd_EN == 1) {
                        mic_EN = 0;
                        <span style="color: #0000ff">while</span> (1)
                        {

                            <span style="color: #008000">// == Fout and Fmod are in Hz</span>
                            <span style="color: #008000">// == fm_depth is 0 to 10 or so</span>
                            <span style="color: #008000">// == times are in seconds</span>
                            <span style="color: #008000">// wait for the run command</span>
                            PT_YIELD_UNTIL(pt, menu[10].item_float_value == 1);

                            <span style="color: #008000">// conversion to intrnal units</span>
                            <span style="color: #008000">// increment = Fout/Fs * 2^32</span>
                            <span style="color: #008000">// octave number is based on a C3 to C4 table</span>

                            octave_num = menu[0].item_float_value;
                            Fmod = 1.5;<span style="color: #008000">// menu[4].item_float_value;</span>
                            <span style="color: #2b91af">float</span> current_note;

                            rand_len = rand_note_length(four_beats);
                            four_beats = four_beats - rand_len;

                            <span style="color: #0000ff">if</span>(four_beats == 0.0){
                                four_beats = 4.0;
                            }
                            printf(<span style="color: #a31515">&quot;note length: %f \n&quot;</span>, rand_len);

                            <span style="color: #2b91af">float</span> dur = 83.0 / (<span style="color: #2b91af">float</span>)tempo; <span style="color: #008000">//got 83 from testing</span>

                            <span style="color: #2b91af">int</span> i = note_SM();
                            printf(<span style="color: #a31515">&quot;frequency: %f \n&quot;</span>, notes[i]);
                            current_note = notes[i] * pow(2, octave_num - 3);
                            main_inc[i] = current_note * pow(2, 32) / Fs;
                            mod_inc[i] = Fmod * current_note * pow(2, 32) / Fs;
                        
                            <span style="color: #008000">// fm modulation strength</span>
                            max_mod_depth = float_to_fix(menu[5].item_float_value * 100000);

                            <span style="color: #008000">// convert main input times to sample number</span>
                            attack_time = float_to_fix(menu[1].item_float_value * Fs);  <span style="color: #008000">//when this is *rand_len, clicking occurs with 16th notes</span>
                            decay_time = float_to_fix(menu[3].item_float_value * Fs * rand_len * dur);
                            sustain_time = float_to_fix(menu[2].item_float_value * Fs * rand_len * dur);
                            <span style="color: #008000">// and now get increments</span>
                            attack_inc = div(max_amp, attack_time);
                            <span style="color: #008000">// linear and parabolic fit</span>
                            decay_inc = div(max_amp, decay_time);
                            recip_decay_time = div(onefix, decay_time);

                            <span style="color: #008000">// convert modulation input times to sample number</span>
                            mod_attack_time = float_to_fix(menu[6].item_float_value * Fs * rand_len * dur);
                            mod_decay_time = float_to_fix(menu[8].item_float_value * Fs * rand_len * dur);
                            mod_sustain_time = float_to_fix(menu[7].item_float_value * Fs * rand_len * dur);
                            <span style="color: #008000">// and now get increments</span>
                            <span style="color: #008000">// precomputing increments means that only add/subtract is needed</span>
                            mod_attack_inc = div(max_mod_depth, mod_attack_time);
                            mod_decay_inc = div(max_mod_depth, mod_decay_time);

                            current_main_inc = main_inc[i];
                            current_mod_inc = mod_inc[i];
                            note_start = true;
                            
                            PT_YIELD_UNTIL(pt, current_amp &lt; onefix);
                            
                            <span style="color: #008000">// NEVER exit while</span>
                        } <span style="color: #008000">// END WHILE(1)</span>
                    }
                    PT_END(pt);
                } <span style="color: #008000">// timer thread</span>

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === ISR routine -- RUNNING on core 1</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">//</span>
                <span style="color: #2b91af">void</span> compute_sample(<span style="color: #2b91af">void</span>)
                {
                    <span style="color: #008000">// ===</span>
                    <span style="color: #008000">// start a burst on new data</span>
                    <span style="color: #0000ff">if</span> (note_start)
                    {
                        <span style="color: #008000">// init the amplitude</span>
                        current_amp = attack_inc;
                        current_mod_depth = mod_attack_inc;
                        <span style="color: #008000">// reset the start flag</span>
                        note_start = false;
                        <span style="color: #008000">// reset envelope time</span>
                        note_time = 0;
                        <span style="color: #008000">// phase lock the main frequency</span>
                        main_accum = 0;
                    } <span style="color: #008000">// note start</span>
                    <span style="color: #008000">// play the burst as long as the amplitude is positive</span>
                    <span style="color: #008000">// as it decays linearly</span>
                    <span style="color: #0000ff">if</span> (current_amp &gt; 0)
                    {

                        <span style="color: #008000">// update dds modulation freq</span>
                        mod_accum += current_mod_inc;
                        mod_wave = sine_table[mod_accum &gt;&gt; 24];
                        <span style="color: #008000">// get the instataneous modulation amp</span>
                        <span style="color: #008000">// update modulation amplitude envelope</span>
                        <span style="color: #0000ff">if</span> (note_time &lt; (mod_attack_time + mod_decay_time + mod_sustain_time))
                        {
                            current_mod_depth = (note_time &lt;= mod_attack_time) ? current_mod_depth + mod_attack_inc : (note_time &lt;= mod_attack_time + mod_sustain_time) ? current_mod_depth
                                                                                                                                                                        : current_mod_depth - mod_decay_inc;
                        }
                        <span style="color: #0000ff">else</span>
                        {
                            current_mod_depth = 0;
                        }

                        <span style="color: #008000">// set dds main freq and FM modulate it</span>
                        main_accum += current_main_inc + (<span style="color: #2b91af">unsigned</span> <span style="color: #2b91af">int</span>)mul(mod_wave, current_mod_depth);
                        <span style="color: #008000">// update main waveform</span>
                        main_wave = sine_table[main_accum &gt;&gt; 24];

                        <span style="color: #008000">// get the instataneous amp</span>
                        <span style="color: #008000">// update amplitude envelope</span>
                        <span style="color: #008000">// linear EXCEPT for optional parabolic decay</span>
                        <span style="color: #0000ff">if</span> (note_time &lt; (attack_time + decay_time + sustain_time))
                        {
                            <span style="color: #0000ff">if</span> (note_time &lt;= attack_time)
                                current_amp += attack_inc;
                            <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (note_time &gt; attack_time + sustain_time)
                            {
                                <span style="color: #0000ff">if</span> (linear_dk == 1)
                                {
                                    current_amp -= decay_inc;
                                }
                                <span style="color: #0000ff">else</span>
                                {
                                    current_amp = current_amp - (decay_inc &lt;&lt; 1) +
                                                div(mul((decay_inc &lt;&lt; 1), (note_time - attack_time - sustain_time)), decay_time);
                                }
                            }
                        }
                        <span style="color: #0000ff">else</span>
                        {
                            current_amp = 0;
                        }
                        <span style="color: #008000">// amplitide modulate and shift to the correct range for PWM</span>
                        main_wave = mul(main_wave, current_amp);
                        <span style="color: #008000">// write final result  to 8-bit PWM</span>
                        <span style="color: #008000">//pwm_set_chan_level(pwm_slice_num, pwm_chan_num, fix_to_int(main_wave) + 128) ;</span>
                        <span style="color: #008000">//pwm_set_chan_level(pwm_slice_num, pwm_chan_num, fix_to_int(current_amp)) ;</span>
                        DAC_data = (DAC_config_chan_A | ((fix_to_int(main_wave) + 2048) &amp; 0xfff));

                        <span style="color: #008000">// Write data to DAC</span>
                        spi_write16_blocking(SPI_PORT, &amp;DAC_data, 1);
                        <span style="color: #008000">// move time ahead</span>
                        note_time += onefix;
                    } <span style="color: #008000">// current amp &gt; 0</span>
                    <span style="color: #0000ff">else</span>
                    {
                        <span style="color: #008000">// set PWM to neutral level</span>
                        DAC_data = (DAC_config_chan_A | ((2048) &amp; 0xfff));
                    }

                    <span style="color: #008000">// save in buffer for FFT</span>
                    <span style="color: #0000ff">if</span> (buffer_index &lt; N_WAVE)
                    {
                        dds[buffer_index++] = dds_to_s1x14(main_wave);
                    }
                } <span style="color: #008000">// end ISR call</span>

                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">// === fft thread -- RUNNING on core 1</span>
                <span style="color: #008000">// ==================================================</span>
                <span style="color: #008000">//</span>
                <span style="color: #0000ff">static</span> PT_THREAD(protothread_fft(<span style="color: #0000ff">struct</span> pt *pt))
                {
                    <span style="color: #008000">// if(sm_EN == 1) {</span>
                    PT_BEGIN(pt);
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">short</span> time_column;
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">short</span> fr_disp;
                    <span style="color: #008000">// green &gt; yellow &gt; red</span>
                    <span style="color: #008000">// static short color_map[10] = {0, 1, 2, 3, 11, 10, 9, 8, 12, 15};</span>
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">short</span> color_map[7] ={0, 1, 2, 3, 7, 11, 15};

                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">short</span> thread_time;

                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> curr_max_mag_index = 0;
                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> prev_max_mag_index = 0;

                    <span style="color: #0000ff">static</span> <span style="color: #2b91af">int</span> same_count = 0;

                    PT_INTERVAL_INIT();

                    FFTinit();

                    <span style="color: #0000ff">while</span>(mic_EN == 1) { 
                        <span style="color: #008000">//</span>
                        PT_SEM_SAFE_WAIT(pt, &amp;run_fft_s) ;
                        <span style="color: #008000">// compute FFT on ADC buffer and draw one column</span>
                        <span style="color: #008000">// covert ADC to fixed point</span>
                        <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; N_WAVE; i++) {
                        fr[i] =  adc_to_s1x14(analysis_data[i]) ;  <span style="color: #008000">//adc_to_s1x14</span>
                        }
                        
                        <span style="color: #008000">// do the windowing</span>
                        <span style="color: #0000ff">for</span> (<span style="color: #2b91af">int</span> i = 0; i &lt; N_WAVE; i++) {
                        fr[i] = muls1x14(fr[i], window[i]); 
                        fi[i] = 0;
                        }

                        <span style="color: #008000">// do the FFT</span>
                        FFTfix(fr, fi, LOG2_N_WAVE);
                        <span style="color: #008000">//</span>
                        <span style="color: #008000">// compute power spectrum</span>
                        magnitude(fr, fi, N_WAVE);

                        <span style="color: #008000">// plot single spectrum for testing</span>
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i=2; i&lt;adc_array_length/2; i++){
                        <span style="color: #008000">// erase a point</span>
                        drawPixel(i+40, fft_display_data[i], BLACK) ;
                        fft_display_data[i] = -(<span style="color: #2b91af">short</span>)(fr[i]&gt;&gt;4) + 250 ;
                        drawPixel(i+40, fft_display_data[i], GREEN) ;
                        }
                        <span style="color: #008000">// find max of magnitude for freq estimate</span>
                        s1x14 max_mag = 0 ;
                        <span style="color: #2b91af">int</span> max_mag_index = 0;
                        
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i=2; i&lt;adc_array_length/2; i++){
                        <span style="color: #008000">// </span>
                        <span style="color: #0000ff">if</span>(fr[i] &gt; max_mag) {
                            max_mag = fr[i] ;
                            max_mag_index = i ;
                        } 
                        }


                        curr_max_mag_index = max_mag_index;
                        <span style="color: #008000">// print frequency estimate</span>
                        <span style="color: #2b91af">char</span> vga_buffer[50] ;
                        sprintf(vga_buffer, <span style="color: #a31515">&quot;Freq = %6.1f  &quot;</span>, max_mag_index * 31.25 / 4 ) ;
                        setCursor(25, 32) ;
                        setTextSize(1) ;
                        setTextColor2(BLACK, LIGHT_BLUE);
                        writeString(vga_buffer) ;

                        <span style="color: #008000">// plot log-spectrum for testing</span>
                        <span style="color: #008000">// !!After log, the returned fr is no longer in s1x14 format!!</span>
                        <span style="color: #008000">// do the APPROXIMATE log in u4x4 format!</span>
                        log2_approx(fr, adc_array_length/2) ;
                        <span style="color: #008000">// plot </span>
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i=2; i&lt;adc_array_length/2; i++){
                        <span style="color: #008000">// erase a point</span>
                        drawPixel(i+300, log_display_data[i], BLACK) ;
                        fr[i] = max(fr[i], 64) - 64;
                        log_display_data[i] = -(<span style="color: #2b91af">short</span>)(fr[i]&gt;&gt;1) + 250 ;
                        drawPixel(i+300, log_display_data[i], GREEN) ;
                        }

                        <span style="color: #008000">// plot a vertical slice for spectrogram</span>
                        <span style="color: #008000">// Spectrogram -- draw and move right</span>
                        <span style="color: #008000">// wrap the screen</span>
                        <span style="color: #008000">// at right edge of screen, reset to left edge</span>
                        time_column++ ;
                        <span style="color: #0000ff">if</span> (time_column == 636) time_column = 3;
                        <span style="color: #0000ff">for</span>(<span style="color: #2b91af">int</span> i=1; i&lt;200; i++){
                        <span style="color: #008000">// bound to 0 to 7</span>
                        fr_disp = color_map[min(6, max((fr[i]&gt;&gt;3)-3, 0))] ; <span style="color: #008000">//4-1</span>
                        drawPixel(time_column, 480-i, fr_disp ) ;
                        } 
                        <span style="color: #008000">//printf(&quot;curr index: %d prev index: %d\n&quot;, curr_max_mag_index, prev_max_mag_index);</span>



                        <span style="color: #008000">// only detect notes if they are held for a reasonable amount of time</span>
                        <span style="color: #0000ff">if</span>(sm_EN == 1 &amp;&amp; curr_max_mag_index == prev_max_mag_index) {
                            same_count++;
                            <span style="color: #008000">// printf(&quot;count: %d max mag index: %d\n&quot;, same_count, curr_max_mag_index);</span>

                            <span style="color: #008000">// if(tempo &gt;= 140) {</span>
                                detected_notes[detected_notes_index] = (<span style="color: #2b91af">float</span>) curr_max_mag_index * 31.25/4.0;
                                printf(<span style="color: #a31515">&quot;detected index: %d detected note: %f \n&quot;</span>, detected_notes_index, detected_notes[detected_notes_index]);
                                detected_notes_index++;
                                <span style="color: #0000ff">if</span>(detected_notes_index &gt;= note_detection_size - 1) {
                                    key_detect();

                                    detected_notes_index = 0;
                                }
                                same_count = 0; <span style="color: #008000">// test</span>
                        }
                        <span style="color: #0000ff">else</span> {
                            same_count = 0;
                        }

                        prev_max_mag_index = curr_max_mag_index;



                        <span style="color: #008000">// NEVER exit while</span>
                    } <span style="color: #008000">// END WHILE(1)</span>
                    PT_END(pt);
                
                } <span style="color: #008000">// FFT thread</span>

                <span style="color: #008000">// ========================================</span>
                <span style="color: #008000">// === core 1 main -- started in main below</span>
                <span style="color: #008000">// ========================================</span>
                <span style="color: #2b91af">void</span> core1_main()
                {

                    <span style="color: #008000">// fire off interrupt</span>
                    alarm_in_us(alarm_period);

                    <span style="color: #008000">//  === add threads  ====================</span>
                    <span style="color: #008000">// for core 1</span>
                    pt_add_thread(protothread_FM);
                    pt_add_thread(protothread_fft);
                    <span style="color: #008000">//</span>
                    <span style="color: #008000">// === initalize the scheduler ==========</span>
                    pt_schedule_start;
                    <span style="color: #008000">// NEVER exits</span>
                    <span style="color: #008000">// ======================================</span>
                }

                <span style="color: #008000">// ========================================</span>
                <span style="color: #008000">// === core 0 main</span>
                <span style="color: #008000">// ========================================</span>
                <span style="color: #2b91af">int</span> main()
                {

                    <span style="color: #008000">// dds table 10 bit values</span>
                    <span style="color: #2b91af">int</span> i = 0;
                    <span style="color: #0000ff">while</span> (i &lt; 256)
                    {
                        <span style="color: #008000">// sine table is in naural +1/-1 range</span>
                        sine_table[i] = float_to_fix(sin(2 * 3.1416 * i / 256));
                        i++;
                    }

                    <span style="color: #008000">// start the serial i/o</span>
                    stdio_init_all();
                    <span style="color: #008000">// announce the threader version on system reset</span>
                    printf(<span style="color: #a31515">&quot;\n\rProtothreads RP2040 v1.11 two-core\n\r&quot;</span>);

                    <span style="color: #008000">// Initialize SPI channel (channel, baud rate set to 20MHz)</span>
                    <span style="color: #008000">// connected to spi DAC</span>
                    spi_init(SPI_PORT, 20000000);
                    <span style="color: #008000">// Format (channel, data bits per transfer, polarity, phase, order)</span>
                    spi_set_format(SPI_PORT, 16, 0, 0, 0);

                    <span style="color: #008000">// Map SPI signals to GPIO ports</span>
                    <span style="color: #008000">//gpio_set_function(PIN_MISO, GPIO_FUNC_SPI);</span>
                    gpio_set_function(PIN_SCK, GPIO_FUNC_SPI);
                    gpio_set_function(PIN_MOSI, GPIO_FUNC_SPI);
                    gpio_set_function(PIN_CS, GPIO_FUNC_SPI);

                    <span style="color: #008000">// Initialize the VGA screen</span>
                    initVGA();

                    <span style="color: #008000">// init the global fft ready signals</span>
                    PT_SEM_SAFE_INIT(&amp;run_fft_s, 1) ;
                    PT_SEM_SAFE_INIT(&amp;finish_fft_s, 1) ;
                    <span style="color: #008000">// anybody can print first</span>
                    PT_LOCK_INIT(lock_stdout, 31, 0) ;

                    <span style="color: #008000">// start core 1 threads</span>
                    multicore_reset_core1();
                    multicore_launch_core1(&amp;core1_main);

                    <span style="color: #008000">// === config threads ========================</span>
                    <span style="color: #008000">// for core 0</span>
                    pt_add_thread(protothread_graphics);
                    pt_add_thread(protothread_toggle25);
                    pt_add_thread(protothread_serial) ;
                    <span style="color: #008000">//</span>
                    <span style="color: #008000">// === initalize the scheduler ===============</span>
                    pt_schedule_start;
                    <span style="color: #008000">// NEVER exits</span>
                    <span style="color: #008000">// ===========================================</span>
                } <span style="color: #008000">// end main&#39;</span>
                </pre></td></tr></table></div>


        <!-- </section>
        <!-- Signup
        <section class="signup-section" id="signup">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5">
                    <div class="col-md-10 col-lg-8 mx-auto text-center">
                        <i class="far fa-paper-plane fa-2x mb-2 text-white"></i>
                        <h2 class="text-white mb-5">Subscribe to receive updates!</h2>
                        <!-- * * * * * * * * * * * * * * *-->
                        <!-- * * SB Forms Contact Form * *-->
                        <!-- * * * * * * * * * * * * * * *-->
                        <!-- This form is pre-integrated with SB Forms.-->
                        <!-- To make this form functional, sign up at-->
                        <!-- https://startbootstrap.com/solution/contact-forms-->
                        <!-- to get an API token!-->
                        <!-- <form class="form-signup" id="contactForm" data-sb-form-api-token="API_TOKEN"> -->
                            <!-- Email address input-->
                            <!-- <div class="row input-group-newsletter"> -->
                                <!-- <div class="col"><input class="form-control" id="emailAddress" type="email" placeholder="Enter email address..." aria-label="Enter email address..." data-sb-validations="required,email" /></div>
                                <div class="col-auto"><button class="btn btn-primary disabled" id="submitButton" type="submit">Notify Me!</button></div>
                            </div>
                            <div class="invalid-feedback mt-2" data-sb-feedback="emailAddress:required">An email is required.</div>
                            <div class="invalid-feedback mt-2" data-sb-feedback="emailAddress:email">Email is not valid.</div> -->
                            <!-- Submit success message-->
                            <!---->
                            <!-- This is what your users will see when the form-->
                            <!-- has successfully submitted-->
                            <!-- <div class="d-none" id="submitSuccessMessage">
                                <div class="text-center mb-3 mt-2 text-white">
                                    <div class="fw-bolder">Form submission successful!</div>
                                    To activate this form, sign up at
                                    <br />
                                    <a href="https://startbootstrap.com/solution/contact-forms">https://startbootstrap.com/solution/contact-forms</a>
                                </div>
                            </div> -->
                            <!-- Submit error message-->
                            <!---->
                            <!-- This is what your users will see when there is-->
                            <!-- an error submitting the form-->
                            <!-- <div class="d-none" id="submitErrorMessage"><div class="text-center text-danger mb-3 mt-2">Error sending message!</div></div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        Contact-->
        <!-- <section class="contact-section bg-black">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-map-marked-alt text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Address</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50">4923 Market Street, Orlando FL</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-envelope text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Email</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50"><a href="#!">hello@yourdomain.com</a></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div class="card py-4 h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-mobile-alt text-primary mb-2"></i>
                                <h4 class="text-uppercase m-0">Phone</h4>
                                <hr class="my-4 mx-auto" />
                                <div class="small text-black-50">+1 (555) 902-8832</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="social d-flex justify-content-center">
                    <a class="mx-2" href="#!"><i class="fab fa-twitter"></i></a>
                    <a class="mx-2" href="#!"><i class="fab fa-facebook-f"></i></a>
                    <a class="mx-2" href="#!"><i class="fab fa-github"></i></a>
                </div>
            </div>
        </section>  -->
        <!-- Footer-->
        <footer class="footer bg-black small text-center text-white-50"><div class="container px-4 px-lg-5">We credit Bootstrap's library of free HTML theme for helping us with this website. 
        
        </div>
        <div class="container px-4 px-lg-5">Content by Kaitlyn Beiler, Wanda Field, Nia Reid-Vicars. ECE 4760 F22.</div></footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
