<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Design</title>

    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

    <script src="https://kit.fontawesome.com/5b081e2bb9.js" crossorigin="anonymous"></script>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-dark sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fa-solid fa-forward-fast"></i>
                    <!-- <i class="fas fa-laugh-wink"></i> -->
                </div>
                <div class="sidebar-brand-text mx-3">
                ECE 4760
                <br>
                FALL 22
                </div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
                <a class="nav-link" href="index.html">
                    <i class="fa-solid fa-house"></i>
                    <!-- <i class="fas fa-fw fa-tachometer-alt"></i> -->
                    <span>Main</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Report
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fa-regular fa-folder"></i>
                    <!-- <i class="fas fa-fw fa-folder"></i> -->
                    <span>Sections</span>
                </a>
                <div id="collapsePages" class="collapse show" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-light py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Project:</h6>
                        <a class="collapse-item" href="overview.html">High-Level Overview</a>
                        <a class="collapse-item" href="design.html">Design</a>
                        <a class="collapse-item" href="results.html">Results</a>
                        <a class="collapse-item" href="conclusions.html">Conclusions</a>
                        <div class="collapse-divider"></div>
                        <h6 class="collapse-header">Appendices:</h6>
                        <a class="collapse-item" href="permissions.html">Permissions</a>
                        <a class="collapse-item" href="code.html">Code</a>
                        <a class="collapse-item" href="misc.html">Miscellaneous</a>
                    </div>
                </div>
            </li>

            <!-- Sidebar Message -->
            <div class="sidebar-card d-none d-lg-flex">
                <p class="text-center mb-0">
                tc575 rm722 raf269
                </p>
            </div>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Begin Page Content -->
                <div class="container-fluid">

                <br>
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">Design</h1>
                    </div>

                    <div class="row">

                        <!-- Area Chart -->
                        <!-- col-xl-(1-12) is width -->
                        <!-- col-lg-(1-12) also width (just different sizes)-->
                        <!-- should all add up to 12 across columns -->
                        <div class="col-xl-6 col-lg-7">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Code Process</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <p> Merging the hardware interfacing code and the audio synthesis code took a long time. We would run into various issues with different code files interacting in negative ways. For example, there was an issue where the TFT setup function would cause the capacitive touch board to hang if it wasn’t detecting input for the entirety of the TFT setup. This was fixed by decreasing the frequency of the TFT rewriting. </p>
                                    
                                    <p> We had to be extra careful to cross-reference each CMake header file when merging libraries into the main file. </p>
                                    <!-- <div class="chart-area">
                                        <canvas id="myAreaChart"></canvas>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-6 col-lg-7">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Hardware</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <p> The hardware consisted of four-push buttons, a sliding potentiometer, a rotary encoder, headphone jack, DAC, the Pi Pico, wiring, two 1uF capacitors, two 10K resistors, and the TFT display. We also used breadboards to hold the components and interface together as well as metal plates to use as a keyboard with the capacitive touch sensor and breakout board. </p>
                                    
                                    <p> The hardware was chosen to allow for all variables to be modified for one oscillator and to switch though each of the menus and modify their variables. </p>
                                    <!-- <div class="chart-area">
                                        <canvas id="myAreaChart"></canvas>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="row">

                        <!-- Area Chart -->
                        <!-- col-xl-(1-12) is width -->
                        <!-- col-lg-(1-12) also width (just different sizes)-->
                        <!-- should all add up to 12 across columns -->
                        <div class="col-xl-12 col-lg-12">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Construction</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <p> The structure is made of cardboard, breadboards, and hot glue. We cut out three pieces of cardboard to use as a cover for the wiring and hold the TFT in position above the hardware inputs. </p>
                                    
                                    <p> The wiring for the capacitive touch was also glued down to reduce any interference from wiring being moved and accidentally triggering the capacitive touch sensor. Two plates were also added underneath the capacitive touch wire to reduce further interference and strengthen the entire structure. </p>
                                    
                                    <p> The button wiring was made to be flush with the board so right angle degree header pins were used to ensure a good connection. </p>
                                    
                                    <p> The rotary encoder had a 1uF and 10K resistor on the A, C pins to reduce noise that came from turning the knob that caused extra spikes to occur. This circuit came from Haris’s blog found <a href="https://www.candrian.gr/index.php/3-pin-rotary-encoder-how-to/">here</a> and also shows the wave form for the rotary encoder with and without the extra capacitor and resistor. </p>
                                    
                                    <!-- <div class="chart-area">
                                        <canvas id="myAreaChart"></canvas>
                                    </div> -->
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="row">
                    <div class="col-xl-12 col-lg-12">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Wiring Diagram</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <p>A link to the pdf version of this wiring diagram can be found <a href="media/diagram.pdf">here</a>.
                                    </p>
                                    <center><img src="media/wiring.png" alt="Wiring Diagram" style="width:1100px;height:500px;"> </center>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Row -->
                    <div class="row">
                        <div class="col-xl-12 col-lg-12">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Hardware Interfacing</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <p> The Hardware interfacing started with using the VGA to display the text for the oscillator, filter, and low frequency oscillator menus. We then moved the display to the TFT to have everything on one board and make it more portable. The text display consisted of three parts: the text for each menu, the values for each variable, and the indicator for what variable is currently being selected. The TFT display also had its setup initialized similarly to the VGA and placed in its own function, initialize TFT. </p> 

                                    <p> The text for each menu was stored in an 2d array and iterated through using a for loop to avoid hardcoding the places where the text would be. This was a similar process for displaying the values for each menu. The values were stored in a 2d, fix15 array and were printed out so that they were next to the text label. </p>

                                    <p> The menu text was updated only when a different menu was selected to avoid refreshing the TFT display unnecessarily. The values in each menu were only modified if they were updated by the hardware polling and the selector was only changed if the rotary encoder interrupt was turned enough to change the selector’s position. </p>

                                    <p> The TFT display updates and polling for the inputs were based on interrupt timers, so making sure that the interrupts were as short as possible was very important, so reducing unnecessary updates helped speed up other parts of the system, like the capacitive touch interrupt. </p>

                                    <p> We had to add some extra variables to the menu, but this only required adding the variable name to the respective menu text list, extending the storage array for that menu’s variables, and incrementing the size of the variables in that menu, making it very easy to add and remove variables as needed and allowing for new menus or variables to be added if desired. </p>

                                    <p> We had four buttons, 1 rotary encoder, 1 potentiometer slider, and 1 capacitive touch breakout board - and these all needed to be polled and processed by the Pi Pico. </p>

                                    <p> First, these inputs were all set up using a single function to avoid duplication functionality by iterating through a list of pins that needed to be set. The rotary encoder and potentiometer had their own functions and were also set up as well. The ADC was also set up and selected input 0 corresponding to pin 26 where the potentiometer was connected. </p>

                                    <p> The inputs all had their own getters that made it easy to quickly poll a button. Buttons used getButton with the defined name of the button being passed to an array of buttons to easily select the correct pin without needing to know the number and use this key elsewhere when selecting different menus. The rotary encoder had an interrupt that called updateRotaryCounter that checked if rotary encoder pin A was low, and incremented or decremented a tiny counter if the rotary encoder pin b was high or low respectively. This tiny counter would increment or decrement the rotary counter after hitting its max or min to avoid having accidental selection changed if the rotary encoder was bumped and moved. The logic for the rotary encoder was from Haris’s blog that can be found <a href="https://www.candrian.gr/index.php/3-pin-rotary-encoder-how-to/">here</a> </p>

                                    <p> The potentiometer used the ADC in the Pi Pico on GPIO pin 26 to get its value and convert its value to a fix15 to be used by FFT and audio synthesis. </p>

                                    <p> The potentiometer would only modify a value if the last value set and the new value of the potentiometer differed by .05 to avoid setting values by accident when rotating though the different variables with the potentiometer. This also tied in to the TFT interrupt being able to reduce refresh rates for the display. </p>

                                    <p> With all the inputs set up, an interrupt timer was created that would call our function to check the status of all the inputs. </p>

                                    <p> We used a function called getNewHardwareValues to check and poll all inputs to see if the TFT display or variables should be changed. </p>

                                    <p> The first thing checked was if the yellow toggle button was pressed. This button would turn the respective menu’s functionality on and off and was used by the audio synthesis when seeing what should be applied to a waveform. </p>

                                    <p> Next, the three buttons corresponding to the oscillator, filter, and low frequency oscillator were checked. If the button corresponded to the menu currently shown, nothing would be changed, otherwise, the two flags, groupSettingUpdated and numbersUpdated, were set to true so that the TFT display update functions would run. The rotary encoder would also be set to 0 to make sure the first variable is selected in that menu. </p>

                                    <p> The current variable selection is then checked by taking the mod of the current rotary counter value and the number of variables the menu has, with a 1 added to skip over the on/off variable that is only set by the yellow button. Following this, the potentiometer value is polled only if it has been moved more than 5% of its length if a new variable or menu has been selected, otherwise the value is polled as normal and the numbersUpdated flag is set to true to update the numbers.

                                    <p> Wherever a value is set, the current menu and variable is passed to a general function that checks which setter should be used based on the menu being shown and uses its respective setter. Inside this setter, the variable is scaled if needed since the potentiometer returns values from 0 to 1 to simplify scaling. For the type and shape variables that had multiple settings they were selected based on the range of values, like 0 to .25 referring to a different value that from .25 to .5. This made it easy to use the potentiometer for all values, excluding the on/off setting for each menu. </p>

                                    <p> The capacitive touch sensor was separately built and tested from the rest of the input hardware. </p>

                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Content Row -->
                    <div class="row">
                        <div class="col-xl-12 col-lg-12">
                            <div class="card shadow mb-4">
                                <!-- Card Header - Dropdown -->
                                <div
                                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                    <h6 class="m-0 font-weight-bold text-primary">Difficulties</h6>
                                </div>
                                <!-- Card Body -->
                                <div class="card-body mb-2">
                                    <h5>Interrupt + Protothread Conflicts</h5>
                                    <p> Due to the strict timing requirements for DDS, it was done via an interrupt that used a repeating timer callback as its signal. This interrupt was called at 20 KHz, which resulted in us not being able to run protothreads for other functions. Instead, we put those into interrupts of their own which seemed to work well. </p>

                                    <h5>Filter Calculation Speed</h5>
                                    <p> Originally our LFO was doing calculations in the same interrupt as the DDS output. This caused a large amount of lag to the point where the calculations slowed the resulting output wave and we could hear the, for example, curve of a sine wave rather than a high-frequency tone. </p>
                                    <p> This was resolved by moving the LFO into a different interrupt and using a buffer wavetable to allow for the DDS output to switch seamlessly between different filtered wavetables. </p>

                                    <h5>LFO Smoothness</h5>
                                    <p> One of the results of moving the LFO to a different interrupt is that the transitions between filtered waveforms is not as smooth as we would have liked. This is more noticeable with lower frequencies as it becomes easier to detect a step change in the sound. </p>

                                    <h5>Sampling Rate</h5>
                                    <p> The original sampling rate in the base code that we worked with was 40 Khz. We lowered it by half to accommodate for all the calculations and input detecting we were doing. </p>

                                    <h5>Capacitive Touch Sensitivity</h5>
                                    <p> The demo code we built our capacitive touch functions off of was too sensitive for our uses, where it would register a release even when a key was being held down. We pinpointed the issue to the filtered sensor value decreasing over time until it became close to the baseline value, in which case the code detected it as a “release”. This was fixed by tuning the touch and release thresholds by setting the release higher than the touch threshold, bypassing the check entirely. To account for small changes in touch, we added a buffer that would only signal a release when a sequence of releases were sensed rather than signal as soon as a release is detected. This helped for a more consistent user experience when using the touch keys. </p>

                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Last Updated Dec 2022</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

</body>

</html>
