<!DOCTYPE html>
<html lang="en">
<title> | Universal Infrared Remote</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="author" content="Owen Louis and Liam Sweeney">
<meta name="generator" content="Jekyll v4.2.2">
<link rel="canonical" href="appendices/">

<link rel="stylesheet" href="./assets/css/frame.css">

<link rel="alternate" href="./feed.xml" type="application/atom+xml" title="Universal Infrared Remote">







<header>
  <a href="./index.html" class="title">Universal Infrared Remote</a>
  <nav><a href="./design.html" >Design</a><a href="./projectdemo.html" >Demonstration</a><a href="./appendices.html" class="selected">Appendices</a></nav>

</header>

<article>
  <header>
  <h1><a href="appendices.html"></a></h1><time datetime=""></time>
</header>

  <h2 id="appendix-a---permissions">Appendix A - Permissions</h2>

<p>The group approves this report for inclusion on the course website.</p>

<p>The group approves the video for inclusion on the course youtube channel.</p>

<h2 id="appendix-b---commented-code">Appendix B - Commented Code</h2>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Include standard libraries</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span><span class="c1">// Include Pico libraries</span>
<span class="cp">#include</span> <span class="cpf">"pico/stdlib.h"</span><span class="cp">
#include</span> <span class="cpf">"pico/divider.h"</span><span class="cp">
#include</span> <span class="cpf">"pico/multicore.h"</span><span class="cp">
#include</span> <span class="cpf">"pico/binary_info.h"</span><span class="cp">
</span><span class="c1">// Include hardware libraries</span>
<span class="cp">#include</span> <span class="cpf">"hardware/spi.h"</span><span class="cp">
#include</span> <span class="cpf">"hardware/gpio.h"</span><span class="cp">
</span><span class="c1">// Include protothreads</span>
<span class="cp">#include</span> <span class="cpf">"pt_cornell_rp2040_v1.h"</span><span class="cp">
</span><span class="c1">// Include LCD libraries</span>
<span class="cp">#include</span> <span class="cpf">"DEV_Config.h"</span><span class="cp">
#include</span> <span class="cpf">"GUI_Paint.h"</span><span class="cp">
#include</span> <span class="cpf">"Debug.h"</span><span class="cp">
#include</span> <span class="cpf">"Infrared.h"</span><span class="cp">
#include</span> <span class="cpf">"LCD_1in14.h"</span><span class="cp">
#include</span> <span class="cpf">"fonts.h"</span><span class="cp">
</span><span class="c1">// Include SD card third party library</span>
<span class="cp">#include</span> <span class="cpf">"sd_card.h"</span><span class="cp">
#include</span> <span class="cpf">"ff.h"</span><span class="cp">
</span>
<span class="c1">// GPIO pins for the LCD screen</span>
<span class="kt">uint8_t</span> <span class="n">keyA</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> 
<span class="kt">uint8_t</span> <span class="n">keyB</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span> 
<span class="kt">uint8_t</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// originally up</span>
<span class="kt">uint8_t</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span> <span class="c1">// originally dowm</span>
<span class="kt">uint8_t</span> <span class="n">dowm</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="c1">// originally left</span>
<span class="kt">uint8_t</span> <span class="n">up</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">// originally right</span>
<span class="kt">uint8_t</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="c1">// Variables for the UI</span>
<span class="cp">#define MAX_LABEL_CHAR_SIZE 15
#define MAX_BUTTON_PAIRING 8
#define MAX_REMOTE_SIZE 10
</span>
<span class="kt">int</span> <span class="n">numDevices</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice0</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice1</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice3</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice4</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">numButtonsDevice9</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">char</span> <span class="n">devices</span><span class="p">[</span><span class="n">MAX_REMOTE_SIZE</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">nullDevices</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev0Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev1Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev2Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev3Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev4Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev5Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev6Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev7Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev8Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">dev9Buttons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">nullButtons</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>


<span class="kt">int</span> <span class="n">windowTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">selectedItem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">displayState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">selectedSlot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">selectedDevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">UWORD</span> <span class="o">*</span><span class="n">BlackImage</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">saveData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="cp">#define MAX_SIGNAL_SIZE 99
#define INPUT_IR_TIMEOUT_WINDOW_MS 500
</span>
<span class="cp">#define IR_LED_PIN 21
#define IR_RECEIVER_PIN 19
</span>
<span class="n">bool</span> <span class="k">volatile</span> <span class="n">recieved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// Flag communicating fully recieved and encoded signal from reciever processor to Serial interface FSM</span>

<span class="n">alarm_id_t</span> <span class="n">timeout</span><span class="p">;</span> <span class="c1">// Timeout to detect end of reading signal</span>

<span class="cp">#define MAX_DATA_SIZE 400
</span><span class="kt">uint32_t</span> <span class="n">edges</span><span class="p">[</span><span class="n">MAX_SIGNAL_SIZE</span><span class="p">];</span>
<span class="c1">// edges stores every rising and falling edge time index</span>
<span class="c1">// Due to binary nature of communication, will always guarentee toggle at each index</span>
<span class="c1">// Index 0: Not a timestamp, rather an entry dictating the valid tail of the data structure</span>
<span class="kt">uint32_t</span> <span class="n">dataArr</span><span class="p">[</span><span class="n">MAX_SIGNAL_SIZE</span><span class="p">];</span>

<span class="c1">// Structs that Liam uses to manipulate the buttons and remotes</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">button</span><span class="p">{</span>
  <span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
  <span class="kt">uint32_t</span> <span class="n">signal</span><span class="p">[</span><span class="n">MAX_SIGNAL_SIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">button</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">remote</span><span class="p">{</span>
  <span class="n">bool</span> <span class="n">valid</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
  <span class="n">button</span> <span class="n">linkedButtons</span><span class="p">[</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">];</span>
<span class="p">}</span> <span class="n">remote</span><span class="p">;</span>

<span class="n">remote</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">MAX_REMOTE_SIZE</span><span class="p">];</span>

<span class="k">volatile</span> <span class="k">static</span> <span class="kt">int</span> <span class="n">runSerialInterface</span><span class="p">;</span>


<span class="n">absolute_time_t</span> <span class="n">timeoutWindow</span><span class="p">;</span> <span class="c1">//Manually induce secondary timer window</span>

<span class="c1">//////////////////////////////////</span>
<span class="c1">//      Reproduce Signal        //</span>
<span class="c1">//////////////////////////////////</span>
<span class="c1">//Note: Must be function call to prevent ISR-ISR locks</span>
<span class="kt">void</span> <span class="nf">broadcast_IR</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span> <span class="n">edgeFlip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gpio_put</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// Make sure the system starts in a non-broadcasting state (LED Off)</span>
    <span class="n">sleep_ms</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">//Delay to make sure no accidental edge of the system</span>
    <span class="k">if</span><span class="p">(</span><span class="n">edgeFlip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_SIGNAL_SIZE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: OUT OF BOUNDS</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">edgeFlip</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//May need to implement instruction-execution-time bit-hacking</span>
        <span class="n">sleep_us</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">edgeFlip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="c1">//Wait specified interval</span>
        <span class="n">gpio_put</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">,</span> <span class="o">!</span><span class="n">gpio_get</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">))</span> <span class="p">;</span> <span class="c1">//Toggle to create edge</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="c1">// ==================================================</span>
<span class="c1">// === String array assignment method for 2d arrays</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">string2DArrayEquals</span><span class="p">(</span><span class="kt">int</span> <span class="n">firstIndex</span><span class="p">,</span> <span class="kt">char</span> <span class="n">firstArray</span><span class="p">[][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">],</span> <span class="kt">char</span> <span class="n">secondArray</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">]){</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">index</span> <span class="o">++</span><span class="p">){</span>
    <span class="n">firstArray</span><span class="p">[</span><span class="n">firstIndex</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondArray</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ==================================================</span>
<span class="c1">// === String array assignment method for 2d arrays</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">string1DArrayEquals</span><span class="p">(</span><span class="kt">char</span> <span class="n">firstArray</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">],</span> <span class="kt">char</span> <span class="n">secondArray</span><span class="p">[</span><span class="n">MAX_SIGNAL_SIZE</span><span class="p">]){</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">index</span> <span class="o">++</span><span class="p">){</span>
    <span class="n">firstArray</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondArray</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// ==================================================</span>
<span class="c1">// === String array assignment method for 2d arrays</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">string1DArrayEqualsBuf</span><span class="p">(</span><span class="kt">char</span> <span class="n">firstArray</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="kt">char</span> <span class="n">secondArray</span><span class="p">[</span><span class="mi">50</span><span class="p">]){</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">index</span> <span class="o">++</span><span class="p">){</span>
    <span class="n">firstArray</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">secondArray</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// ==================================================</span>
<span class="c1">// === Convert Liams data to Owens data types</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">convertData</span><span class="p">(){</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">ra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// Make all entries null in case of a removed remote</span>
  <span class="k">for</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">){</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">nullDevices</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
    <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">,</span> <span class="n">nullButtons</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="c1">// Parse remotes and their buttons into the arrays</span>
  <span class="k">for</span><span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">valid</span><span class="p">){</span>
      <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
      <span class="c1">// Extract buttons from remote's buttons</span>
      <span class="k">for</span><span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">valid</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">2</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">3</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">4</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">5</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">6</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">7</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">8</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">9</span><span class="p">){</span>
            <span class="n">string2DArrayEquals</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="c1">// Increment actual button number</span>
          <span class="n">ba</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
          <span class="n">numButtonsDevice0</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
          <span class="n">numButtonsDevice1</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">2</span><span class="p">){</span>
          <span class="n">numButtonsDevice2</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">3</span><span class="p">){</span>
          <span class="n">numButtonsDevice3</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">4</span><span class="p">){</span>
          <span class="n">numButtonsDevice4</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">5</span><span class="p">){</span>
          <span class="n">numButtonsDevice5</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">6</span><span class="p">){</span>
          <span class="n">numButtonsDevice6</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">7</span><span class="p">){</span>
          <span class="n">numButtonsDevice7</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">8</span><span class="p">){</span>
          <span class="n">numButtonsDevice8</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ra</span><span class="o">==</span><span class="mi">9</span><span class="p">){</span>
          <span class="n">numButtonsDevice9</span> <span class="o">=</span> <span class="n">ba</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">ba</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="c1">// Increment actual device number</span>
      <span class="n">ra</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">numDevices</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">ra</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="c1">// ==================================================</span>
<span class="c1">// === Highlight the correct item</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">highlightSelection</span><span class="p">(){</span>
  <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="c1">// Display the correct line</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="c1">// Erase the other lines</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="c1">// Display the correct line</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="c1">// Erase the other lines</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
    <span class="c1">// Display the correct line</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="c1">// Erase the other lines</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
    <span class="c1">// Display the correct line</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="c1">// Erase the other lines</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
    <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// ==================================================</span>
<span class="c1">// === Scroll to the correct item</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">scroll</span><span class="p">(</span><span class="kt">int</span> <span class="n">buttonPressed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numItems</span><span class="p">){</span>
    <span class="c1">// Determine the button pressed and update it</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span> <span class="c1">//If up, subtract unless you would go below zero</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedItem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">selectedItem</span> <span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">selectedSlot</span> <span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span> <span class="c1">//If down, add unless you go above number of things</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedItem</span> <span class="o">&lt;</span> <span class="n">numItems</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">selectedItem</span> <span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedSlot</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">){</span>
        <span class="n">selectedSlot</span> <span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Handle scrolling too far down or up</span>
    <span class="k">if</span><span class="p">(</span><span class="n">selectedItem</span> <span class="o">&gt;</span> <span class="n">windowTop</span> <span class="o">+</span> <span class="mi">3</span><span class="p">){</span>
      <span class="n">windowTop</span> <span class="o">++</span><span class="p">;</span>
      <span class="n">selectedSlot</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedItem</span> <span class="o">&lt;</span> <span class="n">windowTop</span><span class="p">){</span>
      <span class="n">windowTop</span> <span class="o">--</span><span class="p">;</span>
      <span class="n">selectedSlot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> 
<span class="p">}</span>

<span class="c1">// ==================================================</span>
<span class="c1">// === Run any menu</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">displayMenu</span><span class="p">(</span><span class="kt">int</span> <span class="n">numItems</span><span class="p">,</span> <span class="kt">char</span> <span class="n">items</span><span class="p">[][</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">buttonPressed</span><span class="p">){</span>
  <span class="c1">// ================= ERASE OLD LABELS</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>

  <span class="c1">// ================= DISPLAY THE SCROLLING</span>
  <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
    <span class="n">scroll</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">numItems</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
    <span class="n">scroll</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">numItems</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// ================= DISPLAY THE SELECTION LINE</span>
  <span class="n">highlightSelection</span><span class="p">();</span>

  <span class="c1">// ================= DISPLAY THE SELECTIONS</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>

  <span class="c1">// ================= ERASE AGAIN</span>
  <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">7</span><span class="p">){</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
  <span class="p">}</span>


<span class="p">}</span>

<span class="c1">// ==================================================</span>
<span class="c1">// === Dispaly the correct item</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">refreshDisplay</span><span class="p">(</span><span class="kt">int</span> <span class="n">buttonPressed</span><span class="p">){</span>
  <span class="c1">// Button 0 = A</span>
  <span class="c1">// Button 1 = B</span>
  <span class="c1">// Button 2 = up</span>
  <span class="c1">// Button 3 = down</span>
  <span class="c1">// Button 4 = left</span>
  <span class="c1">// Button 5 = right</span>
  <span class="c1">// Button 6 = center</span>


  <span class="c1">// Draw the menu lines</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="c1">// Draw header</span>
  <span class="n">Paint_DrawRectangle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span><span class="n">DRAW_FILL_FULL</span><span class="p">);</span>
  <span class="n">Paint_DrawRectangle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span><span class="n">DRAW_FILL_EMPTY</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">"Choose a"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>


  <span class="c1">// ================= START SERIAL INTERFACE 'B'</span>
  <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="n">Paint_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
    <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
    <span class="c1">// width 14 of char</span>
    <span class="c1">// width of display</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s">"Running"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="s">"Serial"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="s">"Interface"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>

    <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
    <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">displayState</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//Wipe the screen</span>
    <span class="n">displayState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">convertData</span><span class="p">();</span>
    <span class="n">Paint_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
    <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">convertData</span><span class="p">()</span> <span class="p">;</span>
  <span class="p">}</span>


  <span class="c1">// STATE 0 = CHOOSE THE DEVICE</span>
  <span class="k">if</span><span class="p">(</span><span class="n">displayState</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="c1">// ================= SETUP HEADER</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Remote"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>

    <span class="c1">// ================= DISPLAY MENU</span>
    <span class="n">displayMenu</span><span class="p">(</span><span class="n">numDevices</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>



    <span class="c1">// ================= GO TO NEXT MENU IF CENTER PRESSED</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
      <span class="c1">// Increment display state</span>
      <span class="n">displayState</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="c1">// Set selected device</span>
      <span class="n">selectedDevice</span> <span class="o">=</span> <span class="n">selectedItem</span><span class="p">;</span>
      <span class="c1">// Reset menu variables</span>
      <span class="n">selectedSlot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">selectedItem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// Erase old menu items</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="n">devices</span><span class="p">[</span><span class="n">windowTop</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">devices</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">devices</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">65</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">devices</span><span class="p">[</span><span class="n">windowTop</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Font16</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
      <span class="c1">// Erase old header and make new one</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Remote"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">);</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Button"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
      <span class="c1">// Pre display the menu</span>
      <span class="n">windowTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice0</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice1</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice2</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice3</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice4</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice5</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">6</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice6</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">7</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice7</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">8</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice8</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">9</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice9</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
      <span class="p">}</span> 
    <span class="p">}</span>


  <span class="c1">// STATE 1 = CHOOSE THE BUTTON</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">displayState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
    <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Button"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice0</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice1</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice2</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice3</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice4</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice5</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">6</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice6</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">7</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice7</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">8</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice8</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">9</span><span class="p">){</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice9</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="c1">// ================= BROADCAST BUTTON 'A'</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="c1">// TODO: add broadcast implementation here</span>
      <span class="c1">// First: Find the correct remote from Liams data type</span>
      <span class="c1">// Second: Find the correct button from Liams data type</span>
      <span class="c1">// Third: Send the broadcast method the correct array</span>
      <span class="k">static</span> <span class="n">remote</span> <span class="n">deviceToBroadcast</span><span class="p">;</span>
      <span class="k">static</span> <span class="n">button</span> <span class="n">buttonToBroadcast</span><span class="p">;</span>
      <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// First:</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">devices</span><span class="p">[</span><span class="n">selectedDevice</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
          <span class="n">deviceToBroadcast</span> <span class="o">=</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// Second:</span>
      <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>        
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">6</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">7</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">8</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">9</span><span class="p">){</span>
          <span class="k">if</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">[</span><span class="n">selectedItem</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">buttonToBroadcast</span> <span class="o">=</span> <span class="n">deviceToBroadcast</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>  
        <span class="p">}</span> 
      <span class="p">}</span>
      <span class="c1">// Third:</span>
      <span class="n">broadcast_IR</span><span class="p">(</span><span class="n">buttonToBroadcast</span><span class="p">.</span><span class="n">signal</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ================= BACK BUTTON</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buttonPressed</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
      <span class="c1">// ================= ERASE OLD MENU</span>
      <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice0</span><span class="p">,</span> <span class="n">dev0Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice1</span><span class="p">,</span> <span class="n">dev1Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice2</span><span class="p">,</span> <span class="n">dev2Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice3</span><span class="p">,</span> <span class="n">dev3Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice4</span><span class="p">,</span> <span class="n">dev4Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">5</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice5</span><span class="p">,</span> <span class="n">dev5Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">6</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice6</span><span class="p">,</span> <span class="n">dev6Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">7</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice7</span><span class="p">,</span> <span class="n">dev7Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">8</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice8</span><span class="p">,</span> <span class="n">dev8Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">selectedDevice</span> <span class="o">==</span> <span class="mi">9</span><span class="p">){</span>
        <span class="n">displayMenu</span><span class="p">(</span><span class="n">numButtonsDevice9</span><span class="p">,</span> <span class="n">dev9Buttons</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
      <span class="p">}</span> 
      <span class="c1">// Erase old header and make new one</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Button"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">,</span> <span class="n">BLUE</span><span class="p">);</span>
      <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="s">"Remote"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
      <span class="c1">// Increment display state</span>
      <span class="n">displayState</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// Set selected device</span>
      <span class="n">selectedDevice</span> <span class="o">=</span> <span class="n">selectedItem</span><span class="p">;</span>
      <span class="c1">// Reset menu variables</span>
      <span class="n">selectedSlot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">selectedItem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">windowTop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// ================= DISPLAY MENU</span>
      <span class="n">displayMenu</span><span class="p">(</span><span class="n">numDevices</span><span class="p">,</span> <span class="n">devices</span><span class="p">,</span> <span class="n">buttonPressed</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>


<span class="p">}</span>


<span class="c1">// ==================================================</span>
<span class="c1">// === Eliminates invisible characters from a string</span>
<span class="c1">// ==================================================</span>
<span class="kt">char</span> <span class="o">*</span> <span class="nf">eliminateInvisibleChars</span><span class="p">(</span><span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">50</span><span class="p">]){</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">){</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">// ==================================================</span>
<span class="c1">// === Reads the structs from the SD card</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">readFromSD</span><span class="p">(){</span>
  <span class="k">static</span> <span class="n">FRESULT</span> <span class="n">fr</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">FATFS</span> <span class="n">fs</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">FIL</span> <span class="n">fil</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"remote_data.txt"</span><span class="p">;</span>

  <span class="k">static</span> <span class="kt">int</span> <span class="n">remoteNumber</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">buttonNumber</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">signalNumber</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">previousItem</span><span class="p">;</span> <span class="c1">// 0=remote, 1=button, 2=signal</span>
  <span class="n">remoteNumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">buttonNumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">previousItem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">signalNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="c1">// Initialize SD card</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_init_driver</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not initialize SD card</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Mount drive</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_mount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="p">,</span> <span class="s">"0:"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not mount filesystem (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Open file for reading</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">FA_READ</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not open file (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Print every line in file over serial</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Reading from file '%s':</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">f_gets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fil</span><span class="p">))</span> <span class="p">{</span>
       
      <span class="n">string1DArrayEqualsBuf</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eliminateInvisibleChars</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

      <span class="c1">// If the line is "remote" then the next thing is a remote name</span>
      <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"remote"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">previousItem</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">previousItem</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Buf : %s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">f_gets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fil</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Buf 2: %s"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">string1DArrayEqualsBuf</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eliminateInvisibleChars</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">remoteNumber</span> <span class="o">++</span><span class="p">;</span>
        <span class="n">string1DArrayEquals</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">Remote: %s, RemoteNumber %d, Buffer, %s"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">remoteNumber</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">previousItem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">buttonNumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="c1">// If the line is "button" then the next thing is a button name</span>
      <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"button"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">previousItem</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">previousItem</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)){</span>
        <span class="n">f_gets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fil</span><span class="p">);</span>
        <span class="n">string1DArrayEqualsBuf</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eliminateInvisibleChars</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="n">buttonNumber</span> <span class="o">++</span><span class="p">;</span>
        <span class="n">string1DArrayEquals</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonNumber</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonNumber</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">Button: %s, ButtonNumber %d, RemoteNumber %d, Buffer, %s"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonNumber</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">buttonNumber</span><span class="p">,</span> <span class="n">remoteNumber</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
        <span class="n">previousItem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span><span class="c1">// If the line is "signal" then the next thing is a signal</span>
      <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"signal"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">previousItem</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">signalNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">signalNumber</span> <span class="o">&lt;</span> <span class="n">MAX_SIGNAL_SIZE</span><span class="p">;</span> <span class="n">signalNumber</span><span class="o">++</span><span class="p">){</span>
          <span class="n">f_gets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fil</span><span class="p">);</span>
          <span class="n">string1DArrayEqualsBuf</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">eliminateInvisibleChars</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
          <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteNumber</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonNumber</span><span class="p">].</span><span class="n">signal</span><span class="p">[</span><span class="n">signalNumber</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
          <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">Int version of the string: %d"</span><span class="p">,</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="n">previousItem</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">---</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>

  <span class="c1">// Close file</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not close file (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Unmount drive</span>
  <span class="n">f_unmount</span><span class="p">(</span><span class="s">"0:"</span><span class="p">);</span>

<span class="p">}</span>

<span class="c1">// ==================================================</span>
<span class="c1">// === Writes the structs to the SD card</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">writeToSD</span><span class="p">(){</span>
  <span class="k">static</span> <span class="n">FRESULT</span> <span class="n">fr</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">FATFS</span> <span class="n">fs</span><span class="p">;</span>
  <span class="k">static</span> <span class="n">FIL</span> <span class="n">fil</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">filename</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"remote_data.txt"</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

  <span class="c1">// Initialize SD card</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_init_driver</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not initialize SD card</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Mount drive</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_mount</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fs</span><span class="p">,</span> <span class="s">"0:"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not mount filesystem (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Open file for writing ()</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">FA_WRITE</span> <span class="o">|</span> <span class="n">FA_CREATE_ALWAYS</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not open file (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// =========== BEGIN WIRITNG STRUCTS</span>
  <span class="c1">// Run through every remote</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="c1">// If the remote is valid: print "remote" and then the name</span>
    <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">){</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"remote</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>  <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
      <span class="c1">// Run through all buttons</span>
      <span class="k">for</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">b</span><span class="o">&lt;</span><span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">b</span><span class="o">++</span><span class="p">){</span>
        <span class="c1">// If the button is valid: print "button" and then the name</span>
        <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">valid</span><span class="p">){</span>
          <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"button</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
          <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
          <span class="c1">// After name print "signal" and then the whole signal</span>
          <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"signal</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">for</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">s</span><span class="o">&lt;</span><span class="n">MAX_SIGNAL_SIZE</span><span class="p">;</span> <span class="n">s</span><span class="o">++</span><span class="p">){</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">f_printf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">,</span> <span class="s">"%d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">b</span><span class="p">].</span><span class="n">signal</span><span class="p">[</span><span class="n">s</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>
  <span class="c1">// Close file</span>
  <span class="n">fr</span> <span class="o">=</span> <span class="n">f_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fil</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">!=</span> <span class="n">FR_OK</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ERROR: Could not close file (%d)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fr</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Unmount drive</span>
  <span class="n">f_unmount</span><span class="p">(</span><span class="s">"0:"</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"FINISHED WRITING TO SD</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//////////////////////////////////////////</span>
<span class="c1">//  Testing Method, Not used in runtime //</span>
<span class="c1">//////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">initRemoteData</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">//////////////////////////////////////</span>
<span class="c1">//  Differentiate relative timings  //</span>
<span class="c1">//////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">encode</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">baseTime</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="c1">//TODO: Save entry by subtracting up, so no empty edges[1]?</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="c1">//////////////////////////////////////////////</span>
<span class="c1">//  Partner method for encapsle_button_ISR  //</span>
<span class="c1">//  (See info below)                        //</span>
<span class="c1">//////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">encapsle_button</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">edgeFlip</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">encode</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tail</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dest</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">edgeFlip</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">edgeFlip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">//////////////////////////////////////////////////</span>
<span class="c1">//  Runs encoding and transfer of data from     //</span>
<span class="c1">//  temp edges[] to more permenant dataArr[]    //</span>
<span class="c1">//  for storage once end of signal is detected  //</span>
<span class="c1">//////////////////////////////////////////////////</span>
<span class="c1">//Note: Can merge with encapsle button method </span>
<span class="c1">//if/once able to pass args into ISR</span>
<span class="n">alarm_callback_t</span> <span class="nf">encapsle_button_ISR</span><span class="p">()</span>  <span class="p">{</span>
    
    <span class="c1">// Guard against dummy timeout triggers</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">recieved</span> <span class="o">&amp;&amp;</span> <span class="n">time_reached</span><span class="p">(</span><span class="n">timeoutWindow</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">TIMEOUT TRIG"</span><span class="p">);</span>
        <span class="n">encapsle_button</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">dataArr</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">EXIT TIMEOUT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">add_alarm_in_ms</span><span class="p">(</span><span class="mi">9999999</span><span class="p">,</span> <span class="n">encapsle_button_ISR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="c1">//Reset dummy timer</span>
        <span class="n">recieved</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="c1">//////////////////////////////////////////////////</span>
<span class="c1">//  Detects and logs rising/falling edges of    //</span>
<span class="c1">//  signal.  Handles as an ISR.  Sampling ended //</span>
<span class="c1">//  via encapsle_button_ISR() timeout           //</span>
<span class="c1">//////////////////////////////////////////////////</span>
<span class="kt">void</span> <span class="nf">gpio_log</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">&lt;</span> <span class="n">MAX_DATA_SIZE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//PLACE BACK TO MAX DATA SIZE ONCE FINISHED</span>
        <span class="n">edges</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_us_32</span><span class="p">();</span>
        
        
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cancel_alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">WARN: Timeout fault</span><span class="se">\n\n\n\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">add_alarm_in_ms</span><span class="p">(</span><span class="n">INPUT_IR_TIMEOUT_WINDOW_MS</span><span class="p">,</span> <span class="n">encapsle_button_ISR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">WARN: Timeout failed to create</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="n">timeoutWindow</span> <span class="o">=</span> <span class="n">make_timeout_time_us</span><span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">INPUT_IR_TIMEOUT_WINDOW_MS</span><span class="p">);</span>
        
        <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//Increment array size</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\r</span><span class="s">ERROR: OUT OF BOUNDS</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_DATA_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="k">static</span> <span class="nf">PT_THREAD</span> <span class="p">(</span><span class="n">protothread_core_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt</span> <span class="o">*</span><span class="n">pt</span><span class="p">))</span>
<span class="p">{</span>
  <span class="c1">// Indicate thread beginning</span>
  <span class="n">PT_BEGIN</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span> <span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">user_input_int</span><span class="p">,</span> <span class="n">user_input_temp_int</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">remoteIndex</span><span class="p">,</span> <span class="n">buttonIndex</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">user_input_string</span><span class="p">[</span>
    <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="o">*</span><span class="mi">4</span><span class="p">];</span> <span class="c1">//Expand further to mitigate accidental overflows, truncate input</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="n">trunc_string</span><span class="p">[</span><span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">];</span>
  

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      
    <span class="nl">top:</span>

    <span class="n">PT_YIELD_usec</span><span class="p">(</span><span class="mi">300000</span><span class="p">);</span>
    <span class="n">PT_YIELD_UNTIL</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">runSerialInterface</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
      
    <span class="k">if</span><span class="p">(</span><span class="n">runSerialInterface</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
      <span class="n">user_input_int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="n">user_input_int</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">user_input_int</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">user_input_int</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\r</span><span class="s">Would you not like to (1) Add a button? (2) Remove a button? (3) Remove Remote</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span> <span class="c1">//TODO: Add option to remove remotes? (Implicit add remote via add button)</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="n">serial_read</span><span class="p">;</span>
          <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_int</span><span class="p">);</span>
      <span class="p">}</span>


      <span class="c1">//////////////////</span>
      <span class="c1">//  Add Button  //</span>
      <span class="c1">//////////////////</span>
      <span class="k">if</span><span class="p">(</span><span class="n">user_input_int</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>


          <span class="n">remoteIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>



          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Please enter a name for your remote</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Or insert a new name to create one.</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>


          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Valid entries include:</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">" - %s</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
              <span class="p">}</span>
          
          <span class="p">}</span>
          <span class="n">serial_read</span><span class="p">;</span>
          <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_string</span><span class="p">);</span>
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">REC: %s</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Ensures no name conflict</span>
              <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span>
                  <span class="n">strcmp</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Slot found: %d</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">remoteIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="c1">// Found remote with same namespace</span>
          <span class="k">if</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Found matching remote name!</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">remoteIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                      <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                      <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Destructively uses i due to break afterwards</span>
                          <span class="c1">//TODO: Verify Trunc size to save single index</span>
                          <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                      <span class="p">}</span>

                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">ERROR: No spare slot found.  EXITING...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>

                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="c1">//////////////////////////</span>
          <span class="c1">//  Remote designated   //</span>
          <span class="c1">//  Cont. adding button //</span>
          <span class="c1">//////////////////////////</span>

          <span class="k">struct</span> <span class="n">remote</span> <span class="n">remoteInst</span> <span class="o">=</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">];</span>
          <span class="n">buttonIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Insert button name:</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>

          <span class="n">serial_read</span><span class="p">;</span>
          <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_string</span><span class="p">);</span>
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="c1">//Search for matching button</span>
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span>
                  <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">)))</span> <span class="p">{</span>
                  <span class="n">buttonIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="k">if</span><span class="p">(</span><span class="n">buttonIndex</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">while</span><span class="p">(</span><span class="n">user_input_int</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">user_input_int</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Found matching button name.  Override? (1) Yes (2) No</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">serial_read</span><span class="p">;</span>
                  <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%d"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_int</span><span class="p">);</span>
              <span class="p">}</span>

              <span class="c1">// Nothing needs to be done if overriding, skip to abort protocol</span>
              <span class="k">if</span><span class="p">(</span><span class="n">user_input_int</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Cancelling...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span> <span class="c1">// Bad input, return to top of processing</span>
              <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="c1">//Find available namespace</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">buttonIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="c1">//No namespace available</span>
              <span class="k">if</span><span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">ERROR: No available button space on remote</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Aborting...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="c1">//////////////////////////</span>
          <span class="c1">//  Button Designated   //</span>
          <span class="c1">//  Cont. Setting up    //</span>
          <span class="c1">//////////////////////////</span>

          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Ready to detect button signal...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="n">recieved</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="c1">// Enables detection of reading IR signal edges to encode</span>
          <span class="n">gpio_set_irq_enabled</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">,</span> <span class="n">GPIO_IRQ_EDGE_RISE</span> <span class="o">|</span> <span class="n">GPIO_IRQ_EDGE_FALL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

          <span class="n">PT_YIELD_UNTIL</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">recieved</span><span class="p">);</span> <span class="c1">//Handshake variable that signal got received</span>

          <span class="c1">//... And disable detection now that the process is finished</span>
          <span class="n">gpio_set_irq_enabled</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">,</span> <span class="n">GPIO_IRQ_EDGE_RISE</span> <span class="o">|</span> <span class="n">GPIO_IRQ_EDGE_FALL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

          <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonIndex</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Signal recieved!</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>


          
          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonIndex</span><span class="p">].</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SIGNAL_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonIndex</span><span class="p">].</span><span class="n">signal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataArr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Button set!</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="c1">// Wipe screen and go up to refresh display properly</span>
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span> 
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> 
          <span class="n">saveData</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>



      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_input_int</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">//////////////////</span>
          <span class="c1">//  Rem Button  //</span>
          <span class="c1">//////////////////</span>
          <span class="n">remoteIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">while</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Please enter a name for your remote (q to quit)</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Valid entries include:</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">" - %s</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
                      <span class="n">serial_write</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>


              <span class="n">serial_read</span><span class="p">;</span>
              <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_string</span><span class="p">);</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">trunc_string</span><span class="p">,</span> <span class="s">"q"</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Exiting...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
              <span class="p">}</span>

              
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span>
                      <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">)))</span> <span class="p">{</span>
                      <span class="n">remoteIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">ERROR: Remote name not found</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>

          <span class="k">struct</span> <span class="n">remote</span> <span class="n">remoteInst</span> <span class="o">=</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">];</span>
          <span class="n">buttonIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

          <span class="k">while</span><span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Insert button name (q to quit):</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Valid entries include:</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">" - %s</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
                      <span class="n">serial_write</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>


              <span class="n">serial_read</span><span class="p">;</span>
              <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_string</span><span class="p">);</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">trunc_string</span><span class="p">,</span> <span class="s">"q"</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Exiting...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
              <span class="p">}</span>

              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span>
                      <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">remoteInst</span><span class="p">.</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">)))</span> <span class="p">{</span>
                      <span class="n">buttonIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="n">buttonIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">ERROR: Button name not found</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>


          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Button found, deleting...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>

          <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">buttonIndex</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Button deleted!</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>
          <span class="c1">// Wipe screen and go up to refresh display properly</span>
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span> 
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> 
          <span class="n">saveData</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">user_input_int</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>

          <span class="c1">//////////////////</span>
          <span class="c1">//  Rem Remote  //</span>
          <span class="c1">//////////////////</span>
          <span class="n">remoteIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">while</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Please enter a name for your remote (q to quit)</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Valid entries include:</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
              <span class="n">serial_write</span><span class="p">;</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">" - %s</span><span class="se">\n\r</span><span class="s">"</span><span class="p">,</span> <span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
                      <span class="n">serial_write</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>


              <span class="n">serial_read</span><span class="p">;</span>
              <span class="n">sscanf</span><span class="p">(</span><span class="n">pt_serial_in_buffer</span><span class="p">,</span><span class="s">"%s"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user_input_string</span><span class="p">);</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LABEL_CHAR_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">trunc_string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_input_string</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">trunc_string</span><span class="p">,</span> <span class="s">"q"</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Exiting...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
                  <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>
              <span class="p">}</span>

              <span class="c1">// Locate match</span>
              <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_REMOTE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">&amp;&amp;</span>
                      <span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">remoteData</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">trunc_string</span><span class="p">)))</span> <span class="p">{</span>
                      <span class="n">remoteIndex</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                      <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
              <span class="p">}</span>

              <span class="k">if</span><span class="p">(</span><span class="n">remoteIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">ERROR: Remote name not found</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
                  <span class="n">serial_write</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Remote found, deleting data...</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>

          <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BUTTON_PAIRING</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">linkedButtons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="n">remoteData</span><span class="p">[</span><span class="n">remoteIndex</span><span class="p">].</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

          <span class="c1">// Wipe screen and go up to refresh display properly</span>
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span> 
          <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> 
          <span class="n">sprintf</span><span class="p">(</span><span class="n">pt_serial_out_buffer</span><span class="p">,</span> <span class="s">"</span><span class="se">\r</span><span class="s">Remote data deleted!</span><span class="se">\n\r</span><span class="s">"</span><span class="p">);</span>
          <span class="n">serial_write</span><span class="p">;</span>

          <span class="n">saveData</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">runSerialInterface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

          <span class="k">goto</span> <span class="n">top</span><span class="p">;</span>


      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"GOT OUT OF THE WHILE LOOP SOMEHOW"</span><span class="p">);</span>
  <span class="n">PT_END</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>



<span class="c1">// ==================================================</span>
<span class="c1">// === Run the Boot sequence for the LCD</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">bootDisplay</span><span class="p">(){</span>
  <span class="n">DEV_Delay_ms</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Module_Init</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span> <span class="c1">// Crash</span>
  <span class="p">}</span>

  <span class="n">DEV_SET_PWM</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  <span class="c1">// LCD Init</span>
  <span class="n">LCD_1IN14_Init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//0=horizontal, 1=vertical</span>
  <span class="n">LCD_1IN14_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span> 


  <span class="n">UDOUBLE</span> <span class="n">Imagesize</span> <span class="o">=</span> <span class="n">LCD_1IN14_HEIGHT</span><span class="o">*</span><span class="n">LCD_1IN14_WIDTH</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
  <span class="k">if</span><span class="p">((</span><span class="n">BlackImage</span> <span class="o">=</span> <span class="p">(</span><span class="n">UWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">Imagesize</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to apply for black memory...</span><span class="se">\r\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Create a new image cache named IMAGE_RGB and fill it with white</span>
  <span class="n">Paint_NewImage</span><span class="p">((</span><span class="n">UBYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">BlackImage</span><span class="p">,</span><span class="n">LCD_1IN14</span><span class="p">.</span><span class="n">WIDTH</span><span class="p">,</span><span class="n">LCD_1IN14</span><span class="p">.</span><span class="n">HEIGHT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">);</span>
  <span class="n">Paint_SetScale</span><span class="p">(</span><span class="mi">65</span><span class="p">);</span>
  <span class="n">Paint_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
  <span class="n">Paint_SetRotate</span><span class="p">(</span><span class="n">ROTATE_180</span><span class="p">);</span>
  <span class="n">Paint_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>

  <span class="c1">// Display boot-up screen</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="s">"Universal"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="s">"Remote"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font20</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span>
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="s">"ECE 4760"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font12</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span> 
  <span class="n">Paint_DrawString_EN</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="s">"ocl6 &amp; lms445"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Font12</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">);</span> 

  <span class="c1">// Refresh the picture in RAM to LCD</span>
  <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
  <span class="n">DEV_Delay_ms</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>



  <span class="c1">// Set backlight to 100% brightness</span>
  <span class="n">DEV_SET_PWM</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="c1">// Assign display pins</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">keyA</span><span class="p">);</span>    
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">keyB</span><span class="p">);</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">up</span><span class="p">);</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">dowm</span><span class="p">);</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
  <span class="n">SET_Infrared_PIN</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
  <span class="c1">// Wipe the screen</span>
  <span class="n">Paint_Clear</span><span class="p">(</span><span class="n">WHITE</span><span class="p">);</span>
  <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>


  <span class="c1">// Draw the menu lines</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">0</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">Paint_DrawLine</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">48</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="mi">48</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="n">DOT_PIXEL_2X2</span><span class="p">,</span> <span class="n">LINE_STYLE_SOLID</span><span class="p">);</span>
  <span class="n">LCD_1IN14_Display</span><span class="p">(</span><span class="n">BlackImage</span><span class="p">);</span>
  <span class="n">convertData</span><span class="p">();</span>
  <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>  


<span class="p">}</span>

<span class="c1">// ==================================================</span>
<span class="c1">// === Poll buttons for presses</span>
<span class="c1">// ==================================================</span>
<span class="kt">void</span> <span class="nf">pollButtons</span><span class="p">(){</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">keyA</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> 
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">keyB</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">up</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">dowm</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">left</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">right</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
  <span class="k">if</span><span class="p">(</span><span class="n">DEV_Digital_Read</span><span class="p">(</span><span class="n">ctrl</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>






<span class="c1">// ========================================</span>
<span class="c1">// === Core 1 main -- started in main below</span>
<span class="c1">// ========================================</span>
<span class="kt">void</span> <span class="nf">core1_main</span><span class="p">(){</span>
  
  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>

    <span class="n">sleep_us</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">saveData</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
      <span class="n">writeToSD</span><span class="p">();</span>
      <span class="n">saveData</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">while</span><span class="p">(</span><span class="n">runSerialInterface</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="c1">//Main process</span>
      <span class="n">sleep_us</span><span class="p">(</span><span class="mi">30000</span><span class="p">);</span>
      <span class="n">pollButtons</span><span class="p">();</span>
    <span class="p">}</span>
    
  <span class="p">}</span>


<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="c1">// Initialize stdio</span>
  <span class="n">stdio_init_all</span><span class="p">();</span>
  <span class="c1">// Initialize data from SD Card</span>
  <span class="n">readFromSD</span><span class="p">();</span>
  <span class="c1">// Initialize LCD display</span>
  <span class="n">bootDisplay</span><span class="p">();</span>
  <span class="c1">// Initialize Structs</span>
  <span class="n">initRemoteData</span><span class="p">();</span>
  <span class="c1">//Finish SD init</span>
  <span class="n">convertData</span><span class="p">();</span> 
  <span class="n">refreshDisplay</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="n">writeToSD</span><span class="p">();</span> 


  <span class="c1">//Init IR LED/REC PINs</span>
  <span class="n">gpio_init</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">);</span>
  <span class="n">gpio_disable_pulls</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">);</span> <span class="c1">//Disable Pullup on interupt pin</span>

  <span class="n">gpio_init</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">);</span>
  <span class="n">gpio_set_dir</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">,</span> <span class="n">GPIO_OUT</span><span class="p">);</span>

  <span class="n">gpio_put</span><span class="p">(</span><span class="n">IR_LED_PIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


  <span class="n">timeout</span> <span class="o">=</span> <span class="n">add_alarm_in_ms</span><span class="p">(</span><span class="mi">9999999</span><span class="p">,</span> <span class="n">encapsle_button_ISR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="c1">//Set indef. future for makeshift valid timer</span>

  <span class="c1">// Configure GPIO interrupt (Can be packaged for toggle on/off method for open-receiving)</span>
  <span class="c1">// -&gt; Must be called while IR LED is currently off </span>
  <span class="n">edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Ensure indexing tail is init first</span>
  <span class="c1">//Init to false, will be enabled during serial interface FSM</span>
  <span class="n">gpio_set_irq_enabled_with_callback</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">,</span> <span class="n">GPIO_IRQ_EDGE_RISE</span> <span class="o">|</span> <span class="n">GPIO_IRQ_EDGE_FALL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpio_log</span><span class="p">);</span>
  <span class="n">gpio_set_irq_enabled</span><span class="p">(</span><span class="n">IR_RECEIVER_PIN</span><span class="p">,</span> <span class="n">GPIO_IRQ_EDGE_RISE</span> <span class="o">|</span> <span class="n">GPIO_IRQ_EDGE_FALL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

  <span class="c1">// Add thread to core 0</span>
  <span class="n">pt_add_thread</span><span class="p">(</span><span class="n">protothread_core_1</span><span class="p">)</span> <span class="p">;</span>

  <span class="c1">// Start core 1 </span>
  <span class="n">multicore_reset_core1</span><span class="p">();</span>
  <span class="n">multicore_launch_core1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">core1_main</span><span class="p">);</span>

  <span class="c1">// Start threads</span>
  <span class="n">pt_schedule_start</span> <span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<h2 id="appendix-c---schematics">Appendix C - Schematics</h2>

<p><img src="schematic.png" alt="hardware schematic" width="600" /></p>

<h2 id="appendix-d---work-breakdown">Appendix D - Work Breakdown</h2>

<ul>
  <li>LCD User Interface: Owen Louis</li>
  <li>Serial User Interface: Liam Sweeney</li>
  <li>SD Card Support: Owen Louis</li>
  <li>Infrared Communications: Liam Sweeney</li>
  <li>Battery Power: Owen Louis</li>
  <li>Physical Construction: Owen Louis</li>
  <li>Testing: Owen Louis and Liam Sweeney</li>
  <li>Webpage: Owen Louis and Liam Sweeney</li>
</ul>

<h2 id="appendix-e---references-and-parts">Appendix E - References and Parts</h2>

<h3 id="libraries">Libraries</h3>

<ul>
  <li>SD Card C Library: http://elm-chan.org/fsw/ff/00index_e.html</li>
  <li>LCD Screen C Library: https://www.waveshare.com/wiki/Pico-LCD-1.14</li>
</ul>

<h3 id="parts">Parts</h3>

<ul>
  <li>Raspberry Pi Pico: https://www.raspberrypi.com/products/raspberry-pi-pico/</li>
  <li>LCD Screen: https://www.waveshare.com/wiki/Pico-LCD-1.14</li>
  <li>SD Card Breakout Board: https://www.digikey.com/en/products/detail/adafruit-industries-llc/4682/12822319</li>
  <li>AA Battery Holder: https://www.amazon.com/dp/B09V7Z4MT7?psc=1&amp;ref=ppx_yo2ov_dt_b_product_details</li>
  <li>Infrared LED: https://www.sparkfun.com/products/9349?_ga=2.201535761.1075059845.1667497389-1261656821.1667497389</li>
  <li>Infrared Reciever: https://www.sparkfun.com/products/10266?_ga=2.197351087.1075059845.1667497389-1261656821.1667497389</li>
</ul>


  
</article>



<footer>
  <div>Owen Louis and Liam Sweeney - Cornell University</div>
  <nav><a href="mailto:ocl6@cornell.edu" ><svg aria-label="Mail" class="icon"><use xlink:href="assets/fontawesome/icons.svg#envelope"></use></svg></a></nav>

</footer>


</html>
