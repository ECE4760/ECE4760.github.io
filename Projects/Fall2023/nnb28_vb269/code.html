<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>
  <title>RPee2040</title>
  <style>
    body {
      font-family: 'Inter';
      font-size: 18px;
    }

    .pee {
      color: #4EB182;
      font-size: 22px;
      font-weight: 900;
    }

    .r2040 {
      color: black;
      font-size: 18px;
      font-family: 'Inter';
      font-weight: bold;
    }

    .bold {
      font-weight: bold;
    }

    .red {
      color: #FF0000;
    }

    .yellow-background {
      background-color: Yellow;
    }


    ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f3f3f3;
      position: -webkit-sticky;
      /* Safari */
      position: sticky;
      top: 0;
    }

    li {
      float: left;
    }

    li a {
      display: block;
      color: black;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }

    li a:hover:not(.active) {
      background-color: #d5d4d4;
    }

    .active {
      background-color: #4EB182;
    }

    .code {
      font-family: 'Courier New', Courier, monospace;
    }

    .c28 {
      margin-left: 108pt;
      padding-top: 12pt;
      text-indent: 36pt;
      padding-bottom: 12pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c27 {
      margin-left: 72pt;
      padding-top: 12pt;
      padding-left: 0pt;
      padding-bottom: 12pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c19 {
      margin-left: 72pt;
      padding-top: 12pt;
      text-indent: 36pt;
      padding-bottom: 12pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c5 {
      background-color: #ffffff;
      padding-top: 0pt;
      padding-bottom: 0pt;
      line-height: 1.5;
      orphans: 2;
      widows: 2;
      text-align: left;
      height: 11pt
    }

    .c31 {
      margin-left: 36pt;
      padding-top: 12pt;
      padding-left: 0pt;
      padding-bottom: 12pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c1 {
      color: #a31515;
      font-weight: 400;
      text-decoration: none;
      vertical-align: baseline;
      font-size: 9pt;
      font-family: "Courier New";
      font-style: normal
    }

    .c18 {
      color: #000000;
      font-weight: 400;
      text-decoration: none;
      vertical-align: baseline;
      font-size: 10pt;
      font-family: "Inter";
      font-style: italic
    }

    .c4 {
      color: #ee0000;
      font-weight: 400;
      text-decoration: none;
      vertical-align: baseline;
      font-size: 9pt;
      font-family: "Courier New";
      font-style: normal
    }

    .c6 {
      background-color: #ffffff;
      padding-top: 0pt;
      padding-bottom: 0pt;
      line-height: 1.5;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c25 {
      -webkit-text-decoration-skip: none;
      color: #1155cc;
      font-weight: 400;
      text-decoration: underline;
      text-decoration-skip-ink: none;
      font-size: 10pt;
      font-family: "Inter"
    }

    .c43 {
      padding-top: 12pt;
      padding-bottom: 12pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c16 {
      padding-top: 0pt;
      padding-bottom: 0pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .c41 {
      padding-top: 0pt;
      padding-bottom: 0pt;
      line-height: 1.15;
      orphans: 2;
      widows: 2;
      text-align: center
    }

    .c24 {
      color: #000000;
      font-weight: 400;
      font-size: 13pt;
      font-family: "Inter"
    }

    .c13 {
      font-size: 15pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 600
    }

    .c9 {
      color: #008000;
      font-weight: 400;
      font-size: 9pt;
      font-family: "Courier New"
    }

    .c50 {
      color: #000000;
      font-weight: 400;
      font-size: 22pt;
      font-family: "Inter"
    }

    .c38 {
      color: #cd3131;
      font-weight: 400;
      font-size: 9pt;
      font-family: "Courier New"
    }

    .c26 {
      font-size: 13pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 400
    }

    .c15 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #098658;
      font-weight: 400
    }

    .c2 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #af00db;
      font-weight: 400
    }

    .c40 {
      color: #4eb182;
      font-weight: 600;
      font-size: 13pt;
      font-family: "Inter"
    }

    .c11 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #0000ff;
      font-weight: 400
    }

    .c48 {
      color: #000000;
      font-weight: 700;
      font-size: 13pt;
      font-family: "Inter"
    }

    .c3 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #795e26;
      font-weight: 400
    }

    .c53 {
      color: #000000;
      font-weight: 700;
      font-size: 10pt;
      font-family: "Inter"
    }

    .c39 {
      font-size: 15pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 400
    }

    .c36 {
      font-size: 15pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 500
    }

    .c54 {
      color: #3c78d8;
      font-weight: 400;
      font-size: 13pt;
      font-family: "Source Code Pro"
    }

    .c22 {
      color: #000000;
      font-weight: 400;
      font-size: 10pt;
      font-family: "Inter"
    }

    .c23 {
      font-size: 30pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 700
    }

    .c57 {
      color: #267f99;
      font-weight: 400;
      font-size: 13pt;
      font-family: "Inter"
    }

    .c0 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #3c78d8;
      font-weight: 400
    }

    .c49 {
      font-size: 13pt;
      font-family: "Inter";
      color: #4eb182;
      font-weight: 700
    }

    .c12 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #ee0000;
      font-weight: 400
    }

    .c14 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #267f99;
      font-weight: 400
    }

    .c10 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #001080;
      font-weight: 400
    }

    .c8 {
      font-size: 9pt;
      font-family: "Courier New";
      color: #a31515;
      font-weight: 400
    }

    .c42 {
      background-color: #ffffff;
      max-width: 468pt;
      padding: 72pt 72pt 72pt 72pt
    }

    .c45 {
      font-size: 9pt;
      font-family: "Inter";
      font-weight: 400
    }

    .c7 {
      text-decoration: none;
      vertical-align: baseline;
      font-style: normal
    }

    .c21 {
      font-size: 10pt;
      font-family: "Inter";
      font-weight: 500
    }

    .c37 {
      font-size: 10pt;
      font-family: "Inter";
      font-weight: 400
    }

    .c35 {
      text-decoration: none;
      vertical-align: baseline;
      font-style: italic
    }

    .c55 {
      font-size: 22pt;
      font-family: "Inter";
      font-weight: 400
    }

    .c29 {
      vertical-align: baseline;
      font-style: normal
    }

    .c30 {
      margin-left: 108pt;
      text-indent: 36pt
    }

    .c51 {
      margin-left: 72pt;
      padding-left: 0pt
    }

    .c34 {
      margin-left: 36pt;
      text-indent: 36pt
    }

    .c32 {
      color: inherit;
      text-decoration: inherit
    }

    .c20 {
      padding: 0;
      margin: 0
    }

    .c44 {
      margin-left: 36pt;
      padding-left: 0pt
    }

    .c17 {
      height: 11pt
    }

    .c33 {
      margin-left: 180pt
    }

    .c46 {
      margin-left: 108pt
    }

    .c52 {
      margin-left: 36pt
    }

    .c47 {
      font-style: italic
    }

    .c56 {
      color: #000000
    }

    .title {
      padding-top: 0pt;
      color: #000000;
      font-size: 26pt;
      padding-bottom: 3pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    .subtitle {
      padding-top: 0pt;
      color: #666666;
      font-size: 15pt;
      padding-bottom: 16pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    li {
      color: #000000;
      font-size: 22pt;
      font-family: "Inter"
    }

    p {
      margin: 0;
      color: #000000;
      font-size: 11pt;
      font-family: "Arial"
    }

    h1 {
      padding-top: 20pt;
      color: #000000;
      font-size: 20pt;
      padding-bottom: 6pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    h2 {
      padding-top: 18pt;
      color: #000000;
      font-size: 16pt;
      padding-bottom: 6pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    h3 {
      padding-top: 16pt;
      color: #434343;
      font-size: 14pt;
      padding-bottom: 4pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    h4 {
      padding-top: 14pt;
      color: #666666;
      font-size: 12pt;
      padding-bottom: 4pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    h5 {
      padding-top: 12pt;
      color: #666666;
      font-size: 11pt;
      padding-bottom: 4pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      orphans: 2;
      widows: 2;
      text-align: left
    }

    h6 {
      padding-top: 12pt;
      color: #666666;
      font-size: 11pt;
      padding-bottom: 4pt;
      font-family: "Arial";
      line-height: 1.15;
      page-break-after: avoid;
      font-style: italic;
      orphans: 2;
      widows: 2;
      text-align: left
    }





    ​
  </style>
</head>

<body>
  <ul>
    <li><a href="RPee2040.html"><span class="r2040">R</span><span class="pee">Pee</span><span
          class="r2040">2040</span></a></li>
    <li><a href="#seed">The Seed</a></li>
    <li><a href="#planting">The Seed: Planting</a></li>
    <li><a href="#sprouting">The Sprout</a></li>
    <li><a href="#plant">The Plant</a></li>
    <li style="float:right"><a href="code.html">Code</a></li>
  </ul>
</body>

<p class="c16"><span class="c35 c40">Code Appendix</span></p>
<p class="c16 c17"><span class="c40 c35"></span></p>
<p class="c6"><span class="c9 c7">/**</span></p>
<p class="c6"><span class="c9 c7">* Adapted from:</span></p>
<p class="c6"><span class="c9 c7">* Copyright (c) 2022 Raspberry Pi (Trading) Ltd.</span></p>
<p class="c6"><span class="c9 c7">* SPDX-License-Identifier: BSD-3-Clause</span></p>
<p class="c6"><span class="c9 c7">* the tcp/ip routines are mostly just copied into this code from</span></p>
<p class="c6"><span class="c9 c7">*
    https://github.com/raspberrypi/pico-examples/blob/master/pico_w/wifi/tcp_server/picow_tcp_server.c</span></p>
<p class="c6"><span class="c9 c7">* The html and response parser was modified.</span></p>
<p class="c6"><span class="c9 c7">*</span></p>
<p class="c6"><span class="c9 c7">* Integrate LWIP with protothreads AND with VGA driver</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;This required changing the VGA DMA channels to use the &quot;claim&quot;
    protocol</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;rather than hard code actual channel numbers.</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;Also, the LWIP uses PIO1, so the VGA driver must run in PIO0</span></p>
<p class="c6"><span class="c9 c7">*</span></p>
<p class="c6"><span class="c9 c7">* Threads:</span></p>
<p class="c6"><span class="c9 c7">* --blink cyw43 LED at a few Hz</span></p>
<p class="c6"><span class="c9 c7">* -- serial for debugging and commands</span></p>
<p class="c6"><span class="c9 c7">* -- graphics thread to write LED status of server</span></p>
<p class="c6"><span class="c9 c7">* *** All tcp is triggered from ISR started by cyw43 (not a thread)</span></p>
<p class="c6"><span class="c9 c7">*</span></p>
<p class="c6"><span class="c9 c7">* the VGA must be cpnnected for display!</span></p>
<p class="c6"><span class="c9 c7">*</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;access_point_ssid = &quot;picow_test&quot;</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;password = &quot;password&quot;</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;access_point_IP4_ADDR(192.168.4.1) p</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;attach to the access point point, then browse the IP address</span></p>
<p class="c6"><span class="c9 c7">*</span></p>
<p class="c6"><span class="c9">* </span><span class="c11 c7">MAIN:</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;starts serial</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;starts VGA</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;network init</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- start the cyw43 in access point mode -- assigns ssid,
    password</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- assign the IP address of the server</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; I think this starts the ISR which handles all
    transactions</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- start the DHCP server</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- start the DNS server</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- start the TCP server</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; define data structures, bind to port 80</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; start tcp_listen</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; does tcp_server_accept</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sets up tcp_poll</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;starts the threader with core1 running the VGA,</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;and core0 running the tcpip and serial</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;-- receiving a GET request -- happens from ISR callback</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;triggers content parsing and analysis</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;generate response in the form of header and html</span>
</p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;do some error checking for too much space used</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;tcp_write the html response</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">*/</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">/*</span></p>
<p class="c6"><span class="c9 c7">* Hardware Connections</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;- RP2040 w GPIO 3 ---&gt; Analog output pin</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;- RP2040 w 3.3v ---&gt; Capacitive Soil Moisture Sensor VCC</span></p>
<p class="c6"><span class="c9 c7">* &nbsp;- RP2040 w GND ---&gt; Capacitive Soil Moisture Sensor GND</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">* Serial Connections</span></p>
<p class="c6"><span class="c9 c7">* - GPIO 0 ---&gt; UART RX (white)</span></p>
<p class="c6"><span class="c9 c7">* - GPIO 1 ---&gt; UART TX (green)</span></p>
<p class="c6"><span class="c9 c7">* - RP2040 w GND ---&gt; UART GND</span></p>
<p class="c6"><span class="c9 c7">*/</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ==========================================</span></p>
<p class="c6"><span class="c9 c7">// === VGA graphics library</span></p>
<p class="c6"><span class="c9 c7">// ==========================================</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;vga256_graphics.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;stdio.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;stdlib.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;string.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;math.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;pico/stdlib.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/pio.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/dma.h&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =====================================</span></p>
<p class="c6"><span class="c9 c7">// network includes</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;string.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span class="c1">&lt;time.h&gt;</span>
</p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&lt;pico/multicore.h&gt;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/sync.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/uart.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/rtc.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;hardware/adc.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;pico/util/datetime.h&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;pico/stdlib.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;pico/cyw43_arch.h&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;lwip/dns.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;lwip/pbuf.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;lwip/tcp.h&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">//========================================</span></p>
<p class="c6"><span class="c9 c7">// protothreads</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;pt_cornell_rp2040_v1_1_2.h&quot;</span></p>
<p class="c6"><span class="c9 c7">// log the access point LED for graphics thread to use</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">access_led_state</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c9 c7">// int temp_sensor ; // turning on the temp_sensor kills the network!</span></p>
<p class="c6"><span class="c9 c7">// &nbsp;user state variables</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">user_number</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">test_field</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c9 c7">// gpio2 % intensity</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">test2_field</span><span
    class="c0">&nbsp;= </span><span class="c15">25</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">ec_field</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c10">color</span><span class="c0">,
  </span><span class="c10">new_color</span><span class="c0">&nbsp;= </span><span class="c11">true</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c11">float</span><span class="c0">&nbsp;</span><span class="c10">temp</span><span
    class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =======================================</span></p>
<p class="c6"><span class="c9 c7">// access point setup</span></p>
<p class="c6"><span class="c9 c7">// copied from pico_examples git</span></p>
<p class="c6"><span class="c9 c7">// html was modified and expanded</span></p>
<p class="c6"><span class="c9 c7">// =======================================</span></p>
<p class="c6"><span class="c9 c7">// add a &#39;printf&#39; to the line below to dump</span></p>
<p class="c6"><span class="c9 c7">// internal state info &nbsp;e.g.:</span></p>
<p class="c6"><span class="c9 c7">// #define DEBUG_printf &nbsp;printf</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11 c7">&nbsp;DEBUG_printf</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;dhcpserver/dhcpserver.h&quot;</span></p>
<p class="c6"><span class="c2">#include</span><span class="c11">&nbsp;</span><span
    class="c1">&quot;dnsserver/dnsserver.h&quot;</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;TCP_PORT </span><span class="c15 c7">80</span>
</p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;POLL_TIME_S </span><span class="c15 c7">5</span>
</p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;HTTP_GET </span><span
    class="c1">&quot;GET&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;HTTP_RESPONSE_HEADERS </span><span
    class="c8">&quot;HTTP/1.1 </span><span class="c10">%d</span><span class="c8">&nbsp;OK</span><span
    class="c12">\n</span><span class="c8">Content-Length: </span><span class="c10">%d</span><span
    class="c12">\n</span><span class="c8">Content-Type: text/html;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    &nbsp; &nbsp; &nbsp; charset=utf-8</span><span class="c12">\n</span><span class="c8">Connection: close</span><span
    class="c12">\n\n</span><span class="c1">&quot;</span></p>
<p class="c6"><span class="c9 c7">// the html. format specs represent server state to be resolved at send time</span>
</p>
<p class="c6"><span class="c9 c7">// this is one part I changed and expanded from the demo code</span></p>
<p class="c6"><span class="c9 c7">// the one-line javascript is hacked slightly from</span></p>
<p class="c6"><span class="c9 c7">//
    https://stackoverflow.com/questions/74320571/inserting-oninput-to-an-input-field</span></p>
<p class="c6"><span class="c9 c7">// and allows the numerical value of the slider to change as yuo move the
    slider</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;LED_TEST_BODY </span><span class="c4">\</span>
</p>
<p class="c6"><span class="c11">&nbsp; &nbsp;</span><span class="c8">&quot;&lt;html&gt;&lt;body&gt;&lt;b&gt;Page from
    PicoW -- ece4760&lt;/b&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;p&gt;Onboard Led is </span><span class="c10">%s</span><span
    class="c8">&nbsp;and Sensor reads: </span><span class="c10">%f</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;form&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;label for=</span><span class="c12">\&quot;</span><span
    class="c8">ledsel</span><span class="c12">\&quot;</span><span class="c8">&gt;Set LED:&lt;/label&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;select name=</span><span class="c12">\&quot;</span><span
    class="c8">led</span><span class="c12">\&quot;</span><span class="c8">&nbsp;id=</span><span
    class="c12">\&quot;</span><span class="c8">ledsel</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;size=</span><span class="c12">\&quot;</span><span class="c8">2</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp; onchange=</span><span class="c12">\&quot;</span><span
    class="c8">submit();</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span>
</p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;option value=</span><span class="c12">\&quot;</span><span
    class="c8">0</span><span class="c12">\&quot;</span><span class="c8">&nbsp;</span><span class="c10">%s</span><span
    class="c8">&gt;LED 0ff&lt;/option&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;option value=</span><span class="c12">\&quot;</span><span
    class="c8">1</span><span class="c12">\&quot;</span><span class="c8">&nbsp;</span><span class="c10">%s</span><span
    class="c8">&gt;LED on &lt;/option&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/select&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;svg width=</span><span class="c12">\&quot;</span><span
    class="c8">20</span><span class="c12">\&quot;</span><span class="c8">&nbsp;height=</span><span
    class="c12">\&quot;</span><span class="c8">20</span><span class="c12">\&quot;</span><span
    class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;circle cx=</span><span class="c12">\&quot;</span><span
    class="c8">10</span><span class="c12">\&quot;</span><span class="c8">&nbsp;cy=</span><span
    class="c12">\&quot;</span><span class="c8">10</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;r=</span><span class="c12">\&quot;</span><span class="c8">10</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;stroke=</span><span class="c12">\&quot;</span><span
    class="c8">green</span><span class="c12">\&quot;</span><span class="c8">&nbsp;stroke-width=</span><span
    class="c12">\&quot;</span><span class="c8">1</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;fill=</span><span class="c10">%s</span><span class="c8">&nbsp;/&gt;</span><span class="c4">\</span>
</p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/svg&gt;&lt;p&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;label for=</span><span class="c12">\&quot;</span><span
    class="c8">test</span><span class="c12">\&quot;</span><span class="c8">&gt;number:&lt;/label&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">number</span><span class="c12">\&quot;</span><span class="c8">&nbsp;id=</span><span
    class="c12">\&quot;</span><span class="c8">test</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;name=</span><span class="c12">\&quot;</span><span class="c8">test</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;value=</span><span class="c10">%d</span><span
    class="c8">&nbsp;min=</span><span class="c12">\&quot;</span><span class="c8">0</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;max=</span><span class="c12">\&quot;</span><span
    class="c8">999</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">submit</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;entered:&lt;b&gt;&lt;font color=</span><span class="c12">\&quot;</span><span
    class="c8">RED</span><span class="c12">\&quot;</span><span class="c8">&gt;
  </span><span class="c10">%03d</span><span class="c8">&nbsp;&lt;/font&gt;&lt;/b&gt;</span><span class="c4">\</span>
</p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;meter value=</span><span class="c10">%d</span><span
    class="c8">&nbsp;min=</span><span class="c12">\&quot;</span><span class="c8">0</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;max=</span><span class="c12">\&quot;</span><span
    class="c8">999</span><span class="c12">\&quot;</span><span class="c8">&gt;&lt;/meter&gt;&lt;br&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;p&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;label for=</span><span class="c12">\&quot;</span><span
    class="c8">test2</span><span class="c12">\&quot;</span><span class="c8">&gt;GPIO2 PWM
    intensity:&lt;/label&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">range</span><span class="c12">\&quot;</span><span class="c8">&nbsp;id=</span><span
    class="c12">\&quot;</span><span class="c8">test2</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;value=</span><span class="c10">%d</span><span class="c8">&nbsp;min=</span><span
    class="c12">\&quot;</span><span class="c8">1</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;max=</span><span class="c12">\&quot;</span><span class="c8">99</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;name=</span><span class="c12">\&quot;</span><span
    class="c8">test2</span><span class="c4">\&quot;\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;oninput=</span><span class="c12">\&quot;</span><span
    class="c8">this.nextElementSibling.value = this.value;</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;onchange=</span><span class="c12">\&quot;</span><span class="c8">submit()</span><span
    class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;output&gt;</span><span class="c10">%d%%</span><span
    class="c8">&lt;/output&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/form&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;script&gt; </span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;setTimeout(function(){ location.reload(); }, 10000); </span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;p&gt;&lt;a href=http://192.168.4.1/plantparenthood&gt;
    PlantParenthood&lt;/a&gt;</span><span class="c7 c38">\</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;&lt;/body&gt;&lt;/html&gt;</span><span class="c1">&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c1">// this page uses javascript submit() method so a button is not necessary</span></p>
<p class="c6"><span class="c1">// it also tests &lt;svg&gt; graphics to draw a dynamic LED icon</span></p>
<p class="c6"><span class="c8">// &lt;label for=</span><span class="c12">\&quot;</span><span
    class="c8">led_control1</span><span class="c12">\&quot;</span><span class="c8">&gt;led
    on/off:&lt;/label&gt;&lt;br&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">// &nbsp; &lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">text</span><span class="c12">\&quot;</span><span class="c8">&nbsp;id=</span><span
    class="c12">\&quot;</span><span class="c8">led_control1</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;name=</span><span class="c12">\&quot;</span><span class="c8">led</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;value=</span><span class="c10">%d</span><span
    class="c8">&gt;&lt;br&gt;</span><span class="c4">\</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c8">#define </span><span class="c11">NEW_PAGE_BODY</span><span class="c8">&nbsp;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&quot;</span><span class="c0">&lt;html&gt;&lt;head&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;&lt;meta charset=\</span><span class="c8">&quot;UTF-8</span><span
    class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;meta name=</span><span class="c12">\&quot;</span><span
    class="c8">viewport</span><span class="c12">\&quot;</span><span class="c8">&nbsp;content=</span><span
    class="c12">\&quot;</span><span class="c8">width=device-width, initial-scale=1.0</span><span
    class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;title&gt;Reload Part of HTML&lt;/title&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/head&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;body&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;div id=</span><span class="c12">\&quot;</span><span
    class="c8">content</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;&lt;p id=</span><span class="c12">\&quot;</span><span
    class="c8">reloadMe</span><span class="c12">\&quot;</span><span class="c8">&gt;This content can be reloaded.
  </span><span class="c10">%d</span><span class="c8">&nbsp;&lt;/p&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/div&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;div id=</span><span class="c12">\&quot;</span><span
    class="c8">content2</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span>
</p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;&lt;p id=</span><span class="c12">\&quot;</span><span
    class="c8">reloadMeNOT</span><span class="c12">\&quot;</span><span class="c8">&gt;This content cannot be
    reloaded.&lt;/p&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/div&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;button onclick=</span><span class="c12">\&quot;</span><span
    class="c8">reloadContent()</span><span class="c12">\&quot;</span><span class="c8">&gt;Reload
    Content&lt;/button&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;function reloadContent() {</span><span class="c4">\</span>
</p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;fetch(http://192.168.4.1/newpage)</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.then(response =&gt;
    response.text())</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.then(data =&gt; {</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    &nbsp;document.getElementById(&#39;reloadMe&#39;).innerHTML = data;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;})</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.catch(error =&gt;
    console.error(&#39;Error:&#39;, error));</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c1">&nbsp; &nbsp;&lt;/body&gt;&lt;/html&gt;&quot;</span></p>
<p class="c6"><span class="c9 c7">// light-green</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;RPEE2040_BODY </span><span class="c4">\</span>
</p>
<p class="c6"><span class="c11">&nbsp; &nbsp;</span><span class="c8">&quot;&lt;html&gt;&lt;body style=</span><span
    class="c12">\&quot;</span><span class="c8">background-color: #4EB182;</span><span class="c12">\&quot;</span><span
    class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;p style=</span><span class="c12">\&quot;</span><span class="c8">color:
    white; font-family: Arial; font-size: 90px; text-align: center; padding: 700px 0</span><span
    class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;Welcome to</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;br&gt; R&lt;strong&gt;PEE&lt;/strong&gt;2040</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/p&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;setTimeout(function(){ location.href = </span><span
    class="c12">\&quot;</span><span class="c8">/plantparenthood</span><span class="c12">\&quot;</span><span class="c8">;
    }, 3000); </span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c1">&nbsp; &nbsp;&lt;/body&gt;&lt;/html&gt;&quot;</span></p>
<p class="c6"><span class="c9 c7">// rgb(230, 211, 190)</span></p>
<p class="c6"><span class="c9 c7">// rgb(252, 236, 202)</span></p>
<p class="c6"><span class="c9 c7">// rgb(179, 136, 105)</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;PLANTPARENTHOOD_BODY </span><span
    class="c4">\</span></p>
<p class="c6"><span class="c11">&nbsp; &nbsp;</span><span class="c8">&quot;&lt;html&gt;&lt;body style=</span><span
    class="c12">\&quot;</span><span class="c8">background-color: #4EAFB1;</span><span class="c12">\&quot;</span><span
    class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;style&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;form {color: #dfe2df; font-family: Arial; font-size: 90px; text-align:
    center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;input, textarea {color: #3A7781; font-family: Arial; font-size: 70px;
    text-align: center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;button {background-color: #c8e6e7; color: #3A7781; font-family: Arial;
    font-size: 50px; text-align: center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;meter {color: #e4e6e4; font-family: Arial; font-size: 120px; text-align:
    center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;h1 {color: #dfe2df; font-family: Arial; font-size: 90px; text-align:
    center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;body {color: #dfe2df; font-family: Arial; font-size: 70px; text-align:
    center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;h2 {color: white; font-family: Arial; font-size: 70px; text-align:
    center}</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/style&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;h1&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;Plant Parenthood&lt;br&gt;&lt;br&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/h1&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;meter value=</span><span class="c10">%f</span><span
    class="c8">&nbsp;min=</span><span class="c12">\&quot;</span><span class="c8">0</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;max=</span><span class="c12">\&quot;</span><span
    class="c8">100</span><span class="c12">\&quot;</span><span class="c8">&nbsp;low=</span><span
    class="c12">\&quot;</span><span class="c8">25</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;high=</span><span class="c12">\&quot;</span><span class="c8">50</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;optimum=</span><span class="c12">\&quot;</span><span
    class="c8">51</span><span class="c12">\&quot;</span><span class="c8">&gt;
    &lt;/meter&gt;&lt;br&gt;&lt;br&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;body&gt; Please input EC Sensor Reading in micromhos
    &lt;br&gt;&lt;br&gt;&lt;/body&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;form&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">number</span><span class="c12">\&quot;</span><span class="c8">&nbsp;id=</span><span
    class="c12">\&quot;</span><span class="c8">EC</span><span class="c12">\&quot;</span><span
    class="c8">&nbsp;name=</span><span class="c12">\&quot;</span><span class="c8">EC</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;value=</span><span class="c10">%d</span><span
    class="c8">&nbsp;min=</span><span class="c12">\&quot;</span><span class="c8">0</span><span
    class="c12">\&quot;</span><span class="c8">&nbsp;max=</span><span class="c12">\&quot;</span><span
    class="c8">2000</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;input type=</span><span class="c12">\&quot;</span><span
    class="c8">hidden</span><span class="c12">\&quot;</span><span class="c8">&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp; &nbsp; &nbsp;&lt;button&gt; Submit &lt;/button&gt;</span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/input&gt; </span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt; </span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/form&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;h2&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;</span><span class="c10">%s</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/h2&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;setTimeout(function(){ location.reload(); }, 5000); </span><span
    class="c4">\</span></p>
<p class="c6"><span class="c8">&nbsp; &nbsp;&lt;/script&gt;</span><span class="c4">\</span></p>
<p class="c6"><span class="c1">&nbsp; &nbsp;&lt;/body&gt;&lt;/html&gt;&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9">// &lt;label for=\&quot;EC\&quot;&gt;Moisture Value: %f&lt;/label&gt;
    &lt;br&gt;&lt;br&gt;</span><span class="c4">\</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// the names in these parse templates have to match the names</span></p>
<p class="c6"><span class="c9 c7">// in the &lt;form&gt; above: used to find data in the &#39;query string&#39;</span>
</p>
<p class="c6"><span class="c9 c7">// part of the URL requested by the browser</span></p>
<p class="c6"><span class="c9">// &lt;p&gt;&lt;input type=\&quot;submit\&quot;&gt;</span><span class="c4">\</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;LED_PARAM </span><span
    class="c8">&quot;led=</span><span class="c10">%d</span><span class="c1">&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;TEST_FMT </span><span
    class="c8">&quot;test=</span><span class="c10">%d</span><span class="c1">&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;TEST2_FMT </span><span
    class="c8">&quot;test2=</span><span class="c10">%d</span><span class="c1">&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;EC_FMT </span><span
    class="c8">&quot;EC=</span><span class="c10">%d</span><span class="c1">&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;COLOR_PARAM </span><span
    class="c8">&quot;color=</span><span class="c10">%d</span><span class="c1">&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// web page redirect name</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;LED_TEST </span><span
    class="c1">&quot;/ledtest&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;NEW_PAGE </span><span
    class="c1">&quot;/newpage&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;RPEE2040 </span><span
    class="c1">&quot;/rpee2040&quot;</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;PLANTPARENTHOOD </span><span
    class="c1">&quot;/plantparenthood&quot;</span></p>
<p class="c6"><span class="c9 c7">// The LED is on cy243 gpio 0 NOT the rp2040</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;LED_GPIO </span><span class="c15 c7">0</span></p>
<p class="c6"><span class="c9 c7">// the redirect using the IP adddress specified in MAIN</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;HTTP_RESPONSE_REDIRECT </span><span
    class="c8">&quot;HTTP/1.1 302 Redirect</span><span class="c12">\n</span><span class="c8">Location:
    http://</span><span class="c10">%s</span><span class="c8">&quot;</span><span class="c11">&nbsp;RPEE2040
  </span><span class="c8">&quot;</span><span class="c12">\n\n</span><span class="c1">&quot;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// GPIO PINS</span></p>
<p class="c6"><span class="c2">#define</span><span class="c11">&nbsp;MOISTURE_PIN </span><span class="c15 c7">27</span>
</p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">float</span><span
    class="c0">&nbsp;</span><span class="c10">moisture_value</span><span class="c0">&nbsp;= </span><span
    class="c15">200.0</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">float</span><span
    class="c0">&nbsp;</span><span class="c10">wet_reading</span><span class="c0">&nbsp;= </span><span
    class="c15">0.95</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">float</span><span
    class="c0">&nbsp;</span><span class="c10">dry_reading</span><span class="c0">&nbsp;= </span><span
    class="c15">1.7</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">int</span><span
    class="c0">&nbsp;</span><span class="c10">ec_value</span><span class="c0">&nbsp;= </span><span
    class="c15">200</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;</span><span class="c10">message</span><span class="c0">[</span><span class="c15">100</span><span
    class="c0 c7">];</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">int</span><span
    class="c0">&nbsp;</span><span class="c10">count</span><span class="c0">&nbsp;= </span><span
    class="c15">1</span><span class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ===========================</span></p>
<p class="c6"><span class="c9 c7">// connect state structures</span></p>
<p class="c6"><span class="c9 c7">// ===========================</span></p>
<p class="c6"><span class="c11">typedef</span><span class="c0">&nbsp;</span><span class="c11">struct</span><span
    class="c0">&nbsp;</span><span class="c14 c7">TCP_SERVER_T_</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">struct</span><span class="c0">&nbsp;</span><span
    class="c14">tcp_pcb</span><span class="c0">&nbsp;*</span><span class="c10">server_pcb</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">bool</span><span class="c0">&nbsp;</span><span
    class="c10">complete</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">ip_addr_t</span><span class="c0">&nbsp;</span><span
    class="c10">gw</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">async_context_t</span><span
    class="c0">&nbsp;*</span><span class="c10">context</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">} </span><span class="c14">TCP_SERVER_T</span><span class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c11">typedef</span><span class="c0">&nbsp;</span><span class="c11">struct</span><span
    class="c0">&nbsp;</span><span class="c14 c7">TCP_CONNECT_STATE_T_</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">struct</span><span class="c0">&nbsp;</span><span
    class="c14">tcp_pcb</span><span class="c0">&nbsp;*</span><span class="c10">pcb</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">int</span><span class="c0">&nbsp;</span><span
    class="c10">sent_len</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">char</span><span class="c0">&nbsp;</span><span
    class="c10">headers</span><span class="c0">[</span><span class="c15">512</span><span class="c0">];</span><span
    class="c9 c7">&nbsp;// 128</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">char</span><span class="c0">&nbsp;</span><span
    class="c10">result</span><span class="c0">[</span><span class="c15">2048</span><span class="c0">];</span><span
    class="c9 c7">&nbsp;// 256</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">int</span><span class="c0">&nbsp;</span><span
    class="c10">header_len</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">int</span><span class="c0">&nbsp;</span><span
    class="c10">result_len</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">ip_addr_t</span><span
    class="c0">&nbsp;*</span><span class="c10">gw</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">} </span><span class="c14">TCP_CONNECT_STATE_T</span><span class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =====================================</span></p>
<p class="c6"><span class="c9 c7">// called at end of &#39;tcp_server_sent&#39;</span></p>
<p class="c6"><span class="c9 c7">// and several times in &#39;tcp_server_recv&#39;</span></p>
<p class="c6"><span class="c9 c7">// and other places that open a conneciton</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span class="c0">(</span><span
    class="c14">TCP_CONNECT_STATE_T</span><span class="c0">&nbsp;*</span><span class="c10">con_state</span><span
    class="c0">, </span><span class="c11">struct</span><span class="c0">&nbsp;</span><span
    class="c14">tcp_pcb</span><span class="c0">&nbsp;*</span><span class="c10">client_pcb</span><span class="c0">,
  </span><span class="c14">err_t</span><span class="c0">&nbsp;</span><span class="c10">close_err</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">client_pcb</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">assert</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">&nbsp;&amp;&amp; </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">pcb</span><span class="c0">&nbsp;==
  </span><span class="c10">client_pcb</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_arg</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0">, </span><span class="c11">NULL</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_poll</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0">, </span><span class="c11">NULL</span><span
    class="c0">, </span><span class="c15">0</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_sent</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0">, </span><span class="c11">NULL</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_recv</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0">, </span><span class="c11">NULL</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_err</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0">, </span><span class="c11">NULL</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c10">err</span><span class="c0">&nbsp;= </span><span
    class="c3">tcp_close</span><span class="c0">(</span><span class="c10">client_pcb</span><span class="c0 c7">);</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">err</span><span class="c0 c7">&nbsp;!= ERR_OK)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;close failed </span><span
    class="c10">%d</span><span class="c8">, calling abort</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_abort</span><span
    class="c0">(</span><span class="c10">client_pcb</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">close_err</span><span
    class="c0 c7">&nbsp;= ERR_ABRT;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">con_state</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">free</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span class="c0">&nbsp;</span><span
    class="c10">close_err</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =======================================</span></p>
<p class="c6"><span class="c9 c7">// not called in this pgm, since code never exits</span></p>
<p class="c6"><span class="c9 c7">/*</span></p>
<p class="c6"><span class="c9 c7">static void tcp_server_close(TCP_SERVER_T *state) {</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;if (state-&gt;server_pcb) {</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;tcp_arg(state-&gt;server_pcb, NULL);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;tcp_close(state-&gt;server_pcb);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;state-&gt;server_pcb = NULL;</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c9 c7">}</span></p>
<p class="c6"><span class="c9 c7">*/</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_server_sent</span><span class="c0">(</span><span
    class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span class="c0">, </span><span
    class="c11">struct</span><span class="c0">&nbsp;</span><span class="c14">tcp_pcb</span><span
    class="c0">&nbsp;*</span><span class="c10">pcb</span><span class="c0">, </span><span class="c14">u16_t</span><span
    class="c0">&nbsp;</span><span class="c10">len</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0">&nbsp;*</span><span class="c10">con_state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_CONNECT_STATE_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span class="c0">(</span><span
    class="c8">&quot;tcp_server_sent </span><span class="c10">%u</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c10">len</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">sent_len</span><span class="c0">&nbsp;+= </span><span class="c10">len</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">sent_len</span><span
    class="c0">&nbsp;&gt;= </span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">header_len</span><span class="c0">&nbsp;+ </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">result_len</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;all done</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span class="c0">(</span><span
    class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span class="c0 c7">,
    ERR_OK);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0 c7">&nbsp;ERR_OK;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">// This routine actially parses the GET response to figure out what</span></p>
<p class="c6"><span class="c9 c7">// the browwer user asked for on the web page.</span></p>
<p class="c6"><span class="c9 c7">// This is another part I chnaged from the example</span></p>
<p class="c6"><span class="c9 c7">// to support more general parsing of several data items</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">int</span><span
    class="c0">&nbsp;</span><span class="c3">test_server_content</span><span class="c0">(</span><span
    class="c11">const</span><span class="c0">&nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">request</span><span class="c0">, </span><span
    class="c11">const</span><span class="c0">&nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">params</span><span class="c0">, </span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">result</span><span class="c0">,
  </span><span class="c14">size_t</span><span class="c0">&nbsp;</span><span class="c10">max_result_len</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">int</span><span class="c0">&nbsp;</span><span
    class="c10">len</span><span class="c0">&nbsp;= </span><span class="c15">0</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// three data items sent in this example, but
    could be many more</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">static</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;</span><span class="c10">param1</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">param2</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">param3</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0 c7">];</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">static</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;*</span><span class="c10">token</span><span class="c0 c7">;</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// is it the ledtest page?</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c3">strncmp</span><span class="c0">(</span><span class="c10">request</span><span class="c0">, </span><span
    class="c11">LED_TEST</span><span class="c0">, </span><span class="c11">sizeof</span><span class="c0">(</span><span
    class="c11">LED_TEST</span><span class="c0">) - </span><span class="c15">1</span><span class="c0">) ==
  </span><span class="c15">0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Get the curent state of the
    led</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// not used here, except as
    backup if web form fails</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// bool value;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//
    cyw43_gpio_get(&amp;cyw43_state, LED_GPIO, &amp;value);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// int led_state = value;</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// See what data the user asked
    for:</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// the params string is trimmed
    by the receive funciton below to have</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// only user-supplied data</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// general data format is</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//
    http://192.168.4.1/ledtest?name1=value1&amp;name2=data2&amp;name3=data3 and etc</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// by the time the string gets
    here, the trimmed version is</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//
    name1=value1&amp;name2=data2&amp;name3=data3</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">params</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// parse the params
    using &#39;&amp;&#39; delimeter</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span
    class="c0">&nbsp;= </span><span class="c3">strtok</span><span class="c0">((</span><span class="c11">char</span><span
    class="c0">&nbsp;*)</span><span class="c10">params</span><span class="c0">,
  </span><span class="c8">&quot;&amp; &quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">param1</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span
    class="c0">&nbsp;= </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span
    class="c0">, </span><span class="c8">&quot;&amp; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">param2</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span
    class="c0">&nbsp;= </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span
    class="c0">, </span><span class="c8">&quot;&amp; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">param3</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// now get the
    actual numbers</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">sscanf</span><span
    class="c0">(</span><span class="c10">param1</span><span class="c0">, </span><span class="c11">LED_PARAM</span><span
    class="c0">, &amp;</span><span class="c10">access_led_state</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// force to binary
    value and set LED state</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">access_led_state</span><span class="c0">&nbsp;= </span><span class="c10">access_led_state</span><span
    class="c0">&nbsp;&gt; </span><span class="c15">0</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c3">cyw43_gpio_set</span><span class="c0">(&amp;cyw43_state, </span><span class="c15">0</span><span
    class="c0">, </span><span class="c10">access_led_state</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// set global to
    signal graphics thread</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// the second and
    third parameter begining is delimited by an &#39;&amp;&#39;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// these tell the
    graphics thread what numbers to draw</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">sscanf</span><span
    class="c0">(</span><span class="c10">param2</span><span class="c0">, </span><span class="c11">TEST_FMT</span><span
    class="c0">, &amp;</span><span class="c10">test_field</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">sscanf</span><span
    class="c0">(</span><span class="c10">param3</span><span class="c0">, </span><span class="c11">TEST2_FMT</span><span
    class="c0">, &amp;</span><span class="c10">test2_field</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Generate result web page using
    the above data</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// by filling in the format
    fields in the http string.</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// test2_field occcurs twice:
    once for the slider position</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// and once to update the
    numwerical value interactively.</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">result</span><span class="c0">,
  </span><span class="c10">max_result_len</span><span class="c0">, </span><span class="c11">LED_TEST_BODY</span><span
    class="c0">, </span><span class="c10">access_led_state</span><span class="c0">&nbsp;? </span><span
    class="c8">&quot;ON&quot;</span><span class="c0">&nbsp;: </span><span class="c8">&quot;OFF&quot;</span><span
    class="c0">, </span><span class="c10">moisture_value</span><span class="c0 c7">,</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
  </span><span class="c10">access_led_state</span><span class="c0">&nbsp;? </span><span class="c8">&quot;
    &quot;</span><span class="c0">&nbsp;: </span><span class="c8">&quot;selected&quot;</span><span class="c0">,
  </span><span class="c10">access_led_state</span><span class="c0">&nbsp;? </span><span
    class="c8">&quot;selected&quot;</span><span class="c0">&nbsp;: </span><span class="c8">&quot; &quot;</span><span
    class="c0 c7">,</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
  </span><span class="c10">access_led_state</span><span class="c0">&nbsp;? </span><span
    class="c8">&quot;LawnGreen&quot;</span><span class="c0">&nbsp;: </span><span
    class="c8">&quot;black&quot;</span><span class="c0 c7">,</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
  </span><span class="c10">test_field</span><span class="c0">, </span><span class="c10">test_field</span><span
    class="c0">, </span><span class="c10">test_field</span><span class="c0">, </span><span
    class="c10">test2_field</span><span class="c0">, </span><span class="c10">test2_field</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// // is it the new page</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c3">strncmp</span><span class="c0">(</span><span class="c10">request</span><span class="c0">, </span><span
    class="c11">NEW_PAGE</span><span class="c0">, </span><span class="c11">sizeof</span><span class="c0">(</span><span
    class="c11">NEW_PAGE</span><span class="c0">) - </span><span class="c15">1</span><span class="c0">) ==
  </span><span class="c15">0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">result</span><span class="c0">,
  </span><span class="c10">max_result_len</span><span class="c0">, </span><span class="c11">NEW_PAGE_BODY</span><span
    class="c0">, </span><span class="c10">count</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// is it the welcome page?</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">else</span><span class="c0">&nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(</span><span class="c3">strncmp</span><span class="c0">(</span><span
    class="c10">request</span><span class="c0">, </span><span class="c11">RPEE2040</span><span class="c0">,
  </span><span class="c11">sizeof</span><span class="c0">(</span><span class="c11">RPEE2040</span><span class="c0">) -
  </span><span class="c15">1</span><span class="c0">) == </span><span class="c15">0</span><span class="c0 c7">)</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">result</span><span class="c0">,
  </span><span class="c10">max_result_len</span><span class="c0">, </span><span class="c11">RPEE2040_BODY</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// is it the main plant parenthood page?</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">else</span><span class="c0">&nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(</span><span class="c3">strncmp</span><span class="c0">(</span><span
    class="c10">request</span><span class="c0">, </span><span class="c11">PLANTPARENTHOOD</span><span class="c0">,
  </span><span class="c11">sizeof</span><span class="c0">(</span><span class="c11">PLANTPARENTHOOD</span><span
    class="c0">) - </span><span class="c15">1</span><span class="c0">) == </span><span class="c15">0</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">int</span><span
    class="c0">&nbsp;</span><span class="c10">m</span><span class="c0">&nbsp;= </span><span class="c15">50</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">params</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// parse the params
    using &#39;&amp;&#39; delimeter</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span
    class="c0">&nbsp;= </span><span class="c3">strtok</span><span class="c0">((</span><span class="c11">char</span><span
    class="c0">&nbsp;*)</span><span class="c10">params</span><span class="c0">,
  </span><span class="c8">&quot;&amp; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">param2</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// the second
    parameter beginning is delimited by an &#39;&amp;&#39;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// these tell the
    graphics thread what numbers to draw</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">sscanf</span><span
    class="c0">(</span><span class="c10">param2</span><span class="c0">, </span><span class="c11">EC_FMT</span><span
    class="c0">, &amp;</span><span class="c10">ec_field</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// if EC reading is
    in millimhos, set units to micromhos</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">ec_field</span><span class="c0">&nbsp;&lt; </span><span
    class="c15">20</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">ec_field</span><span class="c0">&nbsp;= </span><span class="c10">ec_field</span><span class="c0">&nbsp;*
  </span><span class="c15">100</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// set global EC
    value</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">ec_value</span><span
    class="c0">&nbsp;= </span><span class="c10">ec_field</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">result</span><span class="c0">,
  </span><span class="c10">max_result_len</span><span class="c0">, </span><span
    class="c11">PLANTPARENTHOOD_BODY</span><span class="c0">, </span><span class="c10">moisture_value</span><span
    class="c0">, </span><span class="c10">ec_field</span><span class="c0">, </span><span class="c10">message</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span class="c0">&nbsp;</span><span
    class="c10">len</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">// receives brwoser url request, parses out the query string</span></p>
<p class="c6"><span class="c9 c7">// to send to the funciton just above, does some error checking</span></p>
<p class="c6"><span class="c9 c7">// then sends the html back to the browser</span></p>
<p class="c6"><span class="c14">err_t</span><span class="c0">&nbsp;</span><span class="c3">tcp_server_recv</span><span
    class="c0">(</span><span class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span
    class="c0">, </span><span class="c11">struct</span><span class="c0">&nbsp;</span><span
    class="c14">tcp_pcb</span><span class="c0">&nbsp;*</span><span class="c10">pcb</span><span class="c0">,
  </span><span class="c11">struct</span><span class="c0">&nbsp;</span><span class="c14">pbuf</span><span
    class="c0">&nbsp;*</span><span class="c10">p</span><span class="c0">, </span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c10">err</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0">&nbsp;*</span><span class="c10">con_state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_CONNECT_STATE_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c10">p</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;connection closed</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span class="c0">(</span><span
    class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span class="c0 c7">,
    ERR_OK);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">assert</span><span class="c0">(</span><span
    class="c10">con_state</span><span class="c0">&nbsp;&amp;&amp; </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">pcb</span><span class="c0">&nbsp;== </span><span
    class="c10">pcb</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">p</span><span class="c0">-&gt;</span><span class="c10">tot_len</span><span class="c0">&nbsp;&gt;
  </span><span class="c15">0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;tcp_server_recv </span><span class="c10">%d</span><span
    class="c8">&nbsp;err </span><span class="c10">%d</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c10">p</span><span class="c0">-&gt;</span><span
    class="c10">tot_len</span><span class="c0">, </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c2">#if</span><span class="c11">&nbsp;</span><span class="c15 c7">0</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;for (struct pbuf *q = p; q != NULL; q = q-&gt;next)
    {</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEBUG_printf(&quot;in: %.*s\n&quot;,
    q-&gt;len, q-&gt;payload);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c2 c7">#endif</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Copy the request into the
    buffer</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">pbuf_copy_partial</span><span
    class="c0">(</span><span class="c10">p</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">, </span><span class="c10">p</span><span
    class="c0">-&gt;</span><span class="c10">tot_len</span><span class="c0">&nbsp;&gt; </span><span
    class="c11">sizeof</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">) - </span><span class="c15">1</span><span
    class="c0">&nbsp;? </span><span class="c11">sizeof</span><span class="c0">(</span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">) -
  </span><span class="c15">1</span><span class="c0">&nbsp;: </span><span class="c10">p</span><span
    class="c0">-&gt;</span><span class="c10">tot_len</span><span class="c0">, </span><span class="c15">0</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Handle GET request</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c3">strncmp</span><span class="c0">(</span><span
    class="c11">HTTP_GET</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">, </span><span
    class="c11">sizeof</span><span class="c0">(</span><span class="c11">HTTP_GET</span><span class="c0">) -
  </span><span class="c15">1</span><span class="c0">) == </span><span class="c15">0</span><span class="c0 c7">)</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">request</span><span class="c0">&nbsp;= </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">&nbsp;+
  </span><span class="c11">sizeof</span><span class="c0">(</span><span class="c11">HTTP_GET</span><span
    class="c0">);</span><span class="c9 c7">&nbsp;// + space</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">result</span><span class="c0">&nbsp;= </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">result</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// find the params
    start in the request (indicated by &#39;?&#39;)</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">params</span><span class="c0">&nbsp;= </span><span
    class="c3">strchr</span><span class="c0">(</span><span class="c10">request</span><span class="c0">, </span><span
    class="c8">&#39;?&#39;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// find the param
    end (i think) and force a null</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">params</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(*</span><span class="c10">params</span><span class="c0 c7">)</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;*</span><span class="c10">space</span><span class="c0">&nbsp;=
  </span><span class="c3">strchr</span><span class="c0">(</span><span class="c10">request</span><span class="c0">,
  </span><span class="c8">&#39; &#39;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</span><span
    class="c10">params</span><span class="c0">++ = </span><span class="c15">0</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(</span><span class="c10">space</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    &nbsp;*</span><span class="c10">space</span><span class="c0">&nbsp;= </span><span class="c15">0</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2 c7">else</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">params</span><span class="c0">&nbsp;= </span><span class="c11">NULL</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Generate content
    html</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">result_len</span><span class="c0">&nbsp;= </span><span
    class="c3">test_server_content</span><span class="c0">(</span><span class="c10">request</span><span class="c0">,
  </span><span class="c10">params</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">result</span><span class="c0">, </span><span class="c11">sizeof</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result</span><span class="c0 c7">));</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;Request: </span><span
    class="c10">%s</span><span class="c8">?</span><span class="c10">%s</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c10">request</span><span class="c0">, </span><span
    class="c10">params</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;Result: </span><span
    class="c10">%d</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">result_len</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Check we had
    enough buffer space</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result_len</span><span class="c0">&nbsp;&gt; </span><span class="c11">sizeof</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result</span><span class="c0">) - </span><span class="c15">1</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;Too much result data </span><span
    class="c10">%d</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">result_len</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">return</span><span class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span
    class="c0 c7">, ERR_CLSD);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Generate web
    page</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result_len</span><span class="c0">&nbsp;&gt; </span><span class="c15">0</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">header_len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">,
  </span><span class="c11">sizeof</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">), </span><span
    class="c11">HTTP_RESPONSE_HEADERS</span><span class="c0 c7">,</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
    class="c15">200</span><span class="c0">, </span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result_len</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">header_len</span><span class="c0">&nbsp;&gt; </span><span
    class="c11">sizeof</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">) - </span><span class="c15">1</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;Too much header data </span><span
    class="c10">%d</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">header_len</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">return</span><span class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span
    class="c0 c7">, ERR_CLSD);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2 c7">else</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//
    Send redirect</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">header_len</span><span class="c0">&nbsp;=
  </span><span class="c11">snprintf</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">,
  </span><span class="c11">sizeof</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">), </span><span
    class="c11">HTTP_RESPONSE_REDIRECT</span><span class="c0 c7">,</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
    class="c3">ipaddr_ntoa</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">gw</span><span class="c0 c7">));</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;Sending redirect </span><span
    class="c10">%s</span><span class="c8">&quot;</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">headers</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Send the headers
    to the client</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">sent_len</span><span class="c0">&nbsp;= </span><span
    class="c15">0</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c10">err</span><span class="c0">&nbsp;= </span><span
    class="c3">tcp_write</span><span class="c0">(</span><span class="c10">pcb</span><span class="c0">, </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">headers</span><span class="c0">,
  </span><span class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">header_len</span><span
    class="c0">, </span><span class="c15">0</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">err</span><span class="c0 c7">&nbsp;!= ERR_OK)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;failed to write header data
  </span><span class="c10">%d</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">,
  </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">return</span><span class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span
    class="c0">, </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// Send the body to
    the client</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">result_len</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">err</span><span class="c0">&nbsp;= </span><span class="c3">tcp_write</span><span
    class="c0">(</span><span class="c10">pcb</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0">-&gt;</span><span class="c10">result</span><span class="c0">, </span><span
    class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">result_len</span><span class="c0">,
  </span><span class="c15">0</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">if</span><span class="c0">&nbsp;(</span><span class="c10">err</span><span class="c0 c7">&nbsp;!=
    ERR_OK)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c11">DEBUG_printf</span><span class="c0">(</span><span class="c8">&quot;failed to write result data
  </span><span class="c10">%d</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">,
  </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c2">return</span><span class="c0">&nbsp;</span><span class="c3">tcp_close_client_connection</span><span
    class="c0">(</span><span class="c10">con_state</span><span class="c0">, </span><span class="c10">pcb</span><span
    class="c0">, </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_recved</span><span
    class="c0">(</span><span class="c10">pcb</span><span class="c0">, </span><span class="c10">p</span><span
    class="c0">-&gt;</span><span class="c10">tot_len</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">pbuf_free</span><span class="c0">(</span><span
    class="c10">p</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0 c7">&nbsp;ERR_OK;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_server_poll</span><span class="c0">(</span><span
    class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span class="c0">, </span><span
    class="c11">struct</span><span class="c0">&nbsp;</span><span class="c14">tcp_pcb</span><span
    class="c0">&nbsp;*</span><span class="c10">pcb</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0">&nbsp;*</span><span class="c10">con_state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_CONNECT_STATE_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span class="c0">(</span><span
    class="c8">&quot;tcp_server_poll_fn</span><span class="c12">\n</span><span class="c8">&quot;</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span class="c0">&nbsp;</span><span
    class="c3">tcp_close_client_connection</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">, </span><span class="c10">pcb</span><span class="c0">, ERR_OK);</span><span class="c9 c7">&nbsp;//
    Just disconnect clent?</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">void</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_server_err</span><span class="c0">(</span><span
    class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span class="c0">, </span><span
    class="c14">err_t</span><span class="c0">&nbsp;</span><span class="c10">err</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0">&nbsp;*</span><span class="c10">con_state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_CONNECT_STATE_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">err</span><span class="c0 c7">&nbsp;!= ERR_ABRT)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;tcp_client_err_fn </span><span class="c10">%d</span><span
    class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span class="c10">err</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c3">tcp_close_client_connection</span><span class="c0">(</span><span class="c10">con_state</span><span
    class="c0">, </span><span class="c10">con_state</span><span class="c0">-&gt;</span><span class="c10">pcb</span><span
    class="c0">, </span><span class="c10">err</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">//</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c14">err_t</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_server_accept</span><span class="c0">(</span><span
    class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span class="c0">, </span><span
    class="c11">struct</span><span class="c0">&nbsp;</span><span class="c14">tcp_pcb</span><span
    class="c0">&nbsp;*</span><span class="c10">client_pcb</span><span class="c0">, </span><span
    class="c14">err_t</span><span class="c0">&nbsp;</span><span class="c10">err</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_SERVER_T</span><span
    class="c0">&nbsp;*</span><span class="c10">state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_SERVER_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">err</span><span class="c0">&nbsp;!= ERR_OK || </span><span class="c10">client_pcb</span><span
    class="c0">&nbsp;== </span><span class="c11">NULL</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failure in accept</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0 c7">&nbsp;ERR_VAL;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span class="c0">(</span><span
    class="c8">&quot;client connected</span><span class="c12">\n</span><span class="c8">&quot;</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Create the state for the connection</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0">&nbsp;*</span><span class="c10">con_state</span><span class="c0">&nbsp;= </span><span
    class="c3">calloc</span><span class="c0">(</span><span class="c15">1</span><span class="c0">, </span><span
    class="c11">sizeof</span><span class="c0">(</span><span class="c14">TCP_CONNECT_STATE_T</span><span
    class="c0 c7">));</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c10">con_state</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to allocate connect state</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0 c7">&nbsp;ERR_MEM;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">pcb</span><span class="c0">&nbsp;= </span><span class="c10">client_pcb</span><span
    class="c0">;</span><span class="c9 c7">&nbsp;// for checking</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c10">con_state</span><span class="c0">-&gt;</span><span
    class="c10">gw</span><span class="c0">&nbsp;= &amp;</span><span class="c10">state</span><span
    class="c0">-&gt;</span><span class="c10">gw</span><span class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// setup connection to client</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_arg</span><span class="c0">(</span><span
    class="c10">client_pcb</span><span class="c0">, </span><span class="c10">con_state</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_sent</span><span class="c0">(</span><span
    class="c10">client_pcb</span><span class="c0">, </span><span class="c3">tcp_server_sent</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_recv</span><span class="c0">(</span><span
    class="c10">client_pcb</span><span class="c0">, </span><span class="c3">tcp_server_recv</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_poll</span><span class="c0">(</span><span
    class="c10">client_pcb</span><span class="c0">, </span><span class="c3">tcp_server_poll</span><span class="c0">,
  </span><span class="c11">POLL_TIME_S</span><span class="c0">&nbsp;* </span><span class="c15">2</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_err</span><span class="c0">(</span><span
    class="c10">client_pcb</span><span class="c0">, </span><span class="c3">tcp_server_err</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0 c7">&nbsp;ERR_OK;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =======================================</span></p>
<p class="c6"><span class="c9 c7">// called from MAIN to start tcp server</span></p>
<p class="c6"><span class="c9 c7">// =======================================</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">bool</span><span
    class="c0">&nbsp;</span><span class="c3">tcp_server_open</span><span class="c0">(</span><span
    class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">arg</span><span class="c0">, </span><span
    class="c11">const</span><span class="c0">&nbsp;</span><span class="c11">char</span><span
    class="c0">&nbsp;*</span><span class="c10">ap_name</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_SERVER_T</span><span
    class="c0">&nbsp;*</span><span class="c10">state</span><span class="c0">&nbsp;= (</span><span
    class="c14">TCP_SERVER_T</span><span class="c0">&nbsp;*)</span><span class="c10">arg</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span class="c0">(</span><span
    class="c8">&quot;starting server on port </span><span class="c10">%d</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c11">TCP_PORT</span><span class="c0 c7">);</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">struct</span><span class="c0">&nbsp;</span><span
    class="c14">tcp_pcb</span><span class="c0">&nbsp;*</span><span class="c10">pcb</span><span class="c0">&nbsp;=
  </span><span class="c3">tcp_new_ip_type</span><span class="c0 c7">(IPADDR_TYPE_ANY);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c10">pcb</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to create pcb</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c11">false</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">err_t</span><span class="c0">&nbsp;</span><span
    class="c10">err</span><span class="c0">&nbsp;= </span><span class="c3">tcp_bind</span><span class="c0">(</span><span
    class="c10">pcb</span><span class="c0">, IP_ANY_TYPE, </span><span class="c11">TCP_PORT</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">err</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to bind to port </span><span class="c10">%d</span><span
    class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span class="c11">TCP_PORT</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c11">false</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c10">state</span><span class="c0">-&gt;</span><span
    class="c10">server_pcb</span><span class="c0">&nbsp;= </span><span class="c3">tcp_listen_with_backlog</span><span
    class="c0">(</span><span class="c10">pcb</span><span class="c0">, </span><span class="c15">1</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c10">state</span><span class="c0">-&gt;</span><span class="c10">server_pcb</span><span class="c0 c7">)</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to listen</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">pcb</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">tcp_close</span><span
    class="c0">(</span><span class="c10">pcb</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c11">false</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_arg</span><span class="c0">(</span><span
    class="c10">state</span><span class="c0">-&gt;</span><span class="c10">server_pcb</span><span class="c0">,
  </span><span class="c10">state</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">tcp_accept</span><span class="c0">(</span><span
    class="c10">state</span><span class="c0">-&gt;</span><span class="c10">server_pcb</span><span class="c0">,
  </span><span class="c3">tcp_server_accept</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">printf</span><span class="c0">(</span><span
    class="c8">&quot;Try connecting to &#39;</span><span class="c10">%s</span><span class="c8">&#39; with password
    &#39;password&#39;</span><span class="c12">\n</span><span class="c8">&quot;</span><span class="c0">, </span><span
    class="c10">ap_name</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">return</span><span class="c0">&nbsp;</span><span
    class="c11">true</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c6"><span class="c9 c7">//=========================================</span></p>
<p class="c6"><span class="c9 c7">// never truning off wifi in my code</span></p>
<p class="c6"><span class="c9 c7">/*</span></p>
<p class="c6"><span class="c9 c7">// This &quot;worker&quot; function is called to safely perform work when instructed
    by key_pressed_func</span></p>
<p class="c6"><span class="c9 c7">void key_pressed_worker_func(async_context_t *context, async_when_pending_worker_t
    *worker) {</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;//&gt;&gt;&gt;&gt;assert(worker-&gt;user_data);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;printf(&quot;Disabling wifi\n&quot;);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;cyw43_arch_disable_ap_mode();</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;//&gt;&gt;&gt;&gt;((TCP_SERVER_T*)(worker-&gt;user_data))-&gt;complete
    = true;</span></p>
<p class="c6"><span class="c9 c7">}</span></p>
<p class="c6"><span class="c9 c7">*/</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">/*</span></p>
<p class="c6"><span class="c9 c7">static async_when_pending_worker_t key_pressed_worker = {</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;.do_work = key_pressed_worker_func</span></p>
<p class="c6"><span class="c9 c7">};</span></p>
<p class="c6"><span class="c9 c7">*/</span></p>
<p class="c6"><span class="c11">void</span><span class="c0">&nbsp;</span><span class="c3">key_pressed_func</span><span
    class="c0">(</span><span class="c11">void</span><span class="c0">&nbsp;*</span><span class="c10">param</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">assert</span><span class="c0">(</span><span
    class="c10">param</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">int</span><span class="c0">&nbsp;</span><span
    class="c10">key</span><span class="c0">&nbsp;= </span><span class="c3">getchar_timeout_us</span><span
    class="c0">(</span><span class="c15">0</span><span class="c0">);</span><span class="c9 c7">&nbsp;// get any
    pending key press but don&#39;t wait</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">key</span><span class="c0">&nbsp;== </span><span class="c8">&#39;d&#39;</span><span class="c0">&nbsp;||
  </span><span class="c10">key</span><span class="c0">&nbsp;== </span><span class="c8">&#39;D&#39;</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// We are probably in irq context
    so call wifi in a &quot;worker&quot;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//&gt;&gt;&gt;&gt;
    async_context_set_work_pending(((TCP_SERVER_T*)param)-&gt;context, &amp;key_pressed_worker);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c9 c7">// access thread protothread</span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">PT_THREAD</span><span
    class="c0">(</span><span class="c3">protothread_access</span><span class="c0">(</span><span
    class="c11">struct</span><span class="c0">&nbsp;pt *</span><span class="c10">pt</span><span class="c0 c7">))</span>
</p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_BEGIN</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// if (!state)</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// &nbsp; &nbsp;return;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">while</span><span class="c0">&nbsp;(</span><span
    class="c11">true</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">PT_YIELD_usec</span><span
    class="c0">(</span><span class="c15">100000</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_END</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c9 c7">// gpio2 intensity</span></p>
<p class="c6"><span class="c9 c7">// this is really just a test of multitasking</span></p>
<p class="c6"><span class="c9 c7">// compatability with LWIP</span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">PT_THREAD</span><span
    class="c0">(</span><span class="c3">protothread_toggle_gpio2</span><span class="c0">(</span><span
    class="c11">struct</span><span class="c0">&nbsp;pt *</span><span class="c10">pt</span><span class="c0 c7">))</span>
</p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_BEGIN</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// data structure for interval timer</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_INTERVAL_INIT</span><span
    class="c0 c7">();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// set up LED gpio 2</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">gpio_init</span><span class="c0">(</span><span
    class="c15">2</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">gpio_set_dir</span><span class="c0">(</span><span
    class="c15">2</span><span class="c0 c7">, GPIO_OUT);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">gpio_put</span><span class="c0">(</span><span
    class="c15">4</span><span class="c0">, </span><span class="c11">true</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_init</span><span class="c0 c7">();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_gpio_init</span><span class="c0">(</span><span
    class="c11">MOISTURE_PIN</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_select_input</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">while</span><span class="c0">&nbsp;(</span><span
    class="c15">1</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// cheesy PWM</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">PT_YIELD_INTERVAL</span><span
    class="c0">(</span><span class="c15">10000</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">gpio_put</span><span
    class="c0">(</span><span class="c15">2</span><span class="c0">, </span><span class="c11">true</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// intensity % range 0-99
    works</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">PT_YIELD_usec</span><span
    class="c0">(</span><span class="c10">test2_field</span><span class="c0">&nbsp;* </span><span
    class="c15">100</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">gpio_put</span><span
    class="c0">(</span><span class="c15">2</span><span class="c0">, </span><span class="c11">false</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// get moisture reading</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">adc_select_input</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">const</span><span
    class="c0">&nbsp;</span><span class="c11">float</span><span class="c0">&nbsp;</span><span
    class="c10">conversion_factor</span><span class="c0">&nbsp;= </span><span class="c15">3.3f</span><span
    class="c0">&nbsp;/ (</span><span class="c15">1</span><span class="c0">&nbsp;&lt;&lt; </span><span
    class="c15">12</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">moisture_value</span><span
    class="c0">&nbsp;= (</span><span class="c11">float</span><span class="c0">)</span><span
    class="c3">adc_read</span><span class="c0">() * </span><span class="c10">conversion_factor</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">moisture_value</span><span
    class="c0">&nbsp;= </span><span class="c15">100</span><span class="c0">&nbsp;- ((</span><span
    class="c10">moisture_value</span><span class="c0">&nbsp;- </span><span class="c10">wet_reading</span><span
    class="c0">) / (</span><span class="c10">dry_reading</span><span class="c0">&nbsp;- </span><span
    class="c10">wet_reading</span><span class="c0">)) * </span><span class="c15">100</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">moisture_value</span><span class="c0">&nbsp;&lt; </span><span
    class="c15">5.0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span
    class="c10">moisture_value</span><span class="c0">&nbsp;= </span><span class="c15">5.0</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">moisture_value</span><span class="c0">&nbsp;&gt; </span><span
    class="c15">50.0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strncpy</span><span
    class="c0">(</span><span class="c10">message</span><span class="c0">, </span><span class="c8">&quot;Your plant is
    well-fed&quot;</span><span class="c0">, </span><span class="c15">100</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">else</span><span
    class="c0">&nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c10">ec_value</span><span class="c0">&nbsp;&lt;= </span><span class="c15">500</span><span
    class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strncpy</span><span
    class="c0">(</span><span class="c10">message</span><span class="c0">, </span><span class="c8">&quot;Your plant is
    hungry. Add fertilizer until green&quot;</span><span class="c0">, </span><span class="c15">100</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2 c7">else</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strncpy</span><span
    class="c0">(</span><span class="c10">message</span><span class="c0">, </span><span class="c8">&quot;Your plant is
    thirsty. Add water until green&quot;</span><span class="c0">, </span><span class="c15">100</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// strncpy(message, &quot;Your
    plant is thirsty. Add water until green&quot;, 100);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">pt_serial_out_buffer</span><span class="c0">, </span><span
    class="c8">&quot;</span><span class="c12">\n</span><span class="c10">%f</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0">, </span><span class="c10">moisture_value</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// sprintf(pt_serial_out_buffer,
    &quot;hey&quot;);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">serial_write</span><span
    class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">count</span><span class="c0">&nbsp;=
  </span><span class="c10">count</span><span class="c0">&nbsp;+ </span><span class="c15">1</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// sprintf(pt_serial_out_buffer,
    &quot;%f&quot;, 200.0);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// serial_write;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// moisture_value = 700;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// NEVER exit while</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;}</span><span class="c9 c7">&nbsp;// END WHILE(1)</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_END</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">}</span><span class="c9 c7">&nbsp;// blink thread</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c9 c7">// user input</span></p>
<p class="c6"><span class="c9 c7">// ==================================================</span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">PT_THREAD</span><span
    class="c0">(</span><span class="c3">protothread_serial</span><span class="c0">(</span><span
    class="c11">struct</span><span class="c0">&nbsp;pt *</span><span class="c10">pt</span><span class="c0 c7">))</span>
</p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_BEGIN</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">static</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;</span><span class="c10">cmd</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg1</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg2</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg3</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg4</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg5</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0">], </span><span class="c10">arg6</span><span class="c0">[</span><span
    class="c15">16</span><span class="c0 c7">];</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">static</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;*</span><span class="c10">token</span><span class="c0 c7">;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">printf</span><span class="c0">(</span><span
    class="c8">&quot;</span><span class="c12">\n</span><span class="c8">Type &#39;help&#39; for commands</span><span
    class="c12">\n\r</span><span class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">while</span><span class="c0">&nbsp;(</span><span
    class="c15">1</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// pause for 0.1 to let another
    thread print a message</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">PT_YIELD_usec</span><span
    class="c0">(</span><span class="c15">100000</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// print prompt</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">pt_serial_out_buffer</span><span class="c0">, </span><span
    class="c8">&quot;cmd&gt; &quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// sprintf(pt_serial_out_buffer,
    &quot;%f&quot;, &amp;moisture_value);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// spawn a thread to do the
    non-blocking write</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">serial_write</span><span
    class="c0 c7">;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// spawn a thread to do the
    non-blocking serial read</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">serial_read</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// sscanf(pt_serial_in_buffer,
    &quot;%s %f %f %f %f&quot;, arg0, &amp;arg1, arg2, arg3, arg4) ;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// &nbsp;tokenize</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c10">pt_serial_in_buffer</span><span
    class="c0">, </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">cmd</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg1</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg2</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg3</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg4</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg5</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">token</span><span class="c0">&nbsp;=
  </span><span class="c3">strtok</span><span class="c0">(</span><span class="c11">NULL</span><span class="c0">,
  </span><span class="c8">&quot; &nbsp;&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">strcpy</span><span
    class="c0">(</span><span class="c10">arg6</span><span class="c0">, </span><span class="c10">token</span><span
    class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// parse by command</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c3">strcmp</span><span class="c0">(</span><span class="c10">cmd</span><span
    class="c0">, </span><span class="c8">&quot;help&quot;</span><span class="c0">) == </span><span
    class="c15">0</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// filter design
    commands</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">printf</span><span
    class="c0">(</span><span class="c8">&quot;***</span><span class="c12">\n\r</span><span class="c8">get ntp
  </span><span class="c12">\n\r</span><span class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">else</span><span
    class="c0">&nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span class="c3">strcmp</span><span
    class="c0">(</span><span class="c10">cmd</span><span class="c0">, </span><span
    class="c8">&quot;num&quot;</span><span class="c0">) == </span><span class="c15">0</span><span class="c0 c7">)</span>
</p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">sscanf</span><span
    class="c0">(</span><span class="c10">arg1</span><span class="c0">, </span><span class="c8">&quot;</span><span
    class="c10">%d</span><span class="c8">&quot;</span><span class="c0">, &amp;</span><span
    class="c10">user_number</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// no valid command</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2 c7">else</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">printf</span><span
    class="c0">(</span><span class="c8">&quot;Huh?</span><span class="c12">\n\r</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// NEVER exit while</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;}</span><span class="c9 c7">&nbsp;// END WHILE(1)</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_END</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">}</span><span class="c9 c7">&nbsp;// serial thread</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// =========================================</span></p>
<p class="c6"><span class="c9 c7">// graphics thread</span></p>
<p class="c6"><span class="c9 c7">// =========================================</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c11">static</span><span class="c0">&nbsp;</span><span class="c11">PT_THREAD</span><span
    class="c0">(</span><span class="c3">protothread_graphics</span><span class="c0">(</span><span
    class="c11">struct</span><span class="c0">&nbsp;pt *</span><span class="c10">pt</span><span class="c0 c7">))</span>
</p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_BEGIN</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">static</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;</span><span class="c10">video_string</span><span
    class="c0">[</span><span class="c15">80</span><span class="c0 c7">];</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// the protothreads interval timer</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_INTERVAL_INIT</span><span
    class="c0 c7">();</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// background</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">fillRect</span><span class="c0">(</span><span
    class="c15">0</span><span class="c0">, </span><span class="c15">0</span><span class="c0">, </span><span
    class="c15">319</span><span class="c0">, </span><span class="c15">239</span><span class="c0">, </span><span
    class="c11">BLACK</span><span class="c0">);</span><span class="c9 c7">&nbsp;//</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Draw some filled rectangles</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">fillRect</span><span class="c0">(</span><span
    class="c15">0</span><span class="c0">, </span><span class="c15">0</span><span class="c0">, </span><span
    class="c15">76</span><span class="c0">, </span><span class="c15">10</span><span class="c0">, </span><span
    class="c11">BLUE</span><span class="c0">);</span><span class="c9 c7">&nbsp; &nbsp; &nbsp;// blue box</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">fillRect</span><span class="c0">(</span><span
    class="c15">100</span><span class="c0">, </span><span class="c15">0</span><span class="c0">, </span><span
    class="c15">200</span><span class="c0">, </span><span class="c15">10</span><span class="c0">, </span><span
    class="c11">GREEN</span><span class="c0">);</span><span class="c9 c7">&nbsp;// red box</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// fillRect(200, 0, 76, 10, GREEN); // green
    box</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Write some text</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setTextColor</span><span class="c0">(</span><span
    class="c11">WHITE</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setCursor</span><span class="c0">(</span><span
    class="c15">10</span><span class="c0">, </span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setTextSize</span><span class="c0">(</span><span
    class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">writeString</span><span class="c0">(</span><span
    class="c8">&quot;ECE 4760&quot;</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setTextColor</span><span class="c0">(</span><span
    class="c11">BLACK</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setCursor</span><span class="c0">(</span><span
    class="c15">102</span><span class="c0">, </span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">setTextSize</span><span class="c0">(</span><span
    class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">writeString</span><span class="c0">(</span><span
    class="c8">&quot;LWIP: Access point + webserver&quot;</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_init</span><span class="c0 c7">();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_set_temp_sensor_enabled</span><span
    class="c0">(</span><span class="c11">true</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">adc_select_input</span><span
    class="c0">(</span><span class="c15">4</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">while</span><span class="c0">&nbsp;(</span><span
    class="c11">true</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// few times per second</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">PT_YIELD_INTERVAL</span><span
    class="c0">(</span><span class="c15">200000</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextColor2</span><span
    class="c0">(</span><span class="c11">WHITE</span><span class="c0">, </span><span class="c11">BLACK</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setCursor</span><span
    class="c0">(</span><span class="c15">50</span><span class="c0">, </span><span class="c15">80</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextSize</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0">, </span><span class="c8">&quot;LED state
    from /ledtest </span><span class="c10">%d</span><span class="c8">&nbsp; &nbsp; &quot;</span><span class="c0">,
  </span><span class="c10">access_led_state</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">writeString</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">fillCircle</span><span
    class="c0">(</span><span class="c15">35</span><span class="c0">, </span><span class="c15">83</span><span
    class="c0">, </span><span class="c15">5</span><span class="c0">, </span><span
    class="c10">access_led_state</span><span class="c0">&nbsp;? </span><span class="c11">rgb</span><span
    class="c0">(</span><span class="c15">0</span><span class="c0">, </span><span class="c15">7</span><span class="c0">,
  </span><span class="c15">0</span><span class="c0">) : </span><span class="c11">rgb</span><span
    class="c0">(</span><span class="c15">0</span><span class="c0">, </span><span class="c15">3</span><span class="c0">,
  </span><span class="c15">0</span><span class="c0 c7">));</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setCursor</span><span
    class="c0">(</span><span class="c15">50</span><span class="c0">, </span><span class="c15">100</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextSize</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0">, </span><span class="c8">&quot;NUMBER
    input from /ledtest </span><span class="c10">%d</span><span class="c8">&nbsp; &nbsp; &quot;</span><span class="c0">,
  </span><span class="c10">test_field</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">writeString</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setCursor</span><span
    class="c0">(</span><span class="c15">50</span><span class="c0">, </span><span class="c15">120</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextSize</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0">, </span><span class="c8">&quot;GPIO2
    intensity from /ledtest </span><span class="c10">%d%%</span><span class="c8">&nbsp; &quot;</span><span class="c0">,
  </span><span class="c10">test2_field</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">writeString</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// setCursor(50, 140) ;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// setTextSize(1) ;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// sprintf(video_string,
    &quot;Input from server console %d &nbsp; &nbsp;&quot;, user_number) ;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// writeString(video_string)
    ;</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// slider-set color</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">if</span><span
    class="c0">&nbsp;(</span><span class="c10">new_color</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setCursor</span><span
    class="c0">(</span><span class="c15">50</span><span class="c0">, </span><span class="c15">180</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextSize</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0">, </span><span class="c8">&quot;Color
    from slider from /newpage &quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">writeString</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">drawRect</span><span
    class="c0">(</span><span class="c15">119</span><span class="c0">, </span><span class="c15">199</span><span
    class="c0">, </span><span class="c15">42</span><span class="c0">, </span><span class="c15">32</span><span
    class="c0">, </span><span class="c11">GRAY2</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">fillRect</span><span
    class="c0">(</span><span class="c15">120</span><span class="c0">, </span><span class="c15">200</span><span
    class="c0">, </span><span class="c15">40</span><span class="c0">, </span><span class="c15">30</span><span
    class="c0">, </span><span class="c10">color</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">drawRect</span><span
    class="c0">(</span><span class="c15">120</span><span class="c0">, </span><span class="c15">200</span><span
    class="c0">, </span><span class="c15">40</span><span class="c0">, </span><span class="c15">30</span><span
    class="c0">, </span><span class="c11">BLACK</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">new_color</span><span
    class="c0">&nbsp;= </span><span class="c11">false</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp; &nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">const</span><span
    class="c0">&nbsp;</span><span class="c11">float</span><span class="c0">&nbsp;</span><span
    class="c10">conversion_factor</span><span class="c0">&nbsp;= </span><span class="c15">3.3f</span><span
    class="c0">&nbsp;/ (</span><span class="c15">1</span><span class="c0">&nbsp;&lt;&lt; </span><span
    class="c15">12</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// conver to volts</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">float</span><span
    class="c0">&nbsp;</span><span class="c10">result</span><span class="c0">&nbsp;= (</span><span
    class="c11">float</span><span class="c0">)</span><span class="c3">adc_read</span><span class="c0">() *
  </span><span class="c10">conversion_factor</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">// printf(&quot;adc %d v %f
    \n&quot;, adc_read(), result);</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp; &nbsp; &nbsp;/// convert volts to ~temp (from hardare manual)</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c10">temp</span><span class="c0">&nbsp;=
  </span><span class="c15">27.0f</span><span class="c0">&nbsp;- (</span><span class="c10">result</span><span
    class="c0">&nbsp;- </span><span class="c15">0.706f</span><span class="c0">) / </span><span
    class="c15">0.001721f</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setCursor</span><span
    class="c0">(</span><span class="c15">50</span><span class="c0">, </span><span class="c15">160</span><span
    class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">setTextSize</span><span
    class="c0">(</span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">sprintf</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0">, </span><span class="c8">&quot;Internal
    Temp = </span><span class="c10">%3.1f</span><span class="c8">&nbsp;C&quot;</span><span class="c0">, </span><span
    class="c10">temp</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c3">writeString</span><span
    class="c0">(</span><span class="c10">video_string</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">PT_END</span><span class="c0">(</span><span
    class="c10">pt</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">}</span><span class="c9 c7">&nbsp;// graphics thread</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">// === core 1 main -- started in main below</span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c11">void</span><span class="c0">&nbsp;</span><span class="c3">core1_main</span><span
    class="c0 c7">()</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// &nbsp;=== add threads
    &nbsp;====================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// for core 1</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">pt_add_thread</span><span class="c0">(</span><span
    class="c3">protothread_graphics</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// === initalize the scheduler
    ==========</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">pt_schedule_start</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// NEVER exits</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//
    ======================================</span></p>
<p class="c6"><span class="c0 c7">}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c9 c7">// === core 0 main</span></p>
<p class="c6"><span class="c9 c7">// ========================================</span></p>
<p class="c6"><span class="c11">int</span><span class="c0">&nbsp;</span><span class="c3">main</span><span
    class="c0 c7">()</span></p>
<p class="c6"><span class="c0 c7">{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// set the clock -- if you want</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// set_sys_clock_khz(250000, true); //
    171us</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//========================================</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start the serial i/o</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">stdio_init_all</span><span class="c0 c7">();</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//
    ======================================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Initialize the VGA system</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">initVGA</span><span class="c0 c7">();</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// =====================================</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// turn on ADC (move to thread)</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_init();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_set_temp_sensor_enabled(true);</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_select_input(4);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// GPIO INITIALIZE</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// // MAP SPI SIGNAL TO GPIO PORT</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// gpio_set_function(MOISTURE_PIN,
    GPIO_FUNC_SPI);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// gpio_init()</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_init();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_gpio_init(MOISTURE_PIN);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// adc_select_input(1);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// moisture_value = (float) adc_read();</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// gpio_set_dir(MOISTURE_PIN, GPIO_IN);</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//========================================</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// network init</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start the cyw43 in access point mode</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start the DHCP server</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start the DNS server</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start the TCP server</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//
    =======================================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">TCP_SERVER_T</span><span
    class="c0">&nbsp;*</span><span class="c10">state</span><span class="c0">&nbsp;= </span><span
    class="c3">calloc</span><span class="c0">(</span><span class="c15">1</span><span class="c0">, </span><span
    class="c11">sizeof</span><span class="c0">(</span><span class="c14">TCP_SERVER_T</span><span
    class="c0 c7">));</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c10">state</span><span class="c0 c7">)</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to allocate state</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c15">1</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(</span><span
    class="c3">cyw43_arch_init</span><span class="c0 c7">())</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to initialise</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c15">1</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Get notified if the user presses a
    key</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c10">state</span><span class="c0">-&gt;</span><span
    class="c10">context</span><span class="c0">&nbsp;= </span><span class="c3">cyw43_arch_async_context</span><span
    class="c0 c7">();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//&gt;&gt;&gt;&gt; key_pressed_worker.user_data
    = state;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span
    class="c9 c7">//&gt;&gt;&gt;&gt;async_context_add_when_pending_worker(cyw43_arch_async_context(),
    &amp;key_pressed_worker);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">stdio_set_chars_available_callback</span><span
    class="c0">(</span><span class="c3">key_pressed_func</span><span class="c0">, </span><span
    class="c10">state</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// access point SSID and PASSWORD</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// WPA2 authorization</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">const</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;*</span><span class="c10">ap_name</span><span class="c0">&nbsp;=
  </span><span class="c8">&quot;picow_test&quot;</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c2">#if</span><span class="c11">&nbsp;</span><span class="c15 c7">1</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">const</span><span class="c0">&nbsp;</span><span
    class="c11">char</span><span class="c0">&nbsp;*</span><span class="c10">password</span><span class="c0">&nbsp;=
  </span><span class="c8">&quot;password&quot;</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c2 c7">#else</span></p>
<p class="c6"><span class="c9 c7">&nbsp; &nbsp;const char *password = NULL;</span></p>
<p class="c6"><span class="c2 c7">#endif</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">cyw43_arch_enable_ap_mode</span><span
    class="c0">(</span><span class="c10">ap_name</span><span class="c0">, </span><span class="c10">password</span><span
    class="c0 c7">, CYW43_AUTH_WPA2_AES_PSK);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// &#39;state&#39; is a pointer to type
    TCP_SERVER_T</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">ip4_addr_t</span><span
    class="c0">&nbsp;</span><span class="c10">mask</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">IP4_ADDR</span><span class="c0">(</span><span
    class="c3">ip_2_ip4</span><span class="c0">(&amp;</span><span class="c10">state</span><span
    class="c0">-&gt;</span><span class="c10">gw</span><span class="c0">), </span><span class="c15">192</span><span
    class="c0">, </span><span class="c15">168</span><span class="c0">, </span><span class="c15">4</span><span
    class="c0">, </span><span class="c15">1</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">IP4_ADDR</span><span class="c0">(</span><span
    class="c3">ip_2_ip4</span><span class="c0">(&amp;</span><span class="c10">mask</span><span class="c0">),
  </span><span class="c15">255</span><span class="c0">, </span><span class="c15">255</span><span class="c0">,
  </span><span class="c15">255</span><span class="c0">, </span><span class="c15">0</span><span class="c0 c7">);</span>
</p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Start the dhcp server</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// and set picoW IP address from
    &#39;state&#39; structure</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// set &#39;mask&#39; as defined above</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">dhcp_server_t</span><span
    class="c0">&nbsp;</span><span class="c10">dhcp_server</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">dhcp_server_init</span><span
    class="c0">(&amp;</span><span class="c10">dhcp_server</span><span class="c0">, &amp;</span><span
    class="c10">state</span><span class="c0">-&gt;</span><span class="c10">gw</span><span class="c0">,
    &amp;</span><span class="c10">mask</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// Start the dns server</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// and set picoW IP address from
    &#39;state&#39; structure</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c14">dns_server_t</span><span
    class="c0">&nbsp;</span><span class="c10">dns_server</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">dns_server_init</span><span
    class="c0">(&amp;</span><span class="c10">dns_server</span><span class="c0">, &amp;</span><span
    class="c10">state</span><span class="c0">-&gt;</span><span class="c10">gw</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c2">if</span><span class="c0">&nbsp;(!</span><span
    class="c3">tcp_server_open</span><span class="c0">(</span><span class="c10">state</span><span class="c0">,
  </span><span class="c10">ap_name</span><span class="c0 c7">))</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;{</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c11">DEBUG_printf</span><span
    class="c0">(</span><span class="c8">&quot;failed to open server</span><span class="c12">\n</span><span
    class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c2">return</span><span
    class="c0">&nbsp;</span><span class="c15">1</span><span class="c0 c7">;</span></p>
<p class="c6"><span class="c0 c7">&nbsp; &nbsp;}</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//
    ======================================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// init thread communication semaphores</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// init pt strucdtures</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//========================================</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// start core 1 threads --</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">multicore_reset_core1</span><span
    class="c0 c7">();</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">multicore_launch_core1</span><span
    class="c0">(&amp;</span><span class="c3">core1_main</span><span class="c0 c7">);</span></p>
<p class="c5"><span class="c0 c7"></span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// === config threads
    ========================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// for core 0</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// announce the threader version on system
    reset</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">printf</span><span class="c0">(</span><span
    class="c8">&quot;</span><span class="c12">\n\r</span><span class="c8">Starting Protothreads RP2040 v1.1.2
    two-core</span><span class="c12">\n\r</span><span class="c8">&quot;</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// pt_add_thread(protothread_access);</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">pt_add_thread</span><span class="c0">(</span><span
    class="c3">protothread_toggle_gpio2</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c7 c9">// &nbsp; pt_add_thread(protothread_serial)
    ;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// pt_add_thread(protothread_graphics) ;</span>
</p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// === initalize the scheduler
    ===============</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c11">pt_schedule_start</span><span
    class="c0 c7">;</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// NEVER exits</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">//
    ===========================================</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// NEVER gets here</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c9 c7">// tcp_server_close(state);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">dns_server_deinit</span><span
    class="c0">(&amp;</span><span class="c10">dns_server</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">dhcp_server_deinit</span><span
    class="c0">(&amp;</span><span class="c10">dhcp_server</span><span class="c0 c7">);</span></p>
<p class="c6"><span class="c0">&nbsp; &nbsp;</span><span class="c3">cyw43_arch_deinit</span><span
    class="c0 c7">();</span></p>
<p class="c6"><span class="c0">}</span><span class="c9 c7">&nbsp;// end main</span></p>
<p class="c6"><span class="c9 c7">&nbsp;///////////</span></p>
<p class="c6"><span class="c0">&nbsp;</span><span class="c9 c7">// end ////</span></p>
<p class="c6"><span class="c9 c7">&nbsp;///////////</span></p>
<p class="c16 c17"><span class="c7 c54"></span></p>


</html>