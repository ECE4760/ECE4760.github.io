<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw);.lst-kix_ow0etedfydhj-7>li:before{content:"\0025cb   "}.lst-kix_exen0fai9o4a-0>li:before{content:"\0025cf   "}.lst-kix_exen0fai9o4a-1>li:before{content:"\0025cb   "}.lst-kix_lqfz2r7gj6cj-0>li:before{content:"\0025cf   "}.lst-kix_ow0etedfydhj-6>li:before{content:"\0025cf   "}.lst-kix_ow0etedfydhj-8>li:before{content:"\0025a0   "}.lst-kix_exen0fai9o4a-3>li:before{content:"\0025cf   "}.lst-kix_exen0fai9o4a-4>li:before{content:"\0025cb   "}.lst-kix_exen0fai9o4a-5>li:before{content:"\0025a0   "}.lst-kix_lqfz2r7gj6cj-4>li:before{content:"\0025cb   "}.lst-kix_ow0etedfydhj-2>li:before{content:"\0025a0   "}.lst-kix_lqfz2r7gj6cj-5>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-0>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-0}.lst-kix_ow0etedfydhj-1>li:before{content:"\0025cb   "}.lst-kix_exen0fai9o4a-6>li:before{content:"\0025cf   "}ul.lst-kix_tdzaupooyrtc-4{list-style-type:none}ul.lst-kix_tdzaupooyrtc-3{list-style-type:none}ul.lst-kix_tdzaupooyrtc-6{list-style-type:none}ul.lst-kix_tdzaupooyrtc-5{list-style-type:none}ul.lst-kix_tdzaupooyrtc-0{list-style-type:none}ul.lst-kix_tdzaupooyrtc-2{list-style-type:none}ul.lst-kix_tdzaupooyrtc-1{list-style-type:none}.lst-kix_lqfz2r7gj6cj-3>li:before{content:"\0025cf   "}.lst-kix_ow0etedfydhj-3>li:before{content:"\0025cf   "}.lst-kix_lqfz2r7gj6cj-2>li:before{content:"\0025cb   "}.lst-kix_ow0etedfydhj-4>li:before{content:"\0025cb   "}.lst-kix_lqfz2r7gj6cj-1>li:before{content:"\0025a0   "}.lst-kix_ow0etedfydhj-5>li:before{content:"\0025a0   "}.lst-kix_exen0fai9o4a-2>li:before{content:"\0025a0   "}ol.lst-kix_v7cssg7ctvad-3.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-3 0}ol.lst-kix_v7cssg7ctvad-6{list-style-type:none}ol.lst-kix_v7cssg7ctvad-5{list-style-type:none}ol.lst-kix_v7cssg7ctvad-8{list-style-type:none}ol.lst-kix_v7cssg7ctvad-7{list-style-type:none}ol.lst-kix_v7cssg7ctvad-2{list-style-type:none}ol.lst-kix_v7cssg7ctvad-1{list-style-type:none}ol.lst-kix_v7cssg7ctvad-4{list-style-type:none}ol.lst-kix_v7cssg7ctvad-3{list-style-type:none}.lst-kix_lqfz2r7gj6cj-7>li:before{content:"\0025cb   "}.lst-kix_lqfz2r7gj6cj-6>li:before{content:"\0025cf   "}.lst-kix_lqfz2r7gj6cj-8>li:before{content:"\0025a0   "}ol.lst-kix_v7cssg7ctvad-0{list-style-type:none}ul.lst-kix_2milsf8v8yem-7{list-style-type:none}ul.lst-kix_2milsf8v8yem-8{list-style-type:none}.lst-kix_v7cssg7ctvad-8>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-8,lower-roman) ". "}ul.lst-kix_2milsf8v8yem-5{list-style-type:none}ul.lst-kix_2milsf8v8yem-6{list-style-type:none}.lst-kix_v7cssg7ctvad-7>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-7,lower-latin) ". "}ul.lst-kix_2milsf8v8yem-3{list-style-type:none}ul.lst-kix_2milsf8v8yem-4{list-style-type:none}ul.lst-kix_2milsf8v8yem-1{list-style-type:none}.lst-kix_5dqii6l1e9oi-8>li:before{content:"\0025a0   "}ul.lst-kix_2milsf8v8yem-2{list-style-type:none}.lst-kix_v7cssg7ctvad-5>li:before{content:"(" counter(lst-ctn-kix_v7cssg7ctvad-5,lower-roman) ") "}ul.lst-kix_2milsf8v8yem-0{list-style-type:none}.lst-kix_2milsf8v8yem-7>li:before{content:"\0025cb   "}.lst-kix_v7cssg7ctvad-4>li:before{content:"(" counter(lst-ctn-kix_v7cssg7ctvad-4,lower-latin) ") "}.lst-kix_v7cssg7ctvad-6>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-6,decimal) ". "}ol.lst-kix_v7cssg7ctvad-4.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-4 0}.lst-kix_5dqii6l1e9oi-7>li:before{content:"\0025cb   "}.lst-kix_2milsf8v8yem-5>li:before{content:"\0025a0   "}.lst-kix_2milsf8v8yem-6>li:before{content:"\0025cf   "}.lst-kix_5dqii6l1e9oi-6>li:before{content:"\0025cf   "}.lst-kix_5dqii6l1e9oi-3>li:before{content:"\0025cf   "}.lst-kix_5dqii6l1e9oi-5>li:before{content:"\0025a0   "}.lst-kix_5dqii6l1e9oi-0>li:before{content:"\0025cf   "}.lst-kix_5dqii6l1e9oi-4>li:before{content:"\0025cb   "}.lst-kix_2milsf8v8yem-8>li:before{content:"\0025a0   "}.lst-kix_5dqii6l1e9oi-1>li:before{content:"\0025cb   "}.lst-kix_5dqii6l1e9oi-2>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-1>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-1,lower-latin) ") "}.lst-kix_exen0fai9o4a-8>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-0>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-0,decimal) ") "}.lst-kix_v7cssg7ctvad-2>li:before{content:"" counter(lst-ctn-kix_v7cssg7ctvad-2,lower-roman) ") "}.lst-kix_ow0etedfydhj-0>li:before{content:"\0025cf   "}.lst-kix_v7cssg7ctvad-3>li:before{content:"(" counter(lst-ctn-kix_v7cssg7ctvad-3,decimal) ") "}.lst-kix_exen0fai9o4a-7>li:before{content:"\0025cb   "}.lst-kix_xe9oncwu6v9z-6>li:before{content:"\0025cf   "}ul.lst-kix_lqfz2r7gj6cj-6{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-5{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-8{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-7{list-style-type:none}.lst-kix_xe9oncwu6v9z-4>li:before{content:"\0025cb   "}ul.lst-kix_mq7tnd1fcchm-3{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-2{list-style-type:none}ul.lst-kix_9qjhhif97nxq-7{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-1{list-style-type:none}ul.lst-kix_9qjhhif97nxq-8{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-0{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-7{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-6{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-5{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-4{list-style-type:none}ul.lst-kix_mq7tnd1fcchm-8{list-style-type:none}.lst-kix_qt9eadx731rl-5>li:before{content:"\0025a0   "}.lst-kix_xe9oncwu6v9z-8>li:before{content:"\0025a0   "}ul.lst-kix_9qjhhif97nxq-1{list-style-type:none}ul.lst-kix_9qjhhif97nxq-2{list-style-type:none}.lst-kix_qt9eadx731rl-7>li:before{content:"\0025cb   "}ul.lst-kix_9qjhhif97nxq-0{list-style-type:none}ul.lst-kix_9qjhhif97nxq-5{list-style-type:none}ul.lst-kix_9qjhhif97nxq-6{list-style-type:none}ul.lst-kix_9qjhhif97nxq-3{list-style-type:none}ul.lst-kix_9qjhhif97nxq-4{list-style-type:none}ul.lst-kix_81mpwr1a9be7-4{list-style-type:none}ul.lst-kix_81mpwr1a9be7-3{list-style-type:none}.lst-kix_2milsf8v8yem-4>li:before{content:"\0025cb   "}ul.lst-kix_81mpwr1a9be7-6{list-style-type:none}ul.lst-kix_81mpwr1a9be7-5{list-style-type:none}ul.lst-kix_81mpwr1a9be7-0{list-style-type:none}ol.lst-kix_v7cssg7ctvad-7.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-7 0}ul.lst-kix_81mpwr1a9be7-2{list-style-type:none}ul.lst-kix_81mpwr1a9be7-1{list-style-type:none}.lst-kix_xe9oncwu6v9z-2>li:before{content:"\0025a0   "}.lst-kix_2milsf8v8yem-0>li:before{content:"\0025cf   "}ul.lst-kix_81mpwr1a9be7-8{list-style-type:none}ul.lst-kix_81mpwr1a9be7-7{list-style-type:none}.lst-kix_v7cssg7ctvad-7>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-7}.lst-kix_2milsf8v8yem-2>li:before{content:"\0025a0   "}.lst-kix_xe9oncwu6v9z-0>li:before{content:"\0025cf   "}.lst-kix_tdzaupooyrtc-5>li:before{content:"\0025a0   "}.lst-kix_81mpwr1a9be7-5>li:before{content:"\0025a0   "}.lst-kix_81mpwr1a9be7-7>li:before{content:"\0025cb   "}.lst-kix_tdzaupooyrtc-7>li:before{content:"\0025cb   "}.lst-kix_tdzaupooyrtc-3>li:before{content:"\0025cf   "}.lst-kix_97z8uxkg62uq-4>li:before{content:"-  "}.lst-kix_97z8uxkg62uq-8>li:before{content:"-  "}.lst-kix_tdzaupooyrtc-1>li:before{content:"\0025cb   "}.lst-kix_6hpayrxqtez7-0>li:before{content:"\0025cf   "}.lst-kix_6hpayrxqtez7-2>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-8>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-8}.lst-kix_97z8uxkg62uq-6>li:before{content:"-  "}ul.lst-kix_xe9oncwu6v9z-4{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-5{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-2{list-style-type:none}.lst-kix_9qjhhif97nxq-8>li:before{content:"\0025a0   "}ul.lst-kix_xe9oncwu6v9z-3{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-8{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-6{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-7{list-style-type:none}.lst-kix_v7cssg7ctvad-2>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-2}.lst-kix_81mpwr1a9be7-1>li:before{content:"\0025a0   "}.lst-kix_81mpwr1a9be7-3>li:before{content:"\0025cf   "}ul.lst-kix_xe9oncwu6v9z-0{list-style-type:none}ul.lst-kix_xe9oncwu6v9z-1{list-style-type:none}ul.lst-kix_97z8uxkg62uq-8{list-style-type:none}ul.lst-kix_97z8uxkg62uq-6{list-style-type:none}.lst-kix_9qjhhif97nxq-0>li:before{content:"\0025cf   "}.lst-kix_9qjhhif97nxq-2>li:before{content:"\0025a0   "}ul.lst-kix_97z8uxkg62uq-7{list-style-type:none}ul.lst-kix_97z8uxkg62uq-0{list-style-type:none}ul.lst-kix_97z8uxkg62uq-1{list-style-type:none}.lst-kix_6hpayrxqtez7-8>li:before{content:"\0025a0   "}.lst-kix_9qjhhif97nxq-6>li:before{content:"\0025cf   "}ul.lst-kix_tdzaupooyrtc-8{list-style-type:none}ul.lst-kix_97z8uxkg62uq-4{list-style-type:none}ul.lst-kix_tdzaupooyrtc-7{list-style-type:none}ul.lst-kix_97z8uxkg62uq-5{list-style-type:none}ol.lst-kix_v7cssg7ctvad-8.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-8 0}ul.lst-kix_97z8uxkg62uq-2{list-style-type:none}ul.lst-kix_97z8uxkg62uq-3{list-style-type:none}.lst-kix_97z8uxkg62uq-0>li:before{content:"-  "}.lst-kix_6hpayrxqtez7-4>li:before{content:"\0025cb   "}.lst-kix_6hpayrxqtez7-6>li:before{content:"\0025cf   "}.lst-kix_9qjhhif97nxq-4>li:before{content:"\0025cb   "}.lst-kix_97z8uxkg62uq-2>li:before{content:"-  "}ul.lst-kix_ow0etedfydhj-4{list-style-type:none}ul.lst-kix_ow0etedfydhj-5{list-style-type:none}ul.lst-kix_ow0etedfydhj-6{list-style-type:none}ul.lst-kix_ow0etedfydhj-7{list-style-type:none}ul.lst-kix_ow0etedfydhj-8{list-style-type:none}ol.lst-kix_v7cssg7ctvad-6.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-6 0}.lst-kix_mq7tnd1fcchm-0>li:before{content:"\0025cf   "}.lst-kix_mq7tnd1fcchm-1>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-1>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-1}.lst-kix_mq7tnd1fcchm-3>li:before{content:"\0025cf   "}.lst-kix_mq7tnd1fcchm-2>li:before{content:"\0025a0   "}.lst-kix_mq7tnd1fcchm-4>li:before{content:"\0025cb   "}ol.lst-kix_v7cssg7ctvad-0.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-0 0}.lst-kix_mq7tnd1fcchm-6>li:before{content:"\0025cf   "}.lst-kix_mq7tnd1fcchm-7>li:before{content:"\0025cb   "}.lst-kix_mq7tnd1fcchm-5>li:before{content:"\0025a0   "}.lst-kix_mq7tnd1fcchm-8>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-3>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-3}.lst-kix_qt9eadx731rl-2>li:before{content:"\0025a0   "}.lst-kix_qt9eadx731rl-3>li:before{content:"\0025cf   "}.lst-kix_qt9eadx731rl-0>li:before{content:"\0025cf   "}.lst-kix_qt9eadx731rl-1>li:before{content:"\0025cb   "}ul.lst-kix_6hpayrxqtez7-8{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-0{list-style-type:none}ul.lst-kix_6hpayrxqtez7-6{list-style-type:none}ul.lst-kix_6hpayrxqtez7-7{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-2{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-1{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-4{list-style-type:none}ul.lst-kix_lqfz2r7gj6cj-3{list-style-type:none}ul.lst-kix_6hpayrxqtez7-0{list-style-type:none}ul.lst-kix_6hpayrxqtez7-1{list-style-type:none}ol.lst-kix_v7cssg7ctvad-5.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-5 0}ul.lst-kix_6hpayrxqtez7-4{list-style-type:none}ul.lst-kix_ow0etedfydhj-0{list-style-type:none}ul.lst-kix_6hpayrxqtez7-5{list-style-type:none}ul.lst-kix_ow0etedfydhj-1{list-style-type:none}ul.lst-kix_6hpayrxqtez7-2{list-style-type:none}ul.lst-kix_ow0etedfydhj-2{list-style-type:none}ul.lst-kix_6hpayrxqtez7-3{list-style-type:none}ul.lst-kix_ow0etedfydhj-3{list-style-type:none}ul.lst-kix_qt9eadx731rl-7{list-style-type:none}ul.lst-kix_qt9eadx731rl-6{list-style-type:none}ul.lst-kix_qt9eadx731rl-5{list-style-type:none}.lst-kix_xe9oncwu6v9z-7>li:before{content:"\0025cb   "}ul.lst-kix_qt9eadx731rl-4{list-style-type:none}ul.lst-kix_qt9eadx731rl-3{list-style-type:none}ol.lst-kix_v7cssg7ctvad-2.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-2 0}ul.lst-kix_qt9eadx731rl-2{list-style-type:none}ul.lst-kix_qt9eadx731rl-1{list-style-type:none}ul.lst-kix_qt9eadx731rl-0{list-style-type:none}.lst-kix_v7cssg7ctvad-5>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-5}.lst-kix_xe9oncwu6v9z-3>li:before{content:"\0025cf   "}.lst-kix_xe9oncwu6v9z-5>li:before{content:"\0025a0   "}.lst-kix_v7cssg7ctvad-6>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-6}ul.lst-kix_exen0fai9o4a-2{list-style-type:none}ul.lst-kix_exen0fai9o4a-3{list-style-type:none}ul.lst-kix_exen0fai9o4a-0{list-style-type:none}ul.lst-kix_exen0fai9o4a-1{list-style-type:none}.lst-kix_qt9eadx731rl-6>li:before{content:"\0025cf   "}.lst-kix_qt9eadx731rl-4>li:before{content:"\0025cb   "}ul.lst-kix_qt9eadx731rl-8{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-0{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-1{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-2{list-style-type:none}ul.lst-kix_exen0fai9o4a-6{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-3{list-style-type:none}ul.lst-kix_exen0fai9o4a-7{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-4{list-style-type:none}ul.lst-kix_exen0fai9o4a-4{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-5{list-style-type:none}ul.lst-kix_exen0fai9o4a-5{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-6{list-style-type:none}ul.lst-kix_5dqii6l1e9oi-7{list-style-type:none}.lst-kix_qt9eadx731rl-8>li:before{content:"\0025a0   "}ul.lst-kix_5dqii6l1e9oi-8{list-style-type:none}ul.lst-kix_exen0fai9o4a-8{list-style-type:none}.lst-kix_2milsf8v8yem-3>li:before{content:"\0025cf   "}.lst-kix_xe9oncwu6v9z-1>li:before{content:"\0025a0   "}.lst-kix_tdzaupooyrtc-0>li:before{content:"\0025cf   "}.lst-kix_v7cssg7ctvad-4>li{counter-increment:lst-ctn-kix_v7cssg7ctvad-4}.lst-kix_2milsf8v8yem-1>li:before{content:"\0025cb   "}.lst-kix_81mpwr1a9be7-6>li:before{content:"\0025cf   "}.lst-kix_tdzaupooyrtc-6>li:before{content:"\0025cf   "}.lst-kix_97z8uxkg62uq-7>li:before{content:"-  "}.lst-kix_81mpwr1a9be7-4>li:before{content:"\0025cb   "}.lst-kix_81mpwr1a9be7-8>li:before{content:"\0025a0   "}.lst-kix_tdzaupooyrtc-4>li:before{content:"\0025cb   "}.lst-kix_tdzaupooyrtc-2>li:before{content:"\0025a0   "}.lst-kix_tdzaupooyrtc-8>li:before{content:"\0025a0   "}.lst-kix_97z8uxkg62uq-5>li:before{content:"-  "}.lst-kix_6hpayrxqtez7-1>li:before{content:"\0025cb   "}.lst-kix_81mpwr1a9be7-0>li:before{content:"\0025cf   "}.lst-kix_81mpwr1a9be7-2>li:before{content:"\0025a0   "}ol.lst-kix_v7cssg7ctvad-1.start{counter-reset:lst-ctn-kix_v7cssg7ctvad-1 0}.lst-kix_9qjhhif97nxq-1>li:before{content:"\0025cb   "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_9qjhhif97nxq-7>li:before{content:"\0025cb   "}.lst-kix_97z8uxkg62uq-1>li:before{content:"-  "}.lst-kix_6hpayrxqtez7-3>li:before{content:"\0025cf   "}.lst-kix_6hpayrxqtez7-7>li:before{content:"\0025cb   "}.lst-kix_9qjhhif97nxq-5>li:before{content:"\0025a0   "}.lst-kix_97z8uxkg62uq-3>li:before{content:"-  "}.lst-kix_6hpayrxqtez7-5>li:before{content:"\0025a0   "}.lst-kix_9qjhhif97nxq-3>li:before{content:"\0025cf   "}ol{margin:0;padding:0}table td,table th{padding:0}.c14{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c36{margin-left:72pt;padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c32{background-color:#ffffff;padding-top:20pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:center}.c24{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c23{background-color:#ffffff;padding-top:20pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c16{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c0{background-color:#1f1f1f;padding-top:0pt;padding-bottom:0pt;line-height:1.3571428571428572;orphans:2;widows:2;text-align:left}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:center}.c17{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c26{color:#000000;font-weight:700;font-size:11pt;font-family:"Arial"}.c22{color:#000000;font-weight:400;font-size:20pt;font-family:"Arial"}.c31{color:#000000;font-weight:400;font-size:26pt;font-family:"Arial"}.c8{font-size:10.5pt;font-family:"Consolas";color:#dcdcaa;font-weight:400}.c13{font-size:10.5pt;font-family:"Consolas";color:#b5cea8;font-weight:400}.c19{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c25{color:#000000;font-weight:400;font-size:16pt;font-family:"Arial"}.c10{color:#6a9955;font-weight:400;font-size:10.5pt;font-family:"Consolas"}.c5{font-size:10.5pt;font-family:"Consolas";color:#c586c0;font-weight:400}.c20{color:#000000;font-weight:400;font-size:11pt;font-family:"Arial"}.c15{font-size:10.5pt;font-family:"Consolas";color:#4ec9b0;font-weight:400}.c2{font-size:10.5pt;font-family:"Consolas";color:#d4d4d4;font-weight:400}.c12{font-size:10.5pt;font-family:"Consolas";color:#d16969;font-weight:400}.c18{font-size:10.5pt;font-family:"Consolas";color:#d7ba7d;font-weight:400}.c4{font-size:10.5pt;font-family:"Consolas";color:#9cdcfe;font-weight:400}.c9{font-size:10.5pt;font-family:"Consolas";color:#569cd6;font-weight:400}.c1{font-size:10.5pt;font-family:"Consolas";color:#cccccc;font-weight:400}.c11{color:#ce9178;font-weight:400;font-size:10.5pt;font-family:"Consolas"}.c27{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c3{text-decoration:none;vertical-align:baseline;font-style:normal}.c34{border:1px solid black;margin:5px}.c29{padding:0;margin:0}.c7{height:11pt}.c28{margin-left:36pt}.c21{text-indent:36pt}.c33{background-color:#ffffff}.c30{font-weight:700}.c35{font-size:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c27 doc-content"><div><p class="c17"><span class="c20 c3">Edward Gu (elg227) &amp; Filipe Branco (fad28)</span></p><p class="c17"><span class="c20 c3">ECE 4760 Final Report</span></p></div><p class="c21 c36 title" id="h.54xg1z8edi64"><span class="c3 c31">ChatGPT Pico Melodies</span></p><h1 class="c24" id="h.fxz4ot942nua"><span class="c22 c3">Project Introduction</span></h1><p class="c17"><span class="c20 c3">Sound Bite: We demonstrate a ChatGPT user interface for music generation with a keypad connected to an RP2040.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span>Summary</span><sup><a href="#cmnt1" id="cmnt_ref1">[a]</a></sup><span class="c20 c3">: In this project, we successfully built an audio synthesizer that plays musical melodies of various lengths and styles generated by ChatGPT. The user has control over the key the melody is in via presses of a keypad, as well as control over the length and style of the generated melody through simple edits to the prompt. Our implementation consists of a python file that uses the ChatGPT API to produce the melodies (run on the host computer), and a C file that runs on the RP2040 and communicates with the python file by sending the key pressed to the host and receives the melody from the host. </span></p><h1 class="c24" id="h.dvpwp8joq6n1"><span class="c3 c22">High level design</span></h1><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Given the rise of LLMs such as GPT4, we were inspired by how powerful and capable such AI models were, especially in the creative domain. Our group was interested in leveraging the OpenAI API to &lsquo;talk&rsquo; to GPT4 and have it send information back and forth with our RP2040, in the hopes of being among the first to utilize the capabilities of ChatGPT on the edge in this way. One natural way to accomplish this is to use the Pico for inputting information, via a keypad, to ChatGPT, and then receive the parsed output from ChatGPT to output the GPT generated melody. We decided to correspond each key on the keypad to a musical note: for example 1 on the keypad would correspond to the note A, 2 on the keypad would correspond to the note B, etc. Once the user presses on any of the first 7 keys (A to G), that note would be included in the prompt to ChatGPT, asking the model to generate a short melody of 10 notes (could be more notes or less notes, although we discovered some prompt limits which we will discuss later on) in the major key (could be minor or augmented or diminished or anything else). In order to use the ChatGPT API, we had to pay $30 worth of tokens in order to prompt the model during all of our testing and our demo. The most challenging aspect of this project was figuring out the sending and receiving of data between the python file (host computer) and the C file (RP2040).</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Initially, we wanted to port a lightweight trained model for speech detection onto the Pico for inference. Hence, we experimented with Tensorflow Lite and micropython, with the hopes of having a person speak into a microphone their health symptoms, have a pre-trained ML model on the Pico parse and understand the speech in real-time, send this data to ChatGPT to process and come up with a diagnosis or ask follow-up questions, and then send the model output back to the Pico to be output through a speaker. However, after numerous discussions we decided that the RP2040 Pico was not naturally designed for running ML models, which requires hefty storage of all of its parameters. Instead, we can have an ML model, still ChatGPT, run on servers designed to host the pretrained models, and have it also act as a user interface with the Pico, where the Pico can then operate with its natural intent - user can interact with the Pico via keypad and the Pico can output music. We chose to go with GPT music generation because 1) we wanted to test out the creativity capabilities of ChatGPT (e.g. turning on and off an LED or controlling a car&rsquo;s turning are tasks where using ChatGPT seems superfluous/unnecessary), 2) this task is very feasible for LLMs to accomplish, 3) we can easily evaluate how good the model output is just by listening to the melody and see if it sounds good/as expected or not (e.g. Is the first note the note of the key that was pressed? Is the melody in the right key?), and 4) we liked music. There were certainly plenty of resources available online about using the ChatGPT API and prompt engineering, which we utilized for this project. Because our project required sound output and some form of a keypad, we used Lab 1 as influence for both our hardware setup and software implementation. </span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">There aren&rsquo;t many additional hardware related tradeoffs different from lab 1, since our hardware setup is almost identical to lab 1. There aren&rsquo;t any existing patents, copyrights, or trademarks that are relevant to our project.</span></p><h1 class="c23" id="h.pwb05agke22r"><span>Program/Hardware design</span></h1><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">The Program to Hardware connections are as follows: </span></p><ol class="c29 lst-kix_v7cssg7ctvad-0 start" start="1"><li class="c14 li-bullet-0"><span class="c20 c3">the Host (Computer I/O) waits for a keypad input from the keypad to be processed in the RP2040.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">the RP2040 processes the keypad input and assigns a musical key to each keypad key (here there are two definitions of the word &ldquo;key&rdquo;)&mdash; 2 corresponds to A major, 3 to B major, 4 to C major, etc.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">Depending on which key is pressed, the RP2040 sends a message to the host through UART which then gets sent to ChatGPT as a prompt.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">After creating a 10 note melody in the designated key, the host sends back a serial signal to the RP2040 .</span></li><li class="c14 li-bullet-0"><span class="c20 c3">The RP2040 then processes this array as in the format of a 20 length array of [frequencies, durations].</span></li><li class="c14 li-bullet-0"><span class="c20 c3">The RP2040 then plays the 10 notes through the PWM and outputs on the speakers.</span></li></ol><h2 class="c16" id="h.cg6alkcivvae"><span>Hardware Setup</span></h2><h1 class="c32" id="h.arb979m1k9xz"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 283.13px; height: 377.50px;"><img alt="" src="images/image3.jpg" style="width: 283.13px; height: 377.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></h1><p class="c6"><span class="c30">Figure 1: </span><span class="c20 c3">Hardware Setup</span></p><p class="c6 c7"><span class="c26 c3"></span></p><p class="c6"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 465.50px; height: 349.13px;"><img alt="" src="images/image1.jpg" style="width: 465.50px; height: 349.13px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c6"><span class="c30 c35">Figure 2: </span><span class="c20 c3">Hardware setup (top view)</span></p><p class="c17 c7 c21"><span class="c20 c3"></span></p><p class="c17 c21"><span>In Figures 1 and 2, we can see the hardware implementation including the keypad on the bottom left where we send input signals to the DAC. It is almost identical in setup to the Bird Sound Synthesis lab &ndash; it is connected to the RP2040 which is located on the right and connected to the lab computer as well as the serial jack (seen in the blue), and the audio jack which feeds into a speaker via a 3.5mm audio socket that outputs generated beeps. The DAC is connected (to send SPI signals) to the Pico by connecting each of the ports following the DAC datasheet and the #define statements in the source code. </span><span class="c33">The DAC pins are VDD, chip select, the clock line, SDI (same as MOSI), VoutA (one of the outputs), VSS is ground, VOUTB (the other output) and the LDAC pin. The LDAC pin allowed us to separately load the left and right channels for the DAC and then, when that pin is toggled, both are sent to the output simultaneously.</span><span class="c20 c3">&nbsp;A similar procedure was done for the 3.5mm audio socket, which had two pin configurations, not including its GND of course. </span></p><p class="c6"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 342.50px; height: 185.25px;"><img alt="" src="images/image2.png" style="width: 342.50px; height: 185.25px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c6"><span class="c30">Figure 3: </span><span class="c20 c3">Diagram of Hardware Setup</span></p><p class="c17 c7"><span class="c20 c3"></span></p><h2 class="c16" id="h.wjqt6n58t7ek"><span class="c25 c3">Python ChatGPT Script</span></h2><p class="c17 c21"><span>Because the ChatGPT API is a python library that can easily be imported, we chose to have one file dedicated to solely running all of the ChatGPT-related calls. In our python script, run by the host computer, we modularized our code into 3 primary functions, one that uses the </span><span>openai</span><span class="c20 c3">&nbsp;library to prompt ChatGPT and receive its response, one that corresponds each musical note into its corresponding frequency that can be output by the Pico, and one that cleans and processes the response from ChatGPT. </span></p><p class="c17 c7 c21"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In the chat_with_gpt_for_melody(note_key) function, we include our personal OpenAI API key, our prompt, and the ChatCompletion.create(model=&rdquo;gpt-4&rdquo;, messages=[{&ldquo;role&rdquo;: &ldquo;system&rdquo;, &ldquo;content&rdquo;: &ldquo;You are a helpful music assistant.&rdquo;}, {&ldquo;role&rdquo;: &ldquo;user&rdquo;, &ldquo;content&rdquo;: prompt}]) which asks ChatGPT to give us our melody output. This function is highly customizable, but we mainly wanted to demonstrate the baseline concept of using the ChatGPT API in this project. The prompt that worked most consistently for us was:</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17 c28"><span class="c20 c3">&quot;Create a short melody of 10 notes in the key of {note_key}. Make sure that the first note is the {note_key}. Provide the notes and their durations in a list. Example format: [A4,500,B4,300,C5,400]&quot;.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">Note_key here is the parameter that is passed in from the C file that handles the Pico key press, and we include that here in our prompt. We realized that if we did not include the example format, ChatGPT would not reliably always output the array that we ultimately wanted. The output of this function contains the entire output from ChatGPT, including the key piece of information which is a list of music notes and their corresponding durations in milliseconds in the immediate next element of the list (e.g. [A4, 400, B4, 500, F5, 250]). We tried including things in our prompt that would cause ChatGPT to output melodies in different styles (e.g. Christmas) or different clefs (e.g. treble or base), and it was able to generate melodies that matched such modifications to our prompt, but not entirely reliable every time (more qualitative than quantitative as well). </span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The next function note_to_frequency(note) simply contains a dictionary of notes (e.g. A4, B4, C#5) as the keys and their corresponding frequencies as the values. We only included 22 notes here out of at least 88 possible keys (of the piano) for simplicity. The function would take in the parameter of the note, and return its corresponding value from the dictionary.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The clean_melody_response(response) function is necessary because everytime ChatGPT outputs a response, it contains a lot of extraneous information (to act more like a chatbot rather than a search engine) besides the array of music notes and durations that we ultimately want. Thus, we need to go through each character of the output and only keep the information contained within square brackets (e.g. [A4, 400, B4, 500, F5, 250]). Afterwards, we use the note_to_frequency function to convert every other element of the list (starting from the first element) into its corresponding 3-character frequency.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In our main function, we have one continuously running while loop that is constantly listening for incoming data from the Pico (which is the key press). Once it receives the data via serial (using ser.readline() where ser is imported </span><span>pyserial</span><span class="c20 c3">&nbsp;library), it calls the chatgpt function to get the melody, cleans the melody using the clean melody function, and then writes the cleaned melody in the form of a string, back to the RP2040 using ser.write(melody.encode()). Because we are using one COM port to communicate through from both the python file (host computer) and the C file (Pico), we can&rsquo;t use PuTTy to see what is being printed out at each step of the pipeline, we chose to use the python file to print out everything that the user sees, such as what the melody list produced by GPT and played by the Pico looks like, or what key they pressed. </span></p><h2 class="c16" id="h.gm1e26zijjac"><span class="c25 c3">C Script</span></h2><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In our C script, we have 2 protothreads, one that is responsible for scanning the keypad and sending the pressed key over to the host computer, and one that is responsible for parsing and playing the melody. Most of the libraries that we need are kept from Lab1, with the exception of defining 2 PWM pins (18 &amp; 19) and PWM parameters such as CLKDIV, slice_num, and frequency.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Our first thread contains a while loop that is always running (we can physically see this with a blinking LED) and a for loop that is scanning the entire keypad continuously until a button is pressed and the musical note corresponding to that button is sent to the host computer for ChatGPT processing. Once a button is pressed, we look for a valid keycode (12 possibilities on the keypad) and if there exists one (both button, keycodes[12], and scancodes[4] are unsigned global integer variables) then we proceed to the logic that determines which musical note key to be sent to the python file. If the current key does not equal the previous key and State0 equals 0 (default is that State0 = 0), then we find the if branch that matches the key that we pressed (e.g. 1, 2, 3,..., 7) and within the conditional branch, call uart_puts(uart0, &ldquo;major key\n&rdquo;) and change State0 to 1. The uart_puts function sends the string containing the note key pressed to the python file, which can then be included in the prompt sent to ChatGPT. The purpose of changing the volatile unsigned int State0 is so that thread 2 knows when to execute the parsing and playing of the melody whenever State0 is equal to 1 (thread 2 doesn&rsquo;t execute if State0 is equal to 0). Ultimately, setting the variable of State0 did not end up mattering when we moved away from the ISR, especially since thread 2 wouldn&rsquo;t execute anyway until data is received from the python file, which only occurs after thread 1 sends the note pressed.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The second protothread that we have running at all times is used to receive the output from ChatGPT via serial_read, parse the list of frequencies and durations into separate arrays containing just the frequencies and just the durations, and then play the melody using PWM. We have 2 global int arrays defined as frequencies[] and durations[] of fixed length 10 or 20 (size of array depends on how many notes we want ChatGPT to generate). The static variables that we maintain within this thread are int note_count = 0, bool is_frequency = true, and char *token. We first call serial_read which waits for serial data to be read, and then we check if data is received in the pt_serial_in_buffer and if State0 equals 1. If data is received, we parse the received string token by token, separated by commas. If the current token isn&rsquo;t NULL and the note_count is less than the size of the list (if there are 10 notes played, then there are 10 frequencies and 10 durations in the list, so the size will be 20), then we store the values of each token in the frequencies and durations lists. The first token stored will always be in the frequencies list, and the second token will always be in the </span><span>durations</span><span class="c20 c3">&nbsp;list, and this pattern will alternate until a NULL character is found at the end (thus the size of the list will always be an even number). To handle storing in different lists each time, we have a simple boolean flag is_frequency that controls such execution: if it is true then the note will be stored in the frequencies list and is_frequency is set to false, if it is false then the note will be stored in the durations list and is_frequency is set to true. The loop ends when the current token from the buffer is a null character, indicating the end of the list. Once we have both of our lists, we have a for loop that loops through both lists and plays the melody. We call pwm_set_wrap(slice_num, WRAPVAL) and then pwm_set_clkdiv(slice_num, CLKDIV) where CLKDIV uses each element of our frequencies list. We set the channel level of one of our PWM ports to be 2500 and enable the mask to play a note. This note will play for the amount of time defined in each element of our durations list (using sleep_ms). Then the note stops playing by calling the same PWM functions as before (except enabling the mask) but setting the channel level of the PWM port to be 0 causes the note to stop playing. We also add a 100 ms delay between each note being played.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In the main function, we simply keep all of the relevant initializations for UART, PWM, GPIOs, etc. and add our 2 threads. Whenever we want to demo our project or test to see if the entire process works, we simply build the CMake files (same as lab 1 with the exception of adding PWM), move the beep_beep uf2 file into our Pico, and then run the ChatGPT python file. The user will be asked to press a key on the keypad, where the prompt explains that pressing 1 equals A major, 2 equals B major, etc. Once the key is pressed, there will be a few seconds (under 5 seconds) of waiting time for ChatGPT to generate its response, and then the melody can be heard on the speakers.</span></p><h2 class="c16" id="h.cclu7ygvic1z"><span class="c25 c3">Testing &amp; Fixes</span></h2><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There were many issues that we encountered throughout our implementation and overcame. Firstly, we tried to use an ISR for DDS to output the melodies, however, we would always run into concurrency issues that stemmed from the ISR. Sometimes, the melody would not be played at all and an infinite loop would result; other times only 3 or 4 notes of the melody would be played. We think these weird behaviors may have been caused by our lack of a well-defined debouncing machine, even though we did not really need one since the user only presses the keypad once for a melody to be played and if the user chooses to press the keypad multiple times, only the first key press will be registered. We thought that the ISR might be interfering with our sending data back and forth between the Pico and the host computer, but print statements showed that data was indeed being sent and received. Because debugging the sound output was tedious, we decided to try out PWM instead, which only required two additional GPIO pins to set up and did not need any ISR or DDS. This way we can include our logic for playing the melody within one of our protothreads directly, which makes the multithreading issues much simpler to resolve. By using PWM, we immediately had a successful output of the melody through the speakers and it would work just about every time without fail.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Previously, instead of using serial_read to get the entire string from the python file, we tried using uart_getc (there was no method called uart_gets, which would supposedly get the entire string much like uart_puts puts the entire string to the serial connection) which gets every character individually from the buffer. This method was not only much more tedious, increasing the time complexity, but also did not work reliably due to concurrency issues. We tried storing the tokens from uart_getc in both a character array as well as an integer array, but both could not resolve these issues.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Another issue that we faced was the prompting of ChatGPT being volatile, since the chatbot would not reliably output what we wanted every single time. We also found that our current prompt doesn&rsquo;t work so well with very few notes (&lt;3) or too many notes (20&lt;), so modifications to the prompt will need to be made to accommodate these changes.</span></p><h1 class="c23" id="h.g4qg8c598j9v"><span class="c22 c3">Results of the design</span></h1><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We were successful in having ChatGPT produce an interesting melody in the key that we pressed and we verified through using the oscilloscope and an iPhone app that the frequencies that were being output corresponded to the correct notes. Overall, the first note that was produced in the melodies was the key that we pressed, which we wanted. The rest of the notes would be in the key of the note that we pressed and the number of notes in the melody would always correspond to the number of notes we specified in the prompt to ChatGPT. The melodies themselves would have arpeggios and some scales (consecutive notes up or down the measure) and sounded pleasant.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17"><span class="c3 c20">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The speed of the execution is almost entirely dependent upon how quickly ChatGPT would be able to generate the melody based on our prompt. Thus, we focused on making our prompt as reliable and concise as possible so that ChatGPT would spend just a few seconds to produce the melody. Otherwise, there is very low latency between the time when the user presses the keypad to when sound is output through the speakers. After switching to PWM, we no longer faced any concurrency issues that hindered us greatly in our DDS implementation. </span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17 c21"><span class="c20 c3">Our project has no safety concerns that we can think of. The project is highly usable for anyone since all that is required to generate melodies</span></p><h1 class="c23" id="h.wi5i0d6tcqzh"><span class="c22 c3">Conclusions</span></h1><p class="c17"><span class="c20 c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Overall, we were proud of our final project and ultimately succeeded in having ChatGPT generate different melodies each time a new key is pressed. Our expectations since the start of the project were met, although there are many improvements that can be made. I think our structure of having a python file in charge of using the ChatGPT API and a C file that handles the Pico controls, and communicating over UART and Serial works well with low latency. We were initially worried that the prompting of ChatGPT would be too volatile and would not output the correct array of frequencies and durations (or even an array at all), but after thorough prompt engineering, the output from ChatGPT works almost 100% of the time. Our testing methodology of using the python script to print out what is going on at every stage of the pipeline, whether that&rsquo;s in the protothreads or in the python function, was crucial in our debugging.</span></p><p class="c17 c7"><span class="c20 c3"></span></p><p class="c17 c21"><span>Given more time, w</span><span>e wanted to completely finish adding a record mode by pressing 0 on the keypad, where many keys can be pressed (until the 0 key is pressed again), so that we can have an initial melody of a few notes that chatgpt can then take to create an even more elaborate melody, instead of creating a melody solely based on one key press.</span><span class="c20 c3">&nbsp;We can then save whatever melody was generated in some database file so that if the user wanted to play it back in the future, they could do so easily. If such data was stored, there could be much more elaborate songs/compositions that can be constructed by GPT, just by simply prompting it with multiple melodies that it had prompted earlier. We wanted to push the limits to see if it can generate different harmonies (chords perhaps) instead of just a singular melody</span></p><p class="c17 c7"><span class="c3 c26"></span></p><p class="c17 c21"><span>We adapted our C code from lab 1 due to its similarity with what we were trying to achieve, although our code differs due to additional protothreads, using PWM instead of an ISR for DDS, not using a VGA display, and overall logic. We did not use any of Altera&rsquo;s IP, did not code in the public domain, did not need to deal with patent/trademark issues, and did not have to sign a non-disclosure agreement to get a sample part. There are certainly a myriad of future possibilities that combine LLMs with embedded devices that may lead to patent opportunities.</span></p><h1 class="c24" id="h.vmu4dwqx1zyv"><span class="c22 c3">Appendix A</span></h1><ul class="c29 lst-kix_6hpayrxqtez7-0 start"><li class="c14 li-bullet-0"><span class="c20 c3">&quot;The group approves this report for inclusion on the course website.&quot;</span></li><li class="c14 li-bullet-0"><span class="c20 c3">&quot;The group approves the video for inclusion on the course youtube channel.&quot;</span></li></ul><h1 class="c23" id="h.e6g8cc87fkcu"><span class="c22 c3">Additional Appendices</span></h1><h2 class="c16" id="h.2816nlizb0pk"><span class="c25 c3">Primary Task Distribution</span></h2><p class="c17"><span class="c20 c3">Both members contributed to all aspects of the project, these were the focuses of each team member:</span></p><ul class="c29 lst-kix_qt9eadx731rl-0 start"><li class="c14 li-bullet-0"><span class="c20 c3">Edward: Ideation of project, ChatGPT python script, C script, debugging</span></li><li class="c14 li-bullet-0"><span class="c20 c3">Filipe: Building the hardware setup, C script, debugging</span></li></ul><h2 class="c16" id="h.s3ysbxf7vloa"><span class="c25 c3">References</span></h2><ul class="c29 lst-kix_2milsf8v8yem-0 start"><li class="c14 li-bullet-0"><span class="c20 c3">We used the ChatGPT API documentation to help us reliably communicate with ChatGPT through the terminal.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">We used the RP2040 datasheets and Lab1 as references.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">Our PWM implementation is adapted from a fellow student, Pelham, who was also having trouble with DDS and was successful in using PWM.</span></li><li class="c14 li-bullet-0"><span class="c20 c3">All materials used are from Lab1.</span></li></ul><h2 class="c16" id="h.iufg7c7tbbmu"><span class="c25 c3">Python Script</span></h2><p class="c0"><span class="c5">import</span><span class="c1">&nbsp;</span><span class="c15 c3">serial</span></p><p class="c0"><span class="c5">import</span><span class="c1">&nbsp;</span><span class="c15 c3">openai</span></p><p class="c0"><span class="c5">import</span><span class="c1">&nbsp;</span><span class="c15 c3">time</span></p><p class="c0"><span class="c5">import</span><span class="c1">&nbsp;</span><span class="c15 c3">re</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3"># Initialize the serial connection to the RP2040</span></p><p class="c0"><span class="c4">com_port</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c11">&#39;COM3&#39;</span><span class="c1 c3">&nbsp; </span></p><p class="c0"><span class="c4">baud_rate</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13 c3">115200</span></p><p class="c0"><span class="c4">ser</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c15">serial</span><span class="c1">.</span><span class="c15">Serial</span><span class="c1">(</span><span class="c4">com_port</span><span class="c1">, </span><span class="c4">baud_rate</span><span class="c1">, </span><span class="c4">timeout</span><span class="c2">=</span><span class="c13">1</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">def</span><span class="c1">&nbsp;</span><span class="c8">chat_with_gpt_for_melody</span><span class="c1">(</span><span class="c4">note_key</span><span class="c1 c3">):</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c15">openai</span><span class="c1">.api_key </span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c11">&#39;&#39;</span><span class="c1 c3">&nbsp; </span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">prompt</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c9">f</span><span class="c11">&quot;Create a short Christmas melody of 10 notes in the key of </span><span class="c9">{</span><span class="c4">note_key</span><span class="c9">}</span><span class="c11">. </span><span class="c9 c3">\</span></p><p class="c0"><span class="c11">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Make sure that the first note is the </span><span class="c9">{</span><span class="c4">note_key</span><span class="c9">}</span><span class="c11">. </span><span class="c9 c3">\</span></p><p class="c0"><span class="c11">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Provide the notes and their durations in a list. </span><span class="c9 c3">\</span></p><p class="c0"><span class="c11 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Example format: [A4,500,B4,300,C5,400]&quot;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">response</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c15">openai</span><span class="c1 c3">.ChatCompletion.create(</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">model</span><span class="c2">=</span><span class="c11">&quot;gpt-4&quot;</span><span class="c1 c3">,</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">messages</span><span class="c2">=</span><span class="c1">[{</span><span class="c11">&quot;role&quot;</span><span class="c1">: </span><span class="c11">&quot;system&quot;</span><span class="c1">, </span><span class="c11">&quot;content&quot;</span><span class="c1">: </span><span class="c11">&quot;You are a helpful music assistant.&quot;</span><span class="c1 c3">},</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><span class="c11">&quot;role&quot;</span><span class="c1">: </span><span class="c11">&quot;user&quot;</span><span class="c1">, </span><span class="c11">&quot;content&quot;</span><span class="c1">: </span><span class="c4">prompt</span><span class="c1 c3">}]</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; )</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">return</span><span class="c1">&nbsp;</span><span class="c4">response</span><span class="c1">.choices[</span><span class="c13">0</span><span class="c1">].message[</span><span class="c11">&#39;content&#39;</span><span class="c1 c3">]</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">def</span><span class="c1">&nbsp;</span><span class="c8">note_to_frequency</span><span class="c1">(</span><span class="c4">note</span><span class="c1 c3">):</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">note_frequencies</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1 c3">&nbsp;{</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c11">&#39;A4&#39;</span><span class="c1">: </span><span class="c13">440</span><span class="c1">, </span><span class="c11">&#39;B4&#39;</span><span class="c1">: </span><span class="c13">493</span><span class="c1">, </span><span class="c11">&#39;C4&#39;</span><span class="c1">: </span><span class="c13">261</span><span class="c1">, </span><span class="c11">&#39;C#4&#39;</span><span class="c1">: </span><span class="c13">277</span><span class="c1">, </span><span class="c11">&#39;D4&#39;</span><span class="c1">: </span><span class="c13">293</span><span class="c1">, </span><span class="c11">&#39;D#4&#39;</span><span class="c1">: </span><span class="c13">311</span><span class="c1">, </span><span class="c11">&#39;E4&#39;</span><span class="c1">: </span><span class="c13">329</span><span class="c1 c3">,</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c11">&#39;F4&#39;</span><span class="c1">: </span><span class="c13">349</span><span class="c1">, </span><span class="c11">&#39;F#4&#39;</span><span class="c1">: </span><span class="c13">370</span><span class="c1">, </span><span class="c11">&#39;G4&#39;</span><span class="c1">: </span><span class="c13">392</span><span class="c1">, </span><span class="c11">&#39;G#4&#39;</span><span class="c1">: </span><span class="c13">415</span><span class="c1">, </span><span class="c11">&#39;A5&#39;</span><span class="c1">: </span><span class="c13">880</span><span class="c1">, </span><span class="c11">&#39;B5&#39;</span><span class="c1">: </span><span class="c13">987</span><span class="c1">, </span><span class="c11">&#39;C5&#39;</span><span class="c1">: </span><span class="c13">523</span><span class="c1 c3">,</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c11">&#39;C#5&#39;</span><span class="c1">: </span><span class="c13">554</span><span class="c1">, </span><span class="c11">&#39;D5&#39;</span><span class="c1">: </span><span class="c13">587</span><span class="c1">, </span><span class="c11">&#39;D#5&#39;</span><span class="c1">: </span><span class="c13">622</span><span class="c1">, </span><span class="c11">&#39;E5&#39;</span><span class="c1">: </span><span class="c13">659</span><span class="c1">, </span><span class="c11">&#39;F5&#39;</span><span class="c1">: </span><span class="c13">698</span><span class="c1">, </span><span class="c11">&#39;F#5&#39;</span><span class="c1">: </span><span class="c13">740</span><span class="c1">, </span><span class="c11">&#39;G5&#39;</span><span class="c1">: </span><span class="c13">784</span><span class="c1">, </span><span class="c11">&#39;G#5&#39;</span><span class="c1">: </span><span class="c13">830</span><span class="c1 c3">,</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># Continue for other notes as needed</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">return</span><span class="c1">&nbsp;</span><span class="c4">note_frequencies</span><span class="c1">.</span><span class="c8">get</span><span class="c1">(</span><span class="c4">note</span><span class="c1">, </span><span class="c2">-</span><span class="c13">1</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">def</span><span class="c1">&nbsp;</span><span class="c8">clean_melody_response</span><span class="c1">(</span><span class="c4">response</span><span class="c1 c3">):</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">melody_matches</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c15">re</span><span class="c1">.</span><span class="c8">findall</span><span class="c1">(</span><span class="c9">r</span><span class="c12">&#39;</span><span class="c11">([</span><span class="c12">A-G</span><span class="c11">][</span><span class="c12">#b</span><span class="c11">]</span><span class="c18">?</span><span class="c11">[</span><span class="c12">0-9</span><span class="c11">])</span><span class="c12">,</span><span class="c11">(</span><span class="c12">\d</span><span class="c18">+</span><span class="c11">)</span><span class="c12">&#39;</span><span class="c1">, </span><span class="c4">response</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">melody</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1 c3">&nbsp;[]</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">for</span><span class="c1">&nbsp;</span><span class="c4">note</span><span class="c1">, </span><span class="c4">duration</span><span class="c1">&nbsp;</span><span class="c5">in</span><span class="c1">&nbsp;</span><span class="c4">melody_matches</span><span class="c1 c3">:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">frequency</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">note_to_frequency</span><span class="c1">(</span><span class="c4">note</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;</span><span class="c4">frequency</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c2">-</span><span class="c13">1</span><span class="c1">: &nbsp;</span><span class="c10 c3"># Check if the note was found</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">melody</span><span class="c1">.</span><span class="c8">append</span><span class="c1">(</span><span class="c9">f</span><span class="c11">&quot;</span><span class="c9">{</span><span class="c4">frequency</span><span class="c9">}</span><span class="c11">,</span><span class="c9">{</span><span class="c4">duration</span><span class="c9">}</span><span class="c11">&quot;</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">return</span><span class="c1">&nbsp;</span><span class="c11">&#39;,&#39;</span><span class="c1">.</span><span class="c8">join</span><span class="c1">(</span><span class="c4">melody</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">def</span><span class="c1">&nbsp;</span><span class="c8">main</span><span class="c1 c3">():</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">#print(&quot;Connected to&quot;, ser.name)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">print</span><span class="c1">(</span><span class="c11">&quot;Press any key on keypad to generate a short melody from that key. 2 corresponds to A major, 3 corresponds to B major, ..., 8 corresponds to G major.&quot;</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">while</span><span class="c1">&nbsp;</span><span class="c9">True</span><span class="c1 c3">:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># Read data sent from the RP2040</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">incoming_data</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c4">ser</span><span class="c1">.</span><span class="c8">readline</span><span class="c1 c3">()</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;</span><span class="c4">incoming_data</span><span class="c1 c3">:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">note_key</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c4">incoming_data</span><span class="c1">.</span><span class="c8">decode</span><span class="c1">().</span><span class="c8">strip</span><span class="c1 c3">()</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">print</span><span class="c1">(</span><span class="c11">&quot;Received from RP2040:&quot;</span><span class="c1">, </span><span class="c4">note_key</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># Get a melody from ChatGPT based on the note key</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">raw_melody</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">chat_with_gpt_for_melody</span><span class="c1">(</span><span class="c4">note_key</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">melody</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">clean_melody_response</span><span class="c1">(</span><span class="c4">raw_melody</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">print</span><span class="c1">(</span><span class="c11">&quot;Melody from ChatGPT:&quot;</span><span class="c1">, </span><span class="c4">melody</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># Send the cleaned melody back to the RP2040</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">ser</span><span class="c1">.</span><span class="c8">write</span><span class="c1">(</span><span class="c4">melody</span><span class="c1">.</span><span class="c8">encode</span><span class="c1 c3">())</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">print</span><span class="c1">(</span><span class="c11">&quot;Sent to RP2040:&quot;</span><span class="c1">, </span><span class="c4">melody</span><span class="c1 c3">)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># Wait for a stop command</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># while True:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; if ser.in_waiting &gt; 0:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; &nbsp; &nbsp; stop_data = ser.readline().decode().strip()</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; &nbsp; &nbsp; if stop_data == &quot;s&quot;: &nbsp;# Assuming &quot;s&quot; is the stop command</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(&quot;Stop command received from RP2040&quot;)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &nbsp;# Break out of the main function</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3"># &nbsp; &nbsp; time.sleep(1)</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c15">time</span><span class="c1">.</span><span class="c8">sleep</span><span class="c1">(</span><span class="c13">1</span><span class="c1 c3">)</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c5">if</span><span class="c1">&nbsp;</span><span class="c4">__name__</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c11">&quot;__main__&quot;</span><span class="c1 c3">:</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">main</span><span class="c1 c3">()</span></p><h2 class="c16" id="h.fp2b7e3pnlje"><span class="c3 c25">C Script</span></h2><p class="c0"><span class="c10 c3">// Include necessary libraries</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&lt;stdio.h&gt;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&lt;math.h&gt;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c3 c11">&lt;string.h&gt;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;pico/stdlib.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;pico/multicore.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;hardware/pio.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;hardware/dma.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;hardware/spi.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;hardware/sync.h&quot;</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11 c3">&quot;hardware/pwm.h&quot;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// Include protothreads</span></p><p class="c0"><span class="c5">#include</span><span class="c9">&nbsp;</span><span class="c11">&quot;pt_cornell_rp2040_v1.h&quot;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;two32 </span><span class="c13 c3">4294967296.0</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;Fs </span><span class="c13 c3">40000</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;sine_table_size </span><span class="c13 c3">256</span></p><p class="c0"><span class="c15">fix15</span><span class="c1">&nbsp;</span><span class="c4">sin_table</span><span class="c1">[</span><span class="c9">sine_table_size</span><span class="c1 c3">];</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">volatile</span><span class="c1">&nbsp;</span><span class="c9">unsigned</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1 c3">&nbsp;;</span></p><p class="c0"><span class="c10 c3">//volatile unsigned int count_0 = 0 ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">char</span><span class="c1">&nbsp;</span><span class="c4">keytext</span><span class="c1">[</span><span class="c13">40</span><span class="c1 c3">];</span></p><p class="c0"><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1 c3">;</span></p><p class="c0"><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">frequencies</span><span class="c1">[</span><span class="c13">20</span><span class="c1 c3">];</span></p><p class="c0"><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">durations</span><span class="c1">[</span><span class="c13">20</span><span class="c1 c3">];</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// Keypad configuration</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;BASE_KEYPAD_PIN </span><span class="c13 c3">9</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;KEYROWS </span><span class="c13 c3">4</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;NUMKEYS </span><span class="c13 c3">12</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;LED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c13 c3">25</span></p><p class="c0"><span class="c9">unsigned</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">keycodes</span><span class="c1">[</span><span class="c13">12</span><span class="c1">] </span><span class="c2">=</span><span class="c1">&nbsp;{ </span><span class="c13">0x28</span><span class="c1">, </span><span class="c13">0x11</span><span class="c1">, </span><span class="c13">0x21</span><span class="c1">, </span><span class="c13">0x41</span><span class="c1">, </span><span class="c13">0x12</span><span class="c1">, </span><span class="c13">0x22</span><span class="c1">, </span><span class="c13">0x42</span><span class="c1">, </span><span class="c13">0x14</span><span class="c1">, </span><span class="c13">0x24</span><span class="c1">, </span><span class="c13">0x44</span><span class="c1">, </span><span class="c13">0x18</span><span class="c1">, </span><span class="c13">0x48</span><span class="c1 c3">&nbsp;};</span></p><p class="c0"><span class="c9">unsigned</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">scancodes</span><span class="c1">[</span><span class="c13">4</span><span class="c1">] </span><span class="c2">=</span><span class="c1">&nbsp;{ </span><span class="c13">0x01</span><span class="c1">, </span><span class="c13">0x02</span><span class="c1">, </span><span class="c13">0x04</span><span class="c1">, </span><span class="c13">0x08</span><span class="c1 c3">&nbsp;};</span></p><p class="c0"><span class="c9">unsigned</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">button</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0x70</span><span class="c1 c3">&nbsp;;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PIN_MISO </span><span class="c13 c3">4</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PIN_CS </span><span class="c13 c3">5</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PIN_SCK </span><span class="c13 c3">6</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PIN_MOSI </span><span class="c13 c3">7</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;LDAC &nbsp; &nbsp; </span><span class="c13 c3">8</span></p><p class="c0"><span class="c5">#define</span><span class="c9 c3">&nbsp;SPI_PORT spi0</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;GPIO &nbsp; &nbsp; </span><span class="c13 c3">16</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PWM_1 </span><span class="c13 c3">18</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;PWM_2 </span><span class="c13 c3">19</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// PWM Parameters</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;WRAPVAL </span><span class="c13 c3">5000</span></p><p class="c0"><span class="c9">volatile</span><span class="c1">&nbsp;</span><span class="c9">float</span><span class="c1">&nbsp;</span><span class="c4">CLKDIV</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">256.0</span><span class="c1 c3">;</span></p><p class="c0"><span class="c9">uint</span><span class="c1">&nbsp;</span><span class="c4">slice_num</span><span class="c1 c3">&nbsp;;</span></p><p class="c0"><span class="c9">volatile</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">frequency</span><span class="c1 c3">;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;DAC_config_chan_A </span><span class="c13 c3">0b0011000000000000</span></p><p class="c0"><span class="c5">#define</span><span class="c9">&nbsp;DAC_config_chan_B </span><span class="c13 c3">0b1011000000000000</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// This thread runs on core 0</span></p><p class="c0"><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c8">PT_THREAD</span><span class="c1">&nbsp;(</span><span class="c8">protothread_core_0</span><span class="c1">(</span><span class="c9">struct</span><span class="c1">&nbsp;</span><span class="c15">pt</span><span class="c1">&nbsp;</span><span class="c2">*</span><span class="c4">pt</span><span class="c1 c3">))</span></p><p class="c0"><span class="c1 c3">{</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Indicate thread beginning</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">PT_BEGIN</span><span class="c1 c3">(pt) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1 c3">&nbsp;;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">uint32_t</span><span class="c1">&nbsp;</span><span class="c4">keypad</span><span class="c1 c3">&nbsp;;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">while</span><span class="c1">(</span><span class="c13">1</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">gpio_put</span><span class="c1">(</span><span class="c9">LED</span><span class="c1">, </span><span class="c2">!</span><span class="c8">gpio_get</span><span class="c1">(</span><span class="c9">LED</span><span class="c1 c3">)) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Scan the keypad!</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">for</span><span class="c1">&nbsp;(</span><span class="c4">i</span><span class="c2">=</span><span class="c13">0</span><span class="c1">; </span><span class="c4">i</span><span class="c2">&lt;</span><span class="c9">KEYROWS</span><span class="c1">; </span><span class="c4">i</span><span class="c2">++</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Set a row high</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">gpio_put_masked</span><span class="c1">((</span><span class="c13">0xF</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1 c3">),</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</span><span class="c4">scancodes</span><span class="c1">[</span><span class="c4">i</span><span class="c1">] </span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Small delay required</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">sleep_us</span><span class="c1">(</span><span class="c13">1</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Read the keycode</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">keypad</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;((</span><span class="c8">gpio_get_all</span><span class="c1">() </span><span class="c2">&gt;&gt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1">) </span><span class="c2">&amp;</span><span class="c1">&nbsp;</span><span class="c13">0x7F</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Break if button(s) are pressed</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">keypad</span><span class="c1">&nbsp;</span><span class="c2">&amp;</span><span class="c1">&nbsp;</span><span class="c4">button</span><span class="c1">) </span><span class="c5">break</span><span class="c1 c3">&nbsp;;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// If we found a button . . .</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">keypad</span><span class="c1">&nbsp;</span><span class="c2">&amp;</span><span class="c1">&nbsp;</span><span class="c4">button</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Look for a valid keycode.</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">for</span><span class="c1">&nbsp;(</span><span class="c4">i</span><span class="c2">=</span><span class="c13">0</span><span class="c1">; </span><span class="c4">i</span><span class="c2">&lt;</span><span class="c9">NUMKEYS</span><span class="c1">; </span><span class="c4">i</span><span class="c2">++</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">keypad</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c4">keycodes</span><span class="c1">[</span><span class="c4">i</span><span class="c1">]) </span><span class="c5">break</span><span class="c1 c3">&nbsp;;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// If we don&#39;t find one, report invalid keycode</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">i</span><span class="c2">==</span><span class="c9">NUMKEYS</span><span class="c1">) (</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c2">-</span><span class="c13">1</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Otherwise, indicate invalid/non-pressed buttons</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;(</span><span class="c4">i</span><span class="c2">=-</span><span class="c13">1</span><span class="c1 c3">) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Logic to determine what sounds to play</span></p><p class="c0"><span class="c10 c3">&nbsp; &nbsp; &nbsp; &nbsp; /* Only interested in key transitions where the</span></p><p class="c0"><span class="c10 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; current key does not equal previous key */</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// key 1 -&gt; A major key</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;A major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">2</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">2</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;B major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">3</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">3</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;C major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">4</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">4</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;D major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">5</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">5</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;E major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">6</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">6</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;F major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">else</span><span class="c1">&nbsp;</span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c13">7</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">7</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">uart_puts</span><span class="c1">(uart0, </span><span class="c11">&quot;G major</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">prev_key</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">PT_YIELD_usec</span><span class="c1">(</span><span class="c13">30000</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; }</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">PT_END</span><span class="c1 c3">(pt) ;</span></p><p class="c0"><span class="c1 c3">}</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c8">pt_state_0_thread</span><span class="c1">(</span><span class="c9">struct</span><span class="c1">&nbsp;</span><span class="c15">pt</span><span class="c1">&nbsp;</span><span class="c2">*</span><span class="c4">pt</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">PT_BEGIN</span><span class="c1">(</span><span class="c4">pt</span><span class="c1 c3">);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">note_count</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">bool</span><span class="c1">&nbsp;</span><span class="c4">is_frequency</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">static</span><span class="c1">&nbsp;</span><span class="c9">char</span><span class="c1">&nbsp;</span><span class="c2">*</span><span class="c4">token</span><span class="c1 c3">;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">while</span><span class="c1">&nbsp;(</span><span class="c13">1</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Reset variables for each iteration</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">note_count</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">is_frequency</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c9">true</span><span class="c1 c3">;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Wait for serial data to be read</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; serial_read;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">//PT_YIELD(pt); // Yield to allow time for data to be read</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Check if STATE_0 is 1 and if data is received</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">pt_serial_in_buffer</span><span class="c1">[</span><span class="c13">0</span><span class="c1">] </span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c11">&#39;</span><span class="c18">\0</span><span class="c11">&#39;</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">STATE_0</span><span class="c1">&nbsp;</span><span class="c2">==</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">printf</span><span class="c1">(</span><span class="c11">&quot;Received serial data: </span><span class="c4">%s</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">, pt_serial_in_buffer);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Parse the received string</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">token</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">strtok</span><span class="c1">(pt_serial_in_buffer, </span><span class="c11">&quot;,</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">while</span><span class="c1">&nbsp;(</span><span class="c4">token</span><span class="c1">&nbsp;</span><span class="c2">!=</span><span class="c1">&nbsp;</span><span class="c9">NULL</span><span class="c1">&nbsp;</span><span class="c2">&amp;&amp;</span><span class="c1">&nbsp;</span><span class="c4">note_count</span><span class="c1">&nbsp;</span><span class="c2">&lt;</span><span class="c1">&nbsp;</span><span class="c13">20</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">current_number</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">atoi</span><span class="c1">(</span><span class="c4">token</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">//printf(&quot;Parsed number: %d\n&quot;, current_number);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">if</span><span class="c1">&nbsp;(</span><span class="c4">is_frequency</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">frequencies</span><span class="c1">[</span><span class="c4">note_count</span><span class="c1">] </span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c4">current_number</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">//printf(&quot;Stored frequency[%d]: %d\n&quot;, note_count, frequencies[note_count]);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">is_frequency</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c9">false</span><span class="c1">;</span><span class="c10 c3">&nbsp; // Next number will be duration</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } </span><span class="c5">else</span><span class="c1 c3">&nbsp;{</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">durations</span><span class="c1">[</span><span class="c4">note_count</span><span class="c1">] </span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c4">current_number</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">//printf(&quot;Stored duration[%d]: %d\n&quot;, note_count, durations[note_count]);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">note_count</span><span class="c2">++</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">is_frequency</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c9">true</span><span class="c1">;</span><span class="c10 c3">&nbsp; // Next number will be frequency</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">token</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">strtok</span><span class="c1">(</span><span class="c9">NULL</span><span class="c1">, </span><span class="c11">&quot;,</span><span class="c18">\n</span><span class="c11">&quot;</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Play the melody</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c5">for</span><span class="c1">&nbsp;(</span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1">; </span><span class="c4">i</span><span class="c1">&nbsp;</span><span class="c2">&lt;</span><span class="c1">&nbsp;</span><span class="c4">note_count</span><span class="c1">; </span><span class="c2">++</span><span class="c4">i</span><span class="c1 c3">) {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_wrap</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">WRAPVAL</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">CLKDIV</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">125000000</span><span class="c1">&nbsp;</span><span class="c2">/</span><span class="c1">&nbsp;(</span><span class="c4">frequencies</span><span class="c1">[</span><span class="c4">i</span><span class="c1">] </span><span class="c2">*</span><span class="c1">&nbsp;(</span><span class="c9">WRAPVAL</span><span class="c1">&nbsp;</span><span class="c2">+</span><span class="c1">&nbsp;</span><span class="c13">1</span><span class="c1 c3">));</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_clkdiv</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c4">CLKDIV</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_chan_level</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">PWM_2</span><span class="c1">, </span><span class="c13">2500</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_mask_enabled</span><span class="c1">((</span><span class="c13">1u</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c4">slice_num</span><span class="c1 c3">));</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">sleep_ms</span><span class="c1">(</span><span class="c4">durations</span><span class="c1">[</span><span class="c4">i</span><span class="c1 c3">]);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_wrap</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">WRAPVAL</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c4">CLKDIV</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">256.0</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_clkdiv</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c4">CLKDIV</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">pwm_set_chan_level</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">PWM_2</span><span class="c1">, </span><span class="c13">0</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Optional: delay between notes</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">sleep_ms</span><span class="c1">(</span><span class="c13">100</span><span class="c1">);</span><span class="c10 c3">&nbsp; // 100 ms delay between notes</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c10 c3">// Yield to allow other protothreads to run</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="c8">PT_YIELD</span><span class="c1">(</span><span class="c4">pt</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">PT_END</span><span class="c1">(</span><span class="c4">pt</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1 c3">}</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// This timer ISR is called on core 0</span></p><p class="c0"><span class="c10 c3">// bool repeating_timer_callback_core_0(struct repeating_timer *t) {</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; &nbsp; &nbsp;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; if (STATE_0 == 2) {</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; unsigned int phase_accumulator = 0;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; unsigned int phase_increment;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; int num_samples;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; int DAC_output;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; uint16_t DAC_data;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; // static int test;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; // test = 1000000;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; // uart_puts(uart0, test);</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; // printf(&quot;Received frequency 2: %d\n&quot;, test);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; // Loop through each note</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; for (int note = 0; note &lt; 3; note++) {</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; phase_increment = (frequencies[note] * two32) / Fs;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_samples = (Fs / 1000) * durations[note];</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(&quot;Frequency in ISR: %d&quot;, frequencies[0]);</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (int i = 0; i &lt; num_samples; i++) {</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; phase_accumulator += phase_increment;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DAC_output = fix2int15(multfix15(sin_table[phase_accumulator &gt;&gt; 24], int2fix15(1))) + 2048;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DAC_data = (DAC_config_chan_A | (DAC_output &amp; 0xffff));</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; spi_write16_blocking(SPI_PORT, &amp;DAC_data, 1);</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sleep_us(1000000 / Fs);</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Reset the phase accumulator for the next note</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; phase_accumulator = 0;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; &nbsp; &nbsp; STATE_0 == 0;</span></p><p class="c0"><span class="c10 c3">// &nbsp; &nbsp; }</span></p><p class="c0"><span class="c10 c3">// }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">// Core 0 entry point</span></p><p class="c0"><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c8">main</span><span class="c1 c3">() {</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Initialize stdio/uart (printf won&#39;t work unless you do this!)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">stdio_init_all</span><span class="c1 c3">();</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Initialize SPI channel (channel, baud rate set to 20MHz)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">spi_init</span><span class="c1">(</span><span class="c9">SPI_PORT</span><span class="c1">, </span><span class="c13">20000000</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Format (channel, data bits per transfer, polarity, phase, order)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">spi_set_format</span><span class="c1">(</span><span class="c9">SPI_PORT</span><span class="c1">, </span><span class="c13">16</span><span class="c1">, </span><span class="c13">0</span><span class="c1">, </span><span class="c13">0</span><span class="c1">, </span><span class="c13">0</span><span class="c1 c3">);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Map SPI signals to GPIO ports</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PIN_MISO</span><span class="c1 c3">, GPIO_FUNC_SPI);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PIN_SCK</span><span class="c1 c3">, GPIO_FUNC_SPI);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PIN_MOSI</span><span class="c1 c3">, GPIO_FUNC_SPI);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PIN_CS</span><span class="c1 c3">, GPIO_FUNC_SPI) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PWM_2</span><span class="c1 c3">, GPIO_FUNC_PWM);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_function</span><span class="c1">(</span><span class="c9">PWM_1</span><span class="c1 c3">, GPIO_FUNC_PWM);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c4">slice_num</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c8">pwm_gpio_to_slice_num</span><span class="c1">(</span><span class="c9">PWM_2</span><span class="c1 c3">);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pwm_set_wrap</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">WRAPVAL</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pwm_set_clkdiv</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c4">CLKDIV</span><span class="c1 c3">);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pwm_set_chan_level</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">PWM_2</span><span class="c1">, </span><span class="c13">2500</span><span class="c1 c3">);</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pwm_set_chan_level</span><span class="c1">(</span><span class="c4">slice_num</span><span class="c1">, </span><span class="c9">PWM_1</span><span class="c1">, </span><span class="c13">2500</span><span class="c1 c3">);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pwm_set_mask_enabled</span><span class="c1">((</span><span class="c13">1u</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c4">slice_num</span><span class="c1 c3">));</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Map LDAC pin to GPIO port, hold it low (could alternatively tie to GND)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_init</span><span class="c1">(</span><span class="c9">LDAC</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_dir</span><span class="c1">(</span><span class="c9">LDAC</span><span class="c1 c3">, GPIO_OUT) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_put</span><span class="c1">(</span><span class="c9">LDAC</span><span class="c1">, </span><span class="c13">0</span><span class="c1 c3">) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Map LED to GPIO port, make it low</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_init</span><span class="c1">(</span><span class="c9">LED</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_dir</span><span class="c1">(</span><span class="c9">LED</span><span class="c1 c3">, GPIO_OUT) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_put</span><span class="c1">(</span><span class="c9">LED</span><span class="c1">, </span><span class="c13">0</span><span class="c1 c3">) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_init</span><span class="c1">(</span><span class="c9">GPIO</span><span class="c1 c3">) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_dir</span><span class="c1">(</span><span class="c9">GPIO</span><span class="c1 c3">, GPIO_OUT) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_put</span><span class="c1">(</span><span class="c9">GPIO</span><span class="c1">, </span><span class="c13">0</span><span class="c1 c3">) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c10 c3">&nbsp; &nbsp; ////////////////// KEYPAD INITS ///////////////////////</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Initialize the keypad GPIO&#39;s</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_init_mask</span><span class="c1">((</span><span class="c13">0x7F</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Set row-pins to output</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_set_dir_out_masked</span><span class="c1">((</span><span class="c13">0xF</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Set all output pins to low</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_put_masked</span><span class="c1">((</span><span class="c13">0xF</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1">), (</span><span class="c13">0x0</span><span class="c1">&nbsp;</span><span class="c2">&lt;&lt;</span><span class="c1">&nbsp;</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Turn on pulldown resistors for column pins (on by default)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_pull_down</span><span class="c1">((</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1">&nbsp;</span><span class="c2">+</span><span class="c1">&nbsp;</span><span class="c13">4</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_pull_down</span><span class="c1">((</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1">&nbsp;</span><span class="c2">+</span><span class="c1">&nbsp;</span><span class="c13">5</span><span class="c1 c3">)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">gpio_pull_down</span><span class="c1">((</span><span class="c9">BASE_KEYPAD_PIN</span><span class="c1">&nbsp;</span><span class="c2">+</span><span class="c1">&nbsp;</span><span class="c13">6</span><span class="c1 c3">)) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// set up increments for calculating bow envelope</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// attack_inc = divfix(max_amplitude, int2fix15(ATTACK_TIME)) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// decay_inc = &nbsp;divfix(max_amplitude, int2fix15(DECAY_TIME)) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Build the sine lookup table</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// scaled to produce values between 0 and 4096 (for 12-bit DAC)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c9">int</span><span class="c1">&nbsp;</span><span class="c4">ii</span><span class="c1 c3">;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c5">for</span><span class="c1">&nbsp;(</span><span class="c4">ii</span><span class="c1">&nbsp;</span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c13">0</span><span class="c1">; </span><span class="c4">ii</span><span class="c1">&nbsp;</span><span class="c2">&lt;</span><span class="c1">&nbsp;</span><span class="c9">sine_table_size</span><span class="c1">; </span><span class="c4">ii</span><span class="c2">++</span><span class="c1 c3">){</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c4">sin_table</span><span class="c1">[</span><span class="c4">ii</span><span class="c1">] </span><span class="c2">=</span><span class="c1">&nbsp;</span><span class="c9">float2fix15</span><span class="c1">(</span><span class="c13">2047</span><span class="c2">*</span><span class="c8">sin</span><span class="c1">((</span><span class="c9">float</span><span class="c1">)</span><span class="c4">ii</span><span class="c2">*</span><span class="c13">6.283</span><span class="c2">/</span><span class="c1">(</span><span class="c9">float</span><span class="c1">)</span><span class="c9">sine_table_size</span><span class="c1 c3">));</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; }</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c3 c10">// Create a repeating timer that calls</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// repeating_timer_callback (defaults core 0)</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">//struct repeating_timer timer_core_0;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Negative delay so means we will call repeating_timer_callback, and call it</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// again 25us (40kHz) later regardless of how long the callback took to execute</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">//add_repeating_timer_us(-25, repeating_timer_callback_core_0, NULL, &amp;timer_core_0);</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Add core 0 threads</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pt_add_thread</span><span class="c1 c3">(protothread_core_0) ;</span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c8">pt_add_thread</span><span class="c1">(</span><span class="c8">pt_state_0_thread</span><span class="c1 c3">) ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1">&nbsp; &nbsp; </span><span class="c10 c3">// Start scheduling core 0 threads</span></p><p class="c0"><span class="c1 c3">&nbsp; &nbsp; pt_schedule_start ;</span></p><p class="c0 c7"><span class="c1 c3"></span></p><p class="c0"><span class="c1 c3">}</span></p><p class="c17 c7"><span class="c20 c3"></span></p><div class="c34"><p class="c19"><a href="#cmnt_ref1" id="cmnt1">[a]</a><span class="c20 c3">Summary of what we did and why</span></p></div></body></html>